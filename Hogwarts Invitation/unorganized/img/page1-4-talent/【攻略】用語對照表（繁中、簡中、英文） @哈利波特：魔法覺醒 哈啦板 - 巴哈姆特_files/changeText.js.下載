var Util=Util||{};(function(Util){"use strict";var ChangeText=function(id,flag){var elem=document.getElementById(id);if(!elem){return}var str=elem.innerHTML;var attrSrc="src";var attrClass="";var attrStyle="";var lineBreak="";var eventStop="";var attrStyleVal="";var attrClassVal="";if(flag&ChangeText.FLAG_LAZYLOAD){attrClassVal="lazyload";attrSrc="data-src";attrClass='class="'+attrClassVal+'" '}if(flag&ChangeText.FLAG_MAX_SIZE){attrStyleVal="max-width:120px;max-height:120px;";attrStyle='style="'+attrStyleVal+'" '}if(flag&ChangeText.FLAG_LINE_BREAK){lineBreak="<br>"}if(flag&ChangeText.FLAG_STOP_EVENT){eventStop="event.stopPropagation();"}str=str.replace(/(<[^>]*)h(ttp[s]{0,1}:\/\/[^>]*>)/gi,"$1b$2");if(flag&ChangeText.FLAG_BALA_PLAYER){str=str.replace(/&amp;start/g,"&start");str=str.replace(/&amp;list/g,"&list");str=str.replace(/https?:\/\/www\.youtube\.com\/watch\?v=([0-9a-zA-Z_-]{11})(&start=[\d]+)?/gi,'<p style=" display:block; width:138px; height:77px; position:relative; background:url(bttps://i1.ytimg.com/vi/$1/default.jpg) no-repeat center center;" onclick="'+eventStop+"$(this).html('<iframe width=450 height=253 src=bttps://www.youtube.com/embed/$1?autoplay=1&$2 frameborder=0 allowfullscreen></iframe>');$(this).css('width','450px');$(this).css('height','253px');\"><img src=\"bttps://i2.bahamut.com.tw/icon_videoplayer.svg\" style=\"cursor: pointer; position: absolute; top:50%; left: 50%; width: 30%; max-height: 50%; transform: translate(-50%, -50%);\"></p>");str=str.replace(/https?:\/\/youtu\.be\/([0-9a-zA-Z_-]{11})(?:\?(start=[\d]+))?/gi,'<p style=" display:block; width:138px; height:77px; position: relative; background:url(bttps://i1.ytimg.com/vi/$1/default.jpg) no-repeat center center;" onclick="'+eventStop+"$(this).html('<iframe width=450 height=253 src=bttps://www.youtube.com/embed/$1?autoplay=1&$2 frameborder=0 allowfullscreen></iframe>');$(this).css('width','450px');$(this).css('height','253px');\"><img src=\"bttps://i2.bahamut.com.tw/icon_videoplayer.svg\" style=\"cursor: pointer; position: absolute; top:50%; left: 50%; width: 30%; max-height: 50%; transform: translate(-50%, -50%);\"></p>");str=str.replace(/h(ttps?:\/\/www\.facebook\.com\/(\w+)\/videos\/(\d+)\/)/gi,'<p style=" display:block; width:138px; height:77px; position: relative; background:url(bttps://graph.facebook.com/$3/picture) no-repeat center center;" onclick="'+eventStop+"$(this).html('<iframe src=bttps://www.facebook.com/plugins/video.php?autoplay=true&href=b$1&width=450&show_text=false&height=253&appId width=450 height=253 style=border:none;overflow:hidden scrolling=no frameborder=0 allowTransparency=true allow=encrypted-media allowFullScreen=true></iframe>');$(this).css('width','450px');$(this).css('height','253px');\"><img src=\"bttps://i2.bahamut.com.tw/icon_videoplayer.svg\" style=\"cursor: pointer; position: absolute; top:50%; left: 50%; width: 30%; max-height: 50%; transform: translate(-50%, -50%);\"></p>");str=str.replace(/https?:\/\/(?:www|tw)\.nicovideo\.jp\/watch\/((?:sm|nm|ca|cd|ax|yo|nl|ig|na|cw|za|zb|zc|zd|ze|om|sk|yk|so|am|fz)[0-9]{1,14}|[0-9]{10})/g,function(match,m1){return'<p style=" display:block; width:138px; height:77px; position: relative; background:url(bttp://tn-skr3.smilevideo.jp/smile?i='+m1.replace(/sm|nm|ca|cd|ax|yo|nl|ig|na|cw|za|zb|zc|zd|ze|om|sk|yk|so|am|fz/,"")+') no-repeat center center;" onclick="'+eventStop+"$(this).html('<iframe width=450 height=253 src=bttps://embed.nicovideo.jp/watch/"+m1+" frameborder=0 allowfullscreen></iframe>');$(this).css('width','450px');$(this).css('height','253px');\"><img src=\"bttps://i2.bahamut.com.tw/icon_videoplayer.svg\" style=\"width: 30px; cursor: pointer; position: absolute; top:50%; left: 50%; width: 30%; max-height: 50%; transform: translate(-50%, -50%);\"></p>"})}else{str=str.replace(/https?:\/\/www\.youtube\.com\/watch\?v=([0-9a-zA-Z_-]{11})/gi,lineBreak+"<iframe "+attrClass+attrSrc+'="bttps://www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe>');str=str.replace(/https?:\/\/youtu\.be\/([0-9a-zA-Z_-]{11})/gi,lineBreak+"<iframe "+attrClass+attrSrc+'="bttps://www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe>');str=str.replace(/h(ttps?:\/\/www\.facebook\.com\/\w+\/videos\/\d+\/)/gi,lineBreak+"<iframe "+attrClass+attrSrc+'="b$1  frameborder=0 allowfullscreen></iframe>');str=str.replace(/https?:\/\/(?:www|tw)\.nicovideo\.jp\/watch\/((?:sm|nm|ca|cd|ax|yo|nl|ig|na|cw|za|zb|zc|zd|ze|om|sk|yk|so|am|fz)[0-9]{1,14}|[0-9]{10})/g,function(match,m1){return lineBreak+'<a href="'+encodeURI(match).replace("http","bttp")+'"  onclick="'+eventStop+'Util.ChangeText.refurl(this);" target="_blank" style="display: inline-block; position: relative;"><img src="bttps://i2.bahamut.com.tw/icon_videoplayer.svg" style="position: absolute; top: 50%; left: 50%; width: 24%; max-height: 50%; transform: translate(-50%, -50%);"><div style="background: #000000 url(bttp://tn-skr3.smilevideo.jp/smile?i='+m1.replace(/sm|nm|ca|cd|ax|yo|nl|ig|na|cw|za|zb|zc|zd|ze|om|sk|yk|so|am|fz/,"")+') center center no-repeat; background-size: contain; width: 425px; height: 250px;"></div></a>'})}str=str.replace(/h(ttps?:\/\/[!#-&(-;=?-Z\^-~]+)/gi,function(match){let url=null;try{url=new URL(match.replace(/&(?:lt|gt|quot|#039|amp);/g,function(specialCharMatch){let mapping={"&lt;":"<","&gt;":">","&quot;":'"',"&#039":"'","&amp;":"&"};return mapping[specialCharMatch]}))}catch(e){return match}var a=document.createElement("a");a.setAttribute("href","b"+url.href.slice(1));a.setAttribute("target","_blank");a.setAttribute("onclick",`${eventStop} Util.ChangeText.refurl(this);`);if(url.pathname.match(/\.(?:jpe?g|png|gif)$/i)){var img=document.createElement("img");img.setAttribute(attrSrc,"b"+url.href.slice(1));if(attrStyleVal!=""){img.setAttribute("style",attrStyleVal)}if(attrClassVal!=""){img.setAttribute("class",attrClassVal)}a.appendChild(img);if(url.hostname.match(/\.bahamut\.com\.tw$/)){url.searchParams.delete("w");url.searchParams.delete("h");url.searchParams.delete("fit");a.setAttribute("href","b"+url.href.slice(1))}if(jQuery(".pswp").length>0){a.setAttribute("href","javascript:;");a.setAttribute("target","");a.setAttribute("onclick",`${eventStop} Util.ChangeText.openPswp(this);`)}}else{a.innerHTML=url}return`${lineBreak}`+a.outerHTML});str=str.replace(/\[e(\d*)\]/gi,"<img "+attrClass+attrSrc+'="https://i2.bahamut.com.tw/editor/emotion/$1.gif">');if("undefined"!=typeof gsn){str=str.replace(/\[G(1[a-z0-9]{3})\]/gi,"<img "+attrClass+attrSrc+'="https://p2.bahamut.com.tw/B/GUILD/e/'+gsn%10+"/"+gsn+'_$1.GIF">');str=str.replace(/\[G(2[a-z0-9]{3})\]/gi,"<img "+attrClass+attrSrc+'="https://p2.bahamut.com.tw/B/GUILD/e/'+gsn%10+"/"+gsn+'_$1.JPG">');str=str.replace(/\[G(3[a-z0-9]{3})\]/gi,"<img "+attrClass+attrSrc+'="https://p2.bahamut.com.tw/B/GUILD/e/'+gsn%10+"/"+gsn+'_$1.PNG">')}str=str.replace(/\[G([0-9]{1}\/\d*_1[a-z0-9]{3})\]/gi,"<img "+attrClass+attrSrc+'="https://p2.bahamut.com.tw/B/GUILD/e/$1.GIF">');str=str.replace(/\[G([0-9]{1}\/\d*_2[a-z0-9]{3})\]/gi,"<img "+attrClass+attrSrc+'="https://p2.bahamut.com.tw/B/GUILD/e/$1.JPG">');str=str.replace(/\[G([0-9]{1}\/\d*_3[a-z0-9]{3})\]/gi,"<img "+attrClass+attrSrc+'="https://p2.bahamut.com.tw/B/GUILD/e/$1.PNG">');str=str.replace(/a>：\[([0-9a-zA-Z]*):([^\]]*)\]/gi,'a> &gt; <a class="msgname AT1" href="http://home.gamer.com.tw/bahawall.php?owner=$1" target="_blank">$2</a>');str=str.replace(/：\[([0-9a-zA-Z]*):([^\]]*)\]/gi,'、<a class="msgname AT1" href="http://home.gamer.com.tw/bahawall.php?owner=$1" target="_blank">$2</a>');str=str.replace(/\[([0-9a-zA-Z]*):([^\]]*)\]/gi,'<a class="msgname AT1" href="http://home.gamer.com.tw/bahawall.php?owner=$1" target="_blank">$2</a>');str=str.replace(/b(ttp[s]{0,1}:\/\/)/gi,"h$1");elem.innerHTML=str;if(window.GamerCard){window.GamerCard.bind("#"+id)}};ChangeText.refurl=function(me){if(!me.href.match(/^https?:\/\/ref\.gamer\.com\.tw/)){me.href="https://ref.gamer.com.tw/redir.php?url="+encodeURIComponent(me.href)}};ChangeText.openPswp=function(o){let obj=jQuery(o);let pswpOptions={captionEl:false,bgOpacity:.85,showHideOpacity:true,history:false,errorMsg:'<div class="pswp__error-msg"><a href="%url%" target="_blank">圖片</a>無法載入</div>',shareEl:false,index:0};let PSWP=new PhotoSwipe($(".pswp").get(0),PhotoSwipeUI_Default,[{src:obj.find("img").data("src"),w:0,h:0}],pswpOptions);PSWP.listen("gettingData",function(k,v){if(v.onLoading===undefined&&(v.w<1||v.h<1)){v.onLoading=true;let img=new Image;img.onload=function(){v.w=this.width;v.h=this.height;PSWP.invalidateCurrItems();PSWP.updateSize(true)};img.src=v.src}});PSWP.init()};ChangeText.FLAG_LAZYLOAD=1;ChangeText.FLAG_MAX_SIZE=2;ChangeText.FLAG_LINE_BREAK=4;ChangeText.FLAG_BALA_PLAYER=8;ChangeText.FLAG_STOP_EVENT=16;ChangeText.FLAG_BALA=ChangeText.FLAG_LAZYLOAD|ChangeText.FLAG_MAX_SIZE|ChangeText.FLAG_LINE_BREAK|ChangeText.FLAG_BALA_PLAYER;Util.ChangeText=ChangeText})(Util);