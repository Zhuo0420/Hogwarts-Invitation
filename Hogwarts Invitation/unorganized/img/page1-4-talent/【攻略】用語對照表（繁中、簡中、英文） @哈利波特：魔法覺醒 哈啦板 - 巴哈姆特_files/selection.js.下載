bahaRte.selection={getSelection:function(){return bahaRte.win.getSelection()},getRange:function(e){var t=bahaRte.selection.getSelection();return t&&t.rangeCount?(e=e||0,t.getRangeAt(e)):null},collapse:function(e){var t=bahaRte.win.getSelection();e?t.collapseToStart():t.collapseToEnd()},getSelectedCells:function(){function e(e,t){var a=t.ownerDocument.createRange();try{a.selectNode(t)}catch(n){a.selectNodeContents(t)}return-1==e.compareBoundaryPoints(Range.END_TO_START,a)&&1==e.compareBoundaryPoints(Range.START_TO_END,a)}for(var t=[],a=bahaRte.selection.getSelectedNode();!a.nodeName.inArray(["table","body"],!0);)a=a.parentNode;if(a.nodeName.equals("body"))return null;var n,r,o,l,s,c=bahaRte.selection.getSelection();for(l=0;l<c.rangeCount;l++)for(range=bahaRte.selection.getRange(l),i=0;i<a.rows.length;i++)for(r=a.rows[i],o=0;o<r.childNodes.length;o++)n=r.childNodes[o],s=range.intersectsNode?range.intersectsNode(n):e(range,n),s&&n.nodeName.inArray(["td","th"],!0)&&(t[t.length]=n);return t},getSelectedTableInfo:function(){var e=bahaRte.selection.getSelectedCells();if(!e)return null;e=e[0];for(var t=e;!t.nodeName.inArray(["table","body"],!0);)t=t.parentNode;if(t.nodeName.equals("body"))return null;var a,n,r,o,i,l,s,c=e.parentNode.rowIndex,g=-1,d=$("tr",t).get(),u=[],h=0,b=0;if(h=d.length,h>0)for(var R=0;R<d[0].cells.length;R++)s=d[0].cells[R],b+=s.colSpan||1;for(var f=0;h>f;f++){n=d[f].cells;for(var v=0;v<n.length;v++){s=n[v];var N=v;if(u[f])for(;u[f][N];)N++;for(r=parseInt(s.getAttribute("rowSpan"),10)||1,o=parseInt(s.getAttribute("colSpan"),10)||1,l=f;f+r>l;l++)for(u[l]||(u[l]=[]),i=N;N+o>i;i++)u[l][i]={rowSpan:r,colSpan:o,cell:s,available:i==N&&l==f},u[l][i].available&&s===e&&(g=v,a=i)}}return-1==g?null:{table:t,rows:h,cols:b,selectedCell:e,selectedColIndex:g,selectedRowIndex:c,selectedX:a,cells:u}},getSelectedImageInfo:function(){if(bahaRte.isPlainText)return{isImage:!1};var e=bahaRte.selection.getRange(),t=e.startContainer;if(!t.tagName)return{isImage:!1};var a=t.childNodes[e.startOffset];if(!a||!a.nodeName.equals("img"))return{isImage:!1};var n=a.getAttribute("width")||"0",r=a.getAttribute("height")||"0",o=a.getAttribute("style");if(o)for(var i=o.split(";"),l=0;l<i.length;l++)if(""!==i[l].trim()){var s=i[l].split(":"),c=s[0].trim().toLowerCase(),g=s[1].trim();"width"==c&&(n=bahaRte.utility.switchSize(g,!0)),"height"==c&&(r=bahaRte.utility.switchSize(g,!0))}var d=a.getAttribute("src")||"",u=a.getAttribute("data-movie")||"",h=0===d.indexOf(bahaRte.constants.emotionUrl);return{isImage:!0,url:d,width:n,height:r,movie:u,emotion:h}},getSelectedAnchorInfo:function(){var e=!1,t="",a="";if(a=bahaRte.selection.getSelectedText(),bahaRte.isPlainText)return{isLink:e,url:t,text:a,isWiki:!1,isAcg:!1};for(var n=bahaRte.selection.getSelectedNode();n&&!n.tagName.equals("html")&&!e;)n.tagName.equals("a")&&null!==n.getAttribute("href")?e=!0:n=n.parentNode;e&&(bahaRte.selection.selectNode(n),t=decodeURI(n.getAttribute("href")),a=bahaRte.selection.getSelectedText());var r=e&&(t.match(bahaRte.constants.serviceUrl.wikiUrlPattern)||t.match(bahaRte.constants.serviceUrl.guildWikiUrlPattern)),o=e&&t.match(bahaRte.constants.serviceUrl.acgPattern),i={isLink:e,url:t,text:a,isWiki:r,isAcg:o};return i},getSelectedText:function(){if(bahaRte.isPlainText){var e=bahaRte.source.selectionStart,t=bahaRte.source.selectionEnd;return bahaRte.source.value.substring(e,t)}var a=bahaRte.selection.getRange(0);return a.toString()},getCursorLine:function(e,t){var a=bahaRte.source.value,n=bahaRte.source.selectionStart,r=bahaRte.source.selectionEnd,o=r;return n=a.substring(0,n).lastIndexOf("\n"),0>n?n=0:n++,r=a.substring(r,a.length).indexOf("\n"),0>r?r=a.length:r+=o,e&&(bahaRte.source.selectionStart=n,bahaRte.source.selectionEnd=r),a=a.substring(n,r),t?a.split("\n"):a},getSelectedNode:function(){var e=bahaRte.selection.getSelection(),t=e.focusNode;return t.nodeType==bahaRte.constants.nodeType.TEXT_NODE&&(t=t.parentNode),t},insertAnchorNode:function(e){var t,a=bahaRte.selection.getRange();$.browser.webkit?(t=bahaRte.doc.createElement("a"),t.innerHTML=e,t.href="javascript:void(0);"):t=bahaRte.doc.createTextNode(e),a.insertNode(t),$.browser.webkit?bahaRte.selection.getSelection().selectAllChildren(t):bahaRte.selection.selectNode(t)},selectNode:function(e){var t,a=bahaRte.win.getSelection();$.browser.webkit?(t=bahaRte.doc.createRange(),a.removeAllRanges()):t=bahaRte.selection.getRange(),t.selectNodeContents(e),a.addRange(t)},isCollapsed:function(){return bahaRte.selection.getRange(0).collapsed}};