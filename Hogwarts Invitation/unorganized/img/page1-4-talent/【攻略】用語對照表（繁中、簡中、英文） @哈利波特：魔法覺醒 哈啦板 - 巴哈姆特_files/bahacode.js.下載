(function(){var allowFontName=["新細明體","細明體","標楷體","微軟正黑體","Arial","Arial Black","Comic Sans MS","Courier New","MS Mincho","Symbol","Tahoma","Times New Roman","Verdana"];var allowFontSize={label:["很小","小","中","大","很大","特大","超級大"],size:["10px","13px","15px","18px","24px","32px","48px"],fontValue:[1,2,3,4,5,6,7]};var allowAlignTag=["div","p","h1","h2","h3","td","th","ol","ul","table"];var entityCode={code:["&nbsp;","&iexcl;","&quot;","&#39;","&amp;","&lt;","&gt;","&cent;","&pound;","&curren;","&yen;","&brvbar;","&sect;","&uml;","&copy;","&ordf;","&laquo;","&not;","&shy;","&reg;","&macr;","&deg;","&plusmn;","&sup2;","&sup3;","&acute;","&micro;","&para;","&middot;","&cedil;","&sup1;","&ordm;","&raquo;","&frac14;","&frac12;","&frac34;","&iquest;","&times;","&divide;","&#8194"],value:[" ","¡",'"',"'","&","<",">","¢","£","¤","¥","¦","§","¨","©","ª","«","¬","­","®","¯","°","±","²","³","´","µ","¶","·","¸","¹","º","»","¼","½","¾","¿","×","÷"," "]};var NODE_TYPE_ELEMENT_NODE=1;function bahacode(node){if(!node.innerHTML){return""}removeEmptyTag(node);var html=node.innerHTML;var result="";var endTagStack=[];var emptyTagList=["area","base","basefont","br","col","frame","hr","img","input","isindex","link","meta","param","embed"];var emptyTags=createMap(emptyTagList);html=html.replace(/[\x00-\x1f\x7f-\x9f\u00a0\u00ad\u0600-\u0604\u061c\u070f\u17b4\u17b5\u180e\u2002-\u200c\u200e\u200f\u2028-\u202f\u205f\u2060-\u206f\ufeff\ufff0-\uffff]/g,"");html=html.replace(/\r\n|\r|\n/g,"");html=html.replace(/\[/g,"&#91;").replace(/\]/g,"&#93;");HTMLParser(html,{start:function(tag,attrs,unary){tag=tag.toLowerCase();var isEmpty=emptyTags[tag];if(tag=="br"){result+="\n"}else{var bahaTags;if(tag.inArray(["img","td","th","tr","table","p","div"],true)){bahaTags=getBahaTagsWithAttr(tag,attrs,isEmpty)}else{bahaTags=getBahaTags(tag,attrs,isEmpty)}if(bahaTags.startTags!==""){result+=bahaTags.startTags}if(bahaTags.endTags===""&&!isEmpty){endTagStack.push(false)}else if(bahaTags.endTags!==""){endTagStack.push(bahaTags.endTags)}}if(tag.inArray(["table","tr","ol","ul"],true)){result+="\n"}},end:function(tag){tag=tag.toLowerCase();if(emptyTags[tag]){return}var value=endTagStack.pop();if(value!==false){result+=value}if(tag.inArray(["th","td","tr","li"],true)){result+="\n"}},chars:function(str){result+=str},commnet:function(str){}});result=result.replace(/\&[^;]+;/g,function($0){var entityMap=createMap(entityCode.code,entityCode.value);return entityMap[$0]||$0});return result}function removeEmptyTag(node){if(node.childNodes.length===0&&node.nodeType==NODE_TYPE_ELEMENT_NODE&&!node.nodeName.inArray(["area","base","basefont","br","col","frame","hr","img","input","isindex","link","meta","param","embed"],true)){var pNode=node.parentNode;pNode.removeChild(node);removeEmptyTag(pNode);return true}else if(node.hasChildNodes()){for(var i=0;i<node.childNodes.length;i++){if(removeEmptyTag(node.childNodes[i])){i--}}}return false}function createMap(aryKey,aryValue){var map={};var len=aryKey.length,i;for(i=0;i<len;i++){if(aryValue){map[isNaN(aryKey[i])?aryKey[i].toLowerCase():aryKey[i]]=aryValue[i]}else{map[aryKey[i]]=true}}return map}function getBahaTagsWithAttr(htmlTag,attrs,isEmpty){var flag=false,attribute="";var startTags="",endTags="",tabs="",colors="";var movie="",matches,i,color;if(htmlTag=="p"){htmlTag="div"}for(i=0;i<attrs.length;i++){attrs[i].value=attrs[i].value.trim();attrs[i].name=attrs[i].name.trim().toLowerCase();switch(attrs[i].name){case"src":if(attrs[i].value.trim().toLowerCase().indexOf("images/")===0){attrs[i].value=location.href.substring(0,location.href.lastIndexOf("/")+1)+attrs[i].value}var imgMatches;if((imgMatches=attrs[i].value.trim().match(/(^http[s]?:\/\/(?:.*?)\/(?:.*)\.(?:jpg|jpeg|gif|png))(?:\?[^\?]*)?$/i))||attrs[i].value.trim().match(/^http:\/\/link\.photo\.pchome\.com\.tw\/s[0-9]{1,3}\/[a-zA-Z0-9\_]{4,16}\/[0-9]{1,4}\/[0-9]{10,15}\/$/i)){if(htmlTag=="img"){var regexpEmoticon=/https?:\/\/i2\.bahamut\.com\.tw\/editor\/emotion\/([1-9][0-9]?)\.gif/;var regexpSticker=/https?:\/\/im\.bahamut\.com\.tw\/sticker\/(\d+)\/(\d+)\.png/;if(matches=attrs[i].value.match(regexpEmoticon)){attribute="="+matches[1]+attribute;htmlTag="em"}else if(matches=attrs[i].value.match(regexpSticker)){attribute="="+matches[1]+"_"+matches[2]+attribute;htmlTag="s"}else{var imgUrl;if(imgMatches){imgUrl=imgMatches[1]}else{imgUrl=attrs[i].value}attribute="="+imgUrl+attribute;flag=true}}}break;case"data-movie":if(htmlTag=="img"){movie=attrs[i].value}break;case"width":case"height":if(attrs[i].value.match(/^[1-9][0-9]{0,2}[%]?$/)){attribute+=" "+attrs[i].name+"="+attrs[i].value}break;case"cellspacing":case"cellpadding":if(attrs[i].value.match(/^[0-9]$/)){attribute+=" "+attrs[i].name+"="+attrs[i].value}break;case"style":var data=parseStyle(attrs[i].value,htmlTag,true);if(data.attribute.match(/bgcolor/i)){attribute=attribute.replace(/ bgcolor=[^ ]+/i,"")}attribute+=data.attribute;startTags+=data.startTags;endTags=data.endTags+endTags;break;case"bgcolor":if((htmlTag=="td"||htmlTag=="th"||htmlTag=="tr")&&attrs[i].value.match(/^(?:[a-zA-Z]{3,20}|#[0-9A-Fa-f]{6})$/)&&!attribute.match(/bgcolor/i)){attribute+=" bgcolor="+attrs[i].value}break;case"border":if(htmlTag=="table"&&attrs[i].value.match(/^[1-5]{1}$/)){attribute+=" border="+attrs[i].value}break;case"align":case"valign":var pattern;if(attrs[i].name=="align"){if(attrs[i].value.equals("middle")){attrs[i].value="center"}pattern=/^(center|left|right|justify|char)$/i}else{if(attrs[i].value.equals("center")){attrs[i].value="middle"}pattern=/^(top|middle|bottom|baseline)$/i}matches=attrs[i].value.trim().toLowerCase().match(pattern);if(matches&&htmlTag.inArray(allowAlignTag)){attribute+=" "+attrs[i].name+"="+attrs[i].value}break;case"rowspan":case"colspan":if(attrs[i].value.trim().match(/^[1-9][0-9]{0,2}$/)&&(htmlTag=="td"||htmlTag=="th")){attribute+=" "+attrs[i].name+"="+attrs[i].value}break;default:}}if(movie!==""){attribute=attribute.replace(/=(?:(?:https?:\/\/i1\.ytimg\.com\/vi\/[a-zA-Z0-9-_]{11}\/hqdefault\.jpg)|(?:https?:\/\/i2\.bahamut\.com\.tw\/(?:video_default\.png|editor\/movie_pre\.gif)))/,"="+movie);htmlTag="movie"}if(htmlTag!="img"||htmlTag=="img"&&flag){startTags="["+htmlTag+attribute+"]"+startTags}endTags+=!isEmpty&&startTags!==""?"[/"+htmlTag+"]":"";return{startTags:startTags,endTags:endTags}}function getBahaTags(htmlTag,attrs,isEmpty){var startTags="",endTags="",matches;var htmlTagList=["strike","del","blockquote","strong","big","em","dfn","var","cite","ins"];var textTagList=["s","s","tab","b","b","i","i","i","i","u"];var transformTags=createMap(htmlTagList,textTagList);htmlTag=transformTags[htmlTag]||htmlTag;var keepTagList=["b","i","u","s","tab","center","h1","h2","h3","hr","li","ul","ol","table","td","tr","th","div","p"];var keepTags=createMap(keepTagList);var isKeepTag=keepTags[htmlTag];if(isKeepTag){startTags+="["+htmlTag+"]"}if(!isEmpty&&isKeepTag){endTags+="[/"+htmlTag+"]"}for(var i=0;i<attrs.length;i++){switch(attrs[i].name){case"href":if(htmlTag=="a"){try{attrs[i].value=decodeURI(attrs[i].value)}catch(e){}attrs[i].value=attrs[i].value.replace(/\&amp;/g,"&");if(attrs[i].value.match(/^http:\/\/acg\.gamer\.com\.tw\/search\.php\?encode=(?:utf8|big5)\&kw=(.+)/)){startTags+="[acg]";endTags="[/acg]"+endTags}else if(matches=attrs[i].value.trim().match(/^javascript:confirmLink\('(http[s]?:\/\/[\S]+?)'\)[;]?$/)){startTags+="[url="+matches[1]+"]";endTags="[/url]"+endTags}else if(attrs[i].value.trim().match(/^http[s]?:\/\/.+?$/)){startTags+="[url="+attrs[i].value+"]";endTags="[/url]"+endTags}}break;case"color":var color=switchColor(attrs[i].value);if(color!==""&&htmlTag=="font"){startTags+="[color="+color+"]";endTags="[/color]"+endTags}break;case"face":var fonts=attrs[i].value.replace(/'/g,"").split(/,/);var allowFonts=createMap(allowFontName);if(htmlTag=="font"&&fonts.length>0&&allowFonts[fonts[0]]){startTags+="[font="+fonts[0]+"]";endTags="[/font]"+endTags}break;case"size":var fValue=allowFontSize.fontValue;if(htmlTag=="font"&&attrs[i].value.match(/^[1-7]$/)){startTags+="[size="+attrs[i].value+"]";endTags="[/size]"+endTags}break;case"align":matches=attrs[i].value.trim().toLowerCase().match(/^(left|center|right)$/i);var allowTags=createMap(allowAlignTag);if(matches&&allowTags[htmlTag]){startTags+="["+matches[1]+"]";endTags="[/"+matches[1]+"]"+endTags}break;case"style":if(!isEmpty){var tags=parseStyle(attrs[i].value,htmlTag,false);startTags+=tags.startTags;endTags=tags.endTags+endTags}break;default:}}return{startTags:startTags,endTags:endTags}}function parseStyle(attr,tag,withAttr){var startTags="",endTags="",attribute="",matches;var aryStyle=attr.split(";");for(var j=0;j<aryStyle.length;j++){if(aryStyle[j].trim()===""){continue}var aryTmp=aryStyle[j].split(":");var name=aryTmp[0].trim().toLowerCase();if(!aryTmp[1]){continue}var valueAll=aryTmp[1].trim().replace(/^["']([^"']+)["']$/,"$1");var value=valueAll.split(/\s+/);if(value.length===0){continue}switch(name){case"color":case"background-color":var bg=name=="color"?"":"bg";var color=switchColor(valueAll);if(color!==""){if(name=="background-color"&&withAttr){attribute+=" bgcolor="+color}else if(!tag.inArray(["tr","tbody","table"])){startTags+="["+bg+"color="+color+"]";endTags="[/"+bg+"color]"+endTags}}break;case"font-family":var allowFonts=createMap(allowFontName);var fonts=valueAll.replace(/'/g,"").split(/,/);if(fonts.length>0&&allowFonts[fonts[0]]){startTags+="[font="+fonts[0]+"]";endTags="[/font]"+endTags}break;case"font-size":var afs=allowFontSize;var fontSizeMap=createMap(afs.size,afs.fontValue);startTags+="[size="+fontSizeMap[switchSize(value[0])]+"]";endTags="[/size]"+endTags;break;case"font-weight":if(value[0].toLowerCase()=="bold"){startTags+="[b]";endTags="[/b]"+endTags}break;case"font-style":var fsAry=createMap(value);if(fsAry["italic"]||fsAry["oblique"]){startTags+="[i]";endTags="[/i]"+endTags}break;case"text-decoration":var tdAry=createMap(value);if(tdAry["line-through"]){startTags+="[s]";endTags="[/s]"+endTags}if(tdAry["underline"]){startTags+="[u]";endTags="[/u]"+endTags}break;case"margin-left":matches=[];if(matches=value[0].match(/([0-9]{1,3})px/i)){var times=Math.ceil(parseInt(matches[1],10)/40);if(tag=="div"){attribute+=" tab="+times}else{for(var i=0;i<times;i++){startTags+="[tab]";endTags="[/tab]"+endTags}}}break;case"text-align":matches=value[0].trim().toLowerCase().match(/(left|center|right)/i);var allowTags=createMap(allowAlignTag);if(matches&&allowTags[tag]){if(withAttr){attribute+=" align="+matches[1]}else{startTags+="["+matches[1]+"]";endTags="[/"+matches[1]+"]"+endTags}}break;case"vertical-align":matches=value[0].trim().toLowerCase().match(/(top|middle|bottom)/i);var allowTags=createMap(allowAlignTag);if(matches&&allowTags[tag]&&withAttr){attribute+=" valign="+matches[1]}break;case"width":case"height":var size=switchSize(valueAll,true);if(size!==""&&withAttr){attribute+=" "+name+"="+size}break;default:}}return{startTags:startTags,endTags:endTags,attribute:attribute}}function switchSize(size,forLength){var bs=15;var result=0;var sizeArray=["small","medium","large","x-large","xx-large"];var sizeValue=["13px","15px","18px","24px","32px"];if(size.inArray(sizeArray,true)){var sizeMap=createMap(sizeArray,sizeValue);return sizeMap[size.trim().toLowerCase()]}if(matches=size.match(/\s*([0-9]{0,3}(?:\.[0-9]{1,6})?)(%|px|pt|em|ex|pc|cm|mm|in)\s*/i)){if(matches[2].inArray(["%","em"],true)&&forLength){return size}var num=parseFloat(matches[1]);if(!isNaN(num)){switch(matches[2]){case"%":result=round(num/100*bs,6);break;case"px":result=num;break;case"pt":result=round(num/.75,6);break;case"em":result=num*bs;break;case"ex":result=num*9.333333;break;case"pc":result=num*bs;break;case"cm":result=round(num*37.795276,6);break;case"mm":result=round(num*3.779527,6);break;case"in":result=num*96;break;default:}if(forLength){return round(result,0)}var min=2147483647,index=0;var aryFS=allowFontSize.size;for(var i=0;i<aryFS.length;i++){var fsize=parseFloat(aryFS[i].substr(0,aryFS[i].length-2));if(Math.abs(result-fsize)<min){min=Math.abs(result-fsize);index=i}}result=aryFS[index]}}return result===0?bs+"px":result}function round(num,precision){multi=Math.pow(10,precision);return Math.round(num*multi)/multi}function switchColor(color){var result=color,matches;if((matches=color.match(/\s*rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)\s*/i))||(matches=color.match(/\s*rgba\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*[0-9.]+\s*\)\s*/i))){var r=dec2hex(matches[1]);var g=dec2hex(matches[2]);var b=dec2hex(matches[3]);if(r<0||g<0||b<0){result=""}else{result="#"+r+g+b}}return result}function dec2hex(decStr){var hex="";var aryHex=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];var num=parseInt(decStr,10);if(isNaN(num)||num<0){return-1}while(num>0){hex=aryHex[num%16]+hex;num=Math.floor(num/16)}if(hex===""){hex="00"}else if(hex.length==1){hex="0"+hex}return hex}String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};String.prototype.equals=function(string,caseSensitive){if(!caseSensitive){return this.trim().toLowerCase()==string.trim().toLowerCase()}return this==string};String.prototype.inArray=function(ary,caseInsensitive){var str=this;if(caseInsensitive){str=str.toLowerCase()}for(var i=0;i<ary.length;i++){if(caseInsensitive){ary[i]=ary[i].toLowerCase()}if(str==ary[i]){return true}}return false};window.Bahacode=function(node){this.convert=function(){if(!node)node=document.body;return bahacode(node)}}})();