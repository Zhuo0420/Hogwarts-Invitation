(function($,window){"use strict";var signinDialog=null;var signinFrame;var Signin={totalDays:null,totalWeeks:null,isFinishedAd:false,debugFlag:false,checkSigninStatus:async function(){let csrf=new Bahamut.Csrf;csrf.setCookie();let formData=new FormData;formData.append("action",2);let resp=await fetch(`https://api.gamer.com.tw/user/v1/signin.php`,{method:"POST",body:formData,headers:csrf.getFetchHeaders(),credentials:"include"});return resp.json()},signinWork:async function(){let csrf=new Bahamut.Csrf;csrf.setCookie();let formData=new FormData;formData.append("action",1);let resp=await fetch(`https://api.gamer.com.tw/user/v1/signin.php`,{method:"POST",body:formData,headers:csrf.getFetchHeaders(),credentials:"include"});return resp.json()},signinSuccessAnime:function(){setTimeout(function(){signinDialog.$content.find(".before-active").addClass("is-active")},850)},load:function(){this.checkSigninStatus().then(json=>{let signinBtn=$("#signin-btn");if(json.error){signinBtn.html(json.error.message);return false}let signin=parseInt(json.data.signin,10);if(signin==1){signinBtn.addClass("is-active");signinBtn.attr("onclick","Signin.showSigninMap();")}this.totalDays=json.data.days;this.totalWeeks=json.data.totalWeeks;this.isFinishedAd=json.data.finishedAd;signinBtn.html(json.data.btnMessage)})},start:function(){if(!window.User.Login.requireLoginIframe()){return false}this.signinWork().then(json=>{if(json.error){Dialogify.alert(json.error.message);return false}this.totalDays=json.data.days;this.totalWeeks=json.data.totalWeeks;this.isFinishedAd=false;this.openSigninMap("signin");this.signinSuccessAnime();let signinBtn=$("#signin-btn");signinBtn.addClass("is-active");signinBtn.html(json.data.btnMessage);signinBtn.attr("onclick","Signin.showSigninMap();");if(json.data.dialogInfo.title||json.data.dialogInfo.image||json.data.dialogInfo.content){this.showBonusCard(json.data.dialogInfo)}})},showSigninMap:function(){if(this.totalDays!=null&&this.totalWeeks!=null){this.openSigninMap("check")}else{this.checkSigninStatus().then(json=>{if(json.error){Dialogify.alert(json.error.message);return false}this.totalDays=json.data.days;this.totalWeeks=json.data.totalWeeks;this.isFinishedAd=json.data.finishedAd;this.openSigninMap("check")})}},openSigninMap:function(action){nunjucks.configure({autoescape:false});let dialogHtml=nunjucks.render("signin_dialog.njk.html",{totalDays:this.totalDays,totalWeeks:this.totalWeeks,action:action,isFinishedAd:this.isFinishedAd});signinDialog=new Dialogify(dialogHtml,{useDialogForm:false,size:"popup-dailybox--width",dialog:{className:"popup-dailybox"}});signinDialog.showModal()},showBonusCard:function(dialogInfo){nunjucks.configure({autoescape:false});let dialogHtml=nunjucks.render("signin_bonus.njk.html",{image:dialogInfo.image,title:dialogInfo.title,content:dialogInfo.content});let bonusCard=new Dialogify(dialogHtml,{useDialogForm:false,size:"popup-dailybox-tip--width",dialog:{className:"popup-dailybox-tip"}});setTimeout(function(){bonusCard.showModal()},850);setTimeout(function(){bonusCard.$content.find(".popup-dailybox-tip__stamp").show()},1e3);setTimeout(function(){bonusCard.close()},8e3)},mobile:function(){if(!window.User.Login.isLogin()){return false}this.checkSigninStatus().then(json=>{if(json.error){return false}this.isFinishedAd=json.data.finishedAd;if(json.data.signin==0){Signin.signinWork().then(json2=>{if(json2.error){return false}Signin.totalDays=json2.data.days;Signin.totalWeeks=json2.data.totalWeeks;Signin.openSigninMap("signin");Signin.signinSuccessAnime();if(json2.data.dialogInfo.title||json2.data.dialogInfo.image||json2.data.dialogInfo.content){Signin.showBonusCard(json2.data.dialogInfo)}Signin.load()})}else{Signin.totalDays=json.data.days;Signin.totalWeeks=json.data.totalWeeks;Signin.openSigninMap("check")}})},auto:function(){if(!window.User.Login.isLogin()){return false}let time=new Date;if(time.getHours()===0&&time.getMinutes()>=0&&time.getMinutes()<=5){return false}this.checkSigninStatus().then(json=>{if(json.error){return false}if(json.data.close_auto==1){return false}this.isFinishedAd=json.data.finishedAd;if(json.data.signin==0){Signin.signinWork().then(json2=>{if(json2.error){return false}Signin.totalDays=json2.data.days;Signin.totalWeeks=json2.data.totalWeeks;Signin.openSigninMap("signin");Signin.signinSuccessAnime();if(json2.data.dialogInfo.title||json2.data.dialogInfo.image||json2.data.dialogInfo.content){Signin.showBonusCard(json2.data.dialogInfo)}signinFrame.contentWindow.postMessage({action:"finish",userid:window.User.Login.getUserid()},"https://api.gamer.com.tw");Signin.load()})}else{if(Signin.debugFlag==true){Signin.totalDays=json.data.days;Signin.totalWeeks=json.data.totalWeeks;Signin.openSigninMap("check")}signinFrame.contentWindow.postMessage({action:"finish",userid:window.User.Login.getUserid()},"https://api.gamer.com.tw")}})},debug:function(){signinFrame.contentWindow.postMessage({action:"debug"},"https://api.gamer.com.tw")},setDebug:function(){this.debugFlag=true}};window.Signin=Signin;window.onmessage=function(e){if(e.origin=="https://api.gamer.com.tw"&&e.data=="auto_signin"){window.Signin.auto()}if(e.origin=="https://api.gamer.com.tw"&&e.data=="debug"){window.Signin.setDebug()}};$(function(){if(typeof window.User!="undefined"&&typeof window.User.Login!="undefined"&&window.User.Login.isLogin()){signinFrame=document.createElement("iframe");signinFrame.src="https://api.gamer.com.tw/worker/signin.html";signinFrame.onload=function(){this.contentWindow.postMessage({action:"check",userid:window.User.Login.getUserid()},"https://api.gamer.com.tw")};signinFrame.style.display="none";document.body.appendChild(signinFrame)}})})(jQuery,window);