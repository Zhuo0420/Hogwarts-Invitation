(function($,window){var ForumVote={voteToggle:function(item,area,dataId,optionSn,originalStatus){var isLogin=User.Login.requireLogin();if(!isLogin){ForumVote.setOptionStatus(item,originalStatus);return}Vote.vote(area,dataId,optionSn,function(json){if(json.error){ForumVote.setOptionStatus(item,originalStatus);if(json.error.code==401){Dialogify.confirm("請先登入",{ok:function(){location.href="https://user.gamer.com.tw/login.php"},cancel:function(){location.href="javascript:void(0)"}})}else if(json.error.message=="您必須完成「手機認證」才能使用功能。"){toastr.warning(json.error.message,"",{tapToDismiss:true})}else{Dialogify.alert(json.error.message)}return}ForumVote.setOptionStatus(item,json.data.voted);ForumVote.updateVoteStatus(item,area,dataId,json.data.voted);if(json.data.voted){if(json.data.original_voted!=true){toastr.success("投票成功","",{positionClass:"toast-bottom-center"})}}else{toastr.info("已取消投票","",{positionClass:"toast-bottom-center"})}})},setOptionStatus(item,checked){if($(item).is("input")){$(item).prop("checked",checked)}else{$(item).find('input[type="checkbox"]').prop("checked",checked);$(item).find('input[type="radio"]').prop("checked",checked);$(item).parents(".vote-item").find('input[type="checkbox"]').prop("checked",checked);$(item).parents(".vote-item").find('input[type="radio"]').prop("checked",checked)}},updateVoteStatus:function(item,area,dataId,voted){Vote.getVote(area,dataId,function(json){if(!json.error){var options=json.data.options;if(json.data.live==1&&voted||json.data.is_end){$(item).parents(".vote-block").find(".vote-item").each(function(index,elem){var sn=$(elem).data("sn");var percent=""+options[sn].percent+"%";var votes=""+options[sn].votes+"票";$(this).find(".progress-bar").css("width",percent);$(this).find(".pull-right").css("display","").html(votes);if($(this).children(".vote-result").length==0&&!json.data.anonymous){$(this).append('<div class="vote-result"></div>')}ForumVote.updateOptions(elem,area,dataId,sn,voted)})}if(!json.data.is_end&&!voted){$(item).parents(".vote-block").find(".vote-item").each(function(index,elem){$(this).find(".progress-bar").css("width","0%");$(this).find(".pull-right").css("display","none").html("");$(this).find(".vote-result").remove()})}}})},updateOptions:function(item,area,dataId,optionSn,voted){if(voted){Vote.getOptionUserList(area,dataId,optionSn,1,function(json){if(json.error){return}$(item).find(".vote-result").empty().data("id","");ForumVote.setOptionStatus(item,false);var arr=json.data.list.slice(0,3);var arrSize=arr.length;for(var i=0;i<arrSize;i++){if(json.data.show_user_list){var resultItem=null;if(i==arrSize-1&&arrSize>2){resultItem=`<a href="javascript:void(0);" class="vote-result-item vote-result-more">
                                    <div class="vote-result-item">
                                        <img src="`+arr[i].avatar+`">
                                        <i class="fa fa-ellipsis-h fa-lg"></i>
                                    </div>
                                </a>`}else{resultItem=`<div class="vote-result-item">
                                    <img class="gamercard" data-gamercard-userid="`+arr[i].userid+`" src="`+arr[i].avatar+`">
                                </div>`}if(resultItem!=null){$(item).find(".vote-result").append($(resultItem));$(item).find(".vote-result").find("a").data("id",area+"_"+dataId+"_"+optionSn)}}if(json.data.reader_voted){ForumVote.setOptionStatus(item,true)}}if(json.data.show_user_list){ForumVote.bindVoteUserListClick()}})}else{ForumVote.setOptionStatus(item,false)}},showVoteUserListTippy:function($popper,area,dataId,optionSn,page){Vote.getOptionUserList(area,dataId,optionSn,page,function(json){var div=$popper.find(".tippy-content > div");if(json.error){div.text(json.error.message)}else{var list=json.data.list;var html="";for(var i in list){html+='<a target="_blank" href="https://home.gamer.com.tw/'+list[i]["userid"]+'">';html+='<img class="gamercard" data-gamercard-userid="'+list[i]["userid"]+'" src="'+list[i]["avatar"]+'"></a>'}var prev,next;if(json.data["total_page"]>1){html+='<div class="buttons">';if(json.data["page"]>1){prev=function(){ForumVote.showVoteUserListTippy($popper,area,dataId,optionSn,json.data.page-1)};html+='<button id="voteUserListPrev" type="button" class="btn--sm btn--normal">上一頁</button>'}if(json.data["page"]<json.data["total_page"]){next=function(){ForumVote.showVoteUserListTippy($popper,area,dataId,optionSn,json.data.page+1)};html+='<button id="voteUserListNext" type="button" class="btn--sm btn--normal">下一頁</button>'}html+="</div>"}div.html(html)}$popper.find("#voteUserListPrev").off("click").on("click",prev||function(){});$popper.find("#voteUserListNext").off("click").on("click",next||function(){})})},bindVoteUserListClick:function(callback=null){if(callback!=null){this.callback=callback}if(this.callback!=null){$(".vote-result-more").off("click");$(".vote-result-more").on("click",function(){ForumVote.callback()})}if(typeof tippy==="function"){tippy(".vote-result a",{content:'<div class="vote-user-list"><img src="https://i2.bahamut.com.tw/mobile/loading.svg"></div>',allowHTML:true,placement:"auto",arrow:true,trigger:"click",theme:"light",interactive:true,duration:240,maxWidth:"460px",appendTo:window.document.body,onShow:instance=>{var elem=$(instance.reference);let $popper=$(instance.popper);if(elem.data("id")!=""){$popper.find(".tippy-content > div").html('<img src="https://i2.bahamut.com.tw/mobile/loading.svg">');var data=elem.data("id").split("_");ForumVote.showVoteUserListTippy($popper,data[0],data[1]+"_"+data[2],data[3],1)}}})}}};window.ForumVote=ForumVote})(jQuery,window);