var bahaRte={isPlainText:false,TEXT:1,HTML:2,doc:null,win:null,source:null,config:null,buttonSetName:"",deleteAutosaveFlag:false,popupList:[],previousStyle:null,copiedState:{state:0},previousSel:null,undoStack:{stack:[],range:[]},undoPosition:0,undoFlag:false,autosave:undefined,autosaveTimer:null,autosaveFlag:true,getAutosaveFlag:true,loadBackupFlag:false,setupAutoHeight:false,loadedImg:0,checkViewFlag:true,constants:{editorImgUrl:"https://i2.bahamut.com.tw/editor/",editorCssUrl:"https://i2.bahamut.com.tw/css/editor/",movieImgUrl:"https://i2.bahamut.com.tw/editor/movie_pre.gif",emotionUrl:"https://i2.bahamut.com.tw/editor/emotion/",stickerUrl:"https://im.bahamut.com.tw/sticker/",baseSize:15,maxUndoSteps:20,autosaveTick:18e4,maxContentLength:15e4,allowFontName:["新細明體","細明體","標楷體","微軟正黑體","Arial","Arial Black","Comic Sans MS","Courier New","MS Mincho","Symbol","Tahoma","Times New Roman","Verdana"],allowFontSize:{label:["很小","小","中","大","很大","特大","超級大"],size:["10px","13px","15px","18px","24px","32px","48px"],fontValue:[1,2,3,4,5,6,7],keyword:["x-small","small","medium","large","x-large","xx-large"]},allowAlignTag:["div","p","h1","h2","h3","h4","td","th","ol","ul","table"],movieData:{url:{youtube:/^https?:\/\/(?:(?:tw|jp|www)\.)?youtube\.com\/watch\?v=([0-9a-zA-Z_-]{11})((?:(?:\&|\?|#|\&#)\w+=[\w\.]+)*)/,yam:/^https?:\/\/mymedia\.yam\.com\/m\/([0-9]+)$/,yamMusic:/^https?:\/\/mymedia\.yam\.com\/music\/([0-9]+)$/,soapbox:/^https?:\/\/soapbox\.msn\.com\.tw\/soapbox(?:tw)?_watch\.aspx\?code=([0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12})$/,wretch:/^https?:\/\/www\.wretch\.cc\/video\/([A-Za-z0-9=]+)$/,newtube:/^https?:\/\/(?:www\.)?(?:youtube|youtube-nocookie)\.com\/embed\/([0-9a-zA-Z_-]{11})((?:(?:\&|\?|#|\&#)\w+=[\w\.]+)*)/,sharetube:/https?:\/\/youtu\.be\/([0-9a-zA-Z_-]{11})((?:(?:\&|\?|#|\&#)\w+=[\w\.]+)*)/,xuite:/^https?:\/\/vlog\.xuite\.net\/play\/([a-zA-Z0-9+\/=]{24,28})((?:(?:\&|\?|#|\&#)\w+=[\w\.]+)*)/,nico:/^https?:\/\/(?:www|tw)\.nicovideo\.jp\/watch\/((?:sm|nm|ca|cd|ax|yo|nl|ig|na|cw|za|zb|zc|zd|ze|om|sk|yk|so|am|fz)[0-9]{1,14}|[0-9]{10})$/,twitch:/^https?:\/\/(?:www|player)\.twitch\.tv\/videos\/((?:[bcv]?)[\d]+)/,twitchChannel:/^https?:\/\/(?:www|player|go)\.twitch\.tv\/([a-zA-Z0-9_]{4,25})(?:\/([bcv])\/([0-9]+))?/,livehouse:/^https:\/\/livehouse\.in\/channel\/(\w+)$/,facebook:/^https?:\/\/www\.facebook\.com\/(\w+)\/videos\/(\d+)\/$/,shortstube:/^https?:\/\/(?:www\.)?youtube\.com\/(?:shorts|live)\/([0-9a-zA-Z_-]{11})((?:(?:\&|\?|#|\&#)\w+=[\w\.]+)*)/},code:{youtube:/^<object width="([1-9][0-9]{0,3})" height="([1-9][0-9]{0,3})">.*?<param name="movie" value="https?:\/\/(?:www\.)?youtube\.com\/v\/([0-9a-zA-Z_-]{11})((?:(?:\&|\&amp;|\?)\w+=[\w\.]+)*)&?">.+?<embed.+?><\/embed><\/object>$/i,yam:/^<object width="([1-9][0-9]{0,2})" height="([1-9][0-9]{0,2})">.*?<param name="movie" value="https?:\/\/mymedia\.yam\.com\/@\/([0-9]+)">.+?<embed.+?><\/embed><\/object>$/i,yamMusic:/^<object width="([1-9][0-9]{0,2})" height="([1-9][0-9]{0,2})">.*?<param name="movie" value="https?:\/\/mymedia\.yam\.com\/\*\/([0-9]+)">.+?<embed.+?><\/embed><\/object>$/i,soapbox:/^<embed src="https?:\/\/images\.video\.msn\.com\/flash\/soapbox1_1\.swf"(?:[^>]*?)width="([1-9][0-9]{0,2})" height="([1-9][0-9]{0,2})"(?:.*?)flashvars="c=v&v=([0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12})(?:[^"]*?)"><\/embed>$/i,wretch:/^<embed src=https?:\/\/embed\.wretch\.cc\/([A-Za-z0-9=]+) width=([1-9][0-9]{0,2}) height=([1-9][0-9]{0,2})(?:[^>]*?)><\/embed>$/i,newtube:/^<iframe.*? width="([1-9][0-9]{0,3})" height="([1-9][0-9]{0,3})" src="(?:https?:)?\/\/(?:www\.)?(?:youtube|youtube-nocookie)\.com\/embed\/([0-9a-zA-Z_-]{11})((?:(?:\&|\&amp;|\?)\w+=[\w\._\-]+)*)&?"[^>]*?><\/iframe>$/i,xuite:/^<iframe.*? src='https?:\/\/vlog\.xuite\.net\/embed\/([a-zA-Z0-9+\/=]{24,28})((?:(?:\&|\?|#|\&#)\w+=[\w\.]+)*)'.*? width='([1-9][0-9]{0,3})' height='([1-9][0-9]{0,3})'.*?><\/iframe>$/i,nico:/^<script .*?src="https?:\/\/ext\.nicovideo\.jp\/thumb_watch\/((?:sm|nm|ca|cd|ax|yo|nl|ig|na|cw|za|zb|zc|zd|ze|om|sk|yk|so|am|fz)[0-9]{1,14}|[0-9]{10})(?:\?[^"]*?)?"><\/script>.*?/,twitchVideo:/^<iframe.*? src="https?:\/\/(www|player)\.twitch\.tv\/(?:\?autoplay=false)?(?:\?|\&)video=([bcv][\d]+)(?:\&autoplay=false)?".*? height="([1-9][0-9]{0,3})".*? width="([1-9][0-9]{0,3})".*?><\/iframe>(<a.*?<\/a>)/,twitchChannel:/^<iframe.*? src="https?:\/\/(www|player)\.twitch\.tv\/\?channel=([a-zA-Z0-9_]{4,25})".*? height="([1-9][0-9]{0,3})".*? width="([1-9][0-9]{0,3})".*?><\/iframe>(<a.*?<\/a>)/,livehouse:/^<iframe.*? width="([\d]{2,3})".*? height="([\d]{2,3})".*? src="https:\/\/livehouse\.in\/embed\/channel\/(\w+)".*? frameborder="0".*? allowfullscreen><\/iframe>$/,facebook:/^<iframe src="https?:\/\/www\.facebook\.com\/plugins\/video\.php\?href=https%3A%2F%2Fwww\.facebook\.com%2F(\w+)%2Fvideos%2F(\d+)%2F.*?" width="(\d+)".*? height="(\d+)".*?><\/iframe>$/},urlTemplate:{youtube:"https://www.youtube.com/watch?v={MOVIE-ID}",xuite:"https://vlog.xuite.net/play/{MOVIE-ID}",twitch:"https://www.twitch.tv/{MOVIE-ID}",livehouse:"https://livehouse.in/channel/{MOVIE-ID}",facebook:"https://www.facebook.com/{CHANNEL-ID}/videos/{MOVIE-ID}/",yam:"http://mymedia.yam.com/m/{MOVIE-ID}",yamMusic:"http://mymedia.yam.com/music/{MOVIE-ID}",soapbox:"http://soapbox.msn.com.tw/soapboxtw_watch.aspx?code={MOVIE-ID}",wretch:"http://www.wretch.cc/video/{MOVIE-ID}",nico:"http://www.nicovideo.jp/watch/{MOVIE-ID}"},defaultSize:{max:{w:640,h:360},youtube:{w:640,h:360},yam:{w:640,h:523},yamMusic:{w:640,h:170},soapbox:{w:640,h:539},wretch:{w:640,h:480},newtube:{w:640,h:360},sharetube:{w:640,h:360},shortstube:{w:640,h:360},xuite:{w:640,h:399},nico:{w:490,h:370},twitch:{w:640,h:399},livehouse:{w:640,h:360},facebook:{w:640,h:360}}},colorTable:["#000000","#993300","#333300","#003300","#003366","#000080","#333399","#333333","#790000","#ff6600","#7f7f00","#808080","#008080","#0000ff","#666699","#808080","#ff0000","#ff9900","#99cc00","#339966","#33cccc","#3366ff","#800080","#999999","#ff00ff","#ffcc00","#ffff00","#00ff00","#00ffff","#00ccff","#993366","#c0c0c0","#ff99cc","#ffcc99","#ffff99","#ccffcc","#ccffff","#99ccff","#cc99ff","#ffffff"],entityCode:{code:["&nbsp;","&iexcl;","&quot;","&#39;","&amp;","&lt;","&gt;","&cent;","&pound;","&curren;","&yen;","&brvbar;","&sect;","&uml;","&copy;","&ordf;","&laquo;","&not;","&shy;","&reg;","&macr;","&deg;","&plusmn;","&sup2;","&sup3;","&acute;","&micro;","&para;","&middot;","&cedil;","&sup1;","&ordm;","&raquo;","&frac14;","&frac12;","&frac34;","&iquest;","&times;","&divide;","&#8194"],value:[" ","¡",'"',"'","&","<",">","¢","£","¤","¥","¦","§","¨","©","ª","«","¬","­","®","¯","°","±","²","³","´","µ","¶","·","¸","¹","º","»","¼","½","¾","¿","×","÷"," "]},serviceUrl:{wiki:"http://wiki2.gamer.com.tw/wiki.php?n=",wikiPattern:/<a[^>]+href=["]?https?:\/\/wiki2\.gamer\.com\.tw\/wiki\.php\?n=([0-9]+)(?:%3[aA]|:)([^\&">]+)(?:\&[^">]*)*[^>]*["]?>(?:.*?)<\/a[\s]*>/gi,wikiUrlPattern:/^https?:\/\/wiki2\.gamer\.com\.tw\/wiki\.php\?n=([0-9]+)(?:%3[aA]|:)([^\&]+).*/,guildWikiUrlPattern:/^https?:\/\/guild\.gamer\.com\.tw\/wiki\.php\?sn=([0-9]+)&n=([^\&]+).*/,acg:"https://acg.gamer.com.tw/search.php?encode=utf8&kw=",acgPattern:/^https?:\/\/acg\.gamer\.com\.tw\/search\.php\?(?:encode=(?:utf8|big5)\&)?kw=(.+)/},nodeType:{ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12},tagState:{BOLD:1,ITALIC:2,UNDERLINE:4,STRIKE:8,HEADING1:16,HEADING2:32,HEADING3:64,FORECOLOR:128,BACKGROUNDCOLOR:256,INDENT:512,LINK:1024,HORIZONTALRULE:2048,IMAGE:4096,FONTNAME:8192,FONTSIZE:16384,ORDEREDLIST:32768,UNORDEREDLIST:65536,CENTER:131072,LEFT:262144,RIGHT:524288,WIKI:1048576,ACG:2097152,EMOTION:4194304,MOVIE:8388608,TABLE:16777216}},editor:function(config){bahaRte.config=config;if(config.dialogUrl){bahaRte.dialogUrl=config.dialogUrl}var edit=config.target;edit.contentWindow.document.designMode="on";bahaRte.win=edit.contentWindow;bahaRte.doc=bahaRte.win.document;bahaRte.isPlainText=false;bahaRte.source=bahaRte.utility.createSourceWindow();jQuery(edit).after(bahaRte.source);bahaRte.utility.initContent();jQuery(bahaRte.doc.body).contextmenu(bahaRte.utility.editorOnContextMenu);bahaRte.autosaveTimer=setTimeout(bahaRte.utility.save,bahaRte.constants.autosaveTick);bahaRte.utility.resizable();if(config.warnMsg){alert(config.warnMsg)}bahaRte.statusbar=jQuery(".c-post__header span")},rteHeightWatcher:function(rteInitHeight){rteInitHeight=typeof rteInitHeight!=="undefined"?rteInitHeight:120;var targetNode=document.getElementById("editor").contentDocument;var config={childList:true,subtree:true,characterData:true};var callback=function(mutationsList,observer){var nodes=targetNode.children[0].lastChild.children;var childHeight=0;var height=rteInitHeight;for(var i=0;i<nodes.length;i++){childHeight+=bahaRte.getOuterHeight(nodes[i])}childHeight+=26;height=Math.max(childHeight,height);jQuery("#editor").trigger("adjustHeight",height);var images=targetNode.getElementsByTagName("img");if(bahaRte.loadedImg>images.length){bahaRte.loadedImg=images.length}if(images.length>bahaRte.loadedImg){for(var i=0;i<images.length;i++){images[i].addEventListener("load",function(){childHeight+=bahaRte.getOuterHeight(this);height=Math.max(childHeight,height);bahaRte.loadedImg++;if(bahaRte.loadedImg==images.length){jQuery("#editor").trigger("adjustHeight",height)}})}}};var observer=new MutationObserver(callback);observer.observe(targetNode,config)},getOuterHeight:function(el){var height=el.scrollHeight;var style=getComputedStyle(el);height+=parseInt(style.marginTop)+parseInt(style.marginBottom);return height},getContent:function(html){bahaRte.toolbar.refreshContent();if(html){return bahaRte.doc.body.innerHTML}return bahaRte.source.value},isEmpty:function(){bahaRte.toolbar.refreshContent();var text=bahaRte.source.value;text=text.replace(/\[(?:(?!img|em|movie|s=))[^\]]+\]/g,"");if(text.match(/^[ 　\n]+$/)||text===""){return true}return false},post:function(formName,getText){bahaRte.toolbar.refreshContent();var text=bahaRte.source.value;var html=bahaRte.doc.body.innerHTML;if(text.replace(/\r?\n/g,"\r\n").utf8Length()>bahaRte.constants.maxContentLength){alert("您的文章內容太長, 請刪減部分內容後再試一次");return}$.ajax({method:"POST",param:"content="+encodeURIComponent(text)+"&service="+bahaRte.config.service,url:"/editor/autosave.php",success:function(responseText){if(responseText=="NO_LOGIN"){egg.msgbox("你的帳號已被系統登出<br />請自行備份你的文章後重新登入。",{height:"100px",buttons:egg.msgbox.OK,onOk:function(){egg.msgbox.close()}});return}bahaRte.autosave=text;window.onbeforeunload=null;window.onunload=null;var frm=document.getElementById(formName);var hide=document.createElement("input");hide.type="hidden";hide.name="rtecontent";hide.value=getText?text:html;frm.appendChild(hide);frm.submit()}})},convertor:{parseHtmlCode:function(html){if(!html){return undefined}var movieData=bahaRte.constants.movieData;var movie="";for(var key in movieData.code){html=html.replace(movieData.code[key],function($0,$1,$2,$3,$4){var width,height,code,channel,param;param=$4;if(key=="wretch"){width=$2;height=$3;code=$1}else if(key=="facebook"){channel=$1;code=$2;width=$3;height=$4}else{width=$1;height=$2;code=$3}switch(key){case"youtube":movie=movieData.urlTemplate.youtube.replace("{MOVIE-ID}",code);var paramAry=param.replace(/\&amp;/,"&").split(/\&/);var movieArgs="";for(var i=0;i<paramAry.length;i++){if(paramAry[i].match(/hd=1/)){movieArgs+="&hd=1"}if(paramAry[i].match(/fs=1/)){movieArgs+="&fs=1"}if(matches_y=paramAry[i].match(/start=(\d+)/)){movieArgs+="&t="+matches_y[1]}}movie+=movieArgs;break;case"facebook":movie=movieData.urlTemplate[key].replace("{CHANNEL-ID}",channel).replace("{MOVIE-ID}",code);break;case"soapbox":case"yam":case"yamMusic":case"wretch":movie=movieData.urlTemplate[key].replace("{MOVIE-ID}",code);break;default:}var ret='<img width="'+width+'" height="'+height+'" movie="'+movie+'" src="'+bahaRte.constants.movieImgUrl+'" />';return ret})}return html},charInTag:function(source,charPos){var pos1,pos2,pos3,pos4;pos1=source.lastIndexOf("[",charPos);pos2=source.lastIndexOf("]",charPos);pos3=source.indexOf("[",charPos);if(pos3==-1){pos3=2147483647}pos4=source.indexOf("]",charPos);return pos1>pos2&&pos3>pos4},charPrevTag:function(source,charPos){var lastTag;var inTag=bahaRte.convertor.charInTag(source,charPos);var pos1,pos2;pos2=source.lastIndexOf("]",charPos);if(inTag||pos2==-1){lastTag=""}else{pos1=source.lastIndexOf("[",pos2);lastTag=pos1==-1?"":source.substring(pos1+1,pos2).split(" ")[0]}return lastTag},charNextTag:function(source,charPos){var nextTag;var inTag=bahaRte.convertor.charInTag(source,charPos);var pos1,pos2,txt;pos1=source.indexOf("[",charPos);if(inTag||pos1==-1){nextTag=""}else{txt=source.substring(charPos+1,pos1);if(txt.match(/^[\s\n]*$/)){pos2=source.indexOf("]",pos1);nextTag=pos2==-1?"":source.substring(pos1+1,pos2).split(" ")[0]}else{nextTag=""}}return nextTag},parseReturnAndSpace:function(text){var sPos;var prevTags=["table","tr","/tr","/th","/td","ol","ul","/li"];var nextTags=["/td","/th","/li"];while((sPos=text.indexOf(" ",sPos))!=-1){if(!bahaRte.convertor.charInTag(text,sPos)&&!bahaRte.convertor.charPrevTag(text,sPos).inArray(prevTags)){text=bahaRte.utility.stringReplaceAt(text,sPos,"&nbsp;")}sPos++}sPos=0;while((sPos=text.indexOf("&nbsp;",sPos))!=-1){if(text.substr(sPos-6,6)!="&nbsp;"&&text.substr(sPos+6,6)!="&nbsp;"){text=text.substr(0,sPos)+" "+text.substr(sPos+6);sPos++}else{sPos+=6}}text=text.replace(/\[div([^\]]*?)\] \[\/div\]/g,"[div$1]&nbsp;[/div]");sPos=0;while((sPos=text.indexOf("\n",sPos))!=-1){if(bahaRte.convertor.charInTag(text,sPos)){text=bahaRte.utility.stringReplaceAt(text,sPos,"")}else if(!bahaRte.convertor.charPrevTag(text,sPos).inArray(prevTags)&&!bahaRte.convertor.charNextTag(text,sPos).inArray(nextTags)){text=bahaRte.utility.stringReplaceAt(text,sPos,"<br />")}sPos++}return text},toHtml:function(text){if(text===""){return"<br />"}text=text.replace(/</g,"&lt;").replace(/>/g,"&gt;");text=text.replace(/\r\n/g,"\n");text=bahaRte.convertor.parseReturnAndSpace(text);text=text.replace(/\[(center|right|left)\]/gi,'<div style="text-align:$1;">');text=text.replace(/\[url=(https?:\/\/[^\]'"]+)\]/gi,function($0,$1){return'<a href="'+encodeURI($1)+'">'});text=text.replace(/\[color=([a-z]{1,20})\]/gi,'<font style="color:$1;">');text=text.replace(/\[color=(#?[a-z0-9]{6})\]/gi,'<font style="color:$1;">');text=text.replace(/\[bgcolor=([a-z]{1,20})\]/gi,'<font style="background-color:$1;">');text=text.replace(/\[bgcolor=(#?[a-z0-9]{6})\]/gi,'<font style="background-color:$1;">');text=text.replace(/\[em=([1-9][0-9]?)(?:(?:\s+\w+=[#]?\w+)+)?\]/gi,'<img src="'+bahaRte.constants.emotionUrl+'$1.gif" />');text=text.replace(/\[s=([0-9]+)_([0-9]+)(?:(?:\s+\w+=[#]?\w+)+)?\]/gi,'<img src="'+bahaRte.constants.stickerUrl+'$1/$2.png" />');text=text.replace(/\[wiki=(?:([0-9]+)\:)?([^\]]+?)\]/gi,function($0,$1,$2){var wikiSn=$1||bahaRte.config.wikiNamespace.split(":",2)[0];if(bahaRte.config.service=="guildwiki"){return'<a class="wiki" href="http://guild.gamer.com.tw/wiki.php?sn='+wikiSn+"&n="+encodeURI($2)+'">'}var url=wikiSn+":"+encodeURI($2);return'<a class="wiki" href="'+bahaRte.constants.serviceUrl.wiki+url+'">'});text=text.replace(/\[font=([^\]]+)\]/gi,function($0,$1){var allowFonts=bahaRte.utility.createMap(bahaRte.constants.allowFontName);return allowFonts[$1]?'<font face="'+$1+'">':""});text=text.replace(/\[size=([1-7])\]/gi,'<font size="$1">');text=text.replace(/\[img=(https?:\/\/[^\]'"]+?\.(?:jpg|jpeg|gif|png))(?:\?[^\? ]*)?((?:\s+\w+=[#]?\w+)+)?\]/gi,function($0,$1,$2){var imgSrc=Util.HttpImgFilter.forceToHttps($1)||$1;var ret='<img src="'+encodeURI(imgSrc)+'"';if($2){var ary=$2.split(/\s+/);for(var i=0;i<ary.length;i++){if(ary[i].trim()===""){continue}var aryAttr=ary[i].split("=");var name=aryAttr[0].trim().toLowerCase();var value=aryAttr[1].trim();if((name=="width"||name=="height")&&value.match(/^[1-9][0-9]{0,2}$/)){ret+=" "+name+'="'+value+'"'}if(name=="thumbnail"){ret+=' data-thumbnail="yes"'}}}return ret+">"});text=text.replace(/\[img=(https?:\/\/link\.photo\.pchome\.com\.tw\/s[0-9]{1,3}\/[a-zA-Z0-9\_]{4,16}\/[0-9]{1,4}\/[0-9]{10,15}\/)((?:\s+\w+=[#]?\w+)+)?\]/gi,function($0,$1,$2){var ret='<img src="'+$1+'"';if($2){var ary=$2.split(/\s+/);for(var i=0;i<ary.length;i++){if(ary[i].trim()===""){continue}var aryAttr=ary[i].split("=");var name=aryAttr[0].trim().toLowerCase();var value=aryAttr[1].trim();if((name=="width"||name=="height")&&value.match(/^[1-9][0-9]{0,2}$/)){ret+=" "+name+'="'+value+'"'}if(name=="thumbnail"){ret+=' data-thumbnail="yes"'}}}return ret+">"});text=text.replace(/\[movie=(https?:\/\/[^\s\]'"]+?\/[^\]'"]*?)((?:\s+\w+=[#]?\w+)+)?\]/gi,function($0,$1,$2){var data=bahaRte.constants.movieData;var flag=false,site,i;for(site in data.url){if($1.match(data.url[site])){flag=true;break}}if(!flag){return""}var ret='<img data-movie="'+encodeURI($1)+'" src="'+bahaRte.constants.movieImgUrl+'"';if($2){var ary=$2.split(/\s+/);for(i=0;i<ary.length;i++){if(ary[i].trim()===""){continue}var aryAttr=ary[i].split("=");var name=aryAttr[0].trim().toLowerCase();var value=aryAttr[1].trim();if((name=="width"||name=="height")&&value.match(/^[1-9][0-9]{0,2}$/)){if(parseInt(value,10)>data.defaultSize.max[name.substring(0,1)]){value=data.defaultSize.max[name.substring(0,1)]}ret+=" "+name+'="'+value+'"'}if(name=="thumbnail"){ret+=' data-thumbnail="yes"'}}}else{ret+=' width="'+data.defaultSize[site].w+'" height="'+data.defaultSize[site].h+'"'}return ret+" />"});text=text.replace(/\[(table|tr|td|th|p|div)((?:\s+\w+=[#]?\w+[%]?)+)?\]/gi,function($0,$1,$2){if($1=="p"){$1="div"}var ret="<"+$1;if($2){var ary=$2.split(/\s+/);var styles="";for(var i=0;i<ary.length;i++){if(ary[i].trim()===""){continue}var aryAttr=ary[i].split("=");var name=aryAttr[0].trim().toLowerCase();var value=aryAttr[1].trim();if((name=="width"||name=="height")&&value.match(/^[1-9][0-9]{0,2}[%]?$/)){if($1.equals("p")||$1.equals("div")){styles+=name+":"+value+(value.indexOf("%")==-1?"px;":"")}else{if(!(name=="width"&&$1.equals("table")&&parseInt(value,10)>650)){ret+=" "+name+'="'+value+'"'}}}else if(name=="bgcolor"&&value.match(/^(?:[a-zA-Z]{3,20}|#[0-9A-Fa-f]{6})$/)){if(($1.equals("td")||$1.equals("th"))&&value=="unset"){styles+="background-color:unset;"}else if($1.equals("p")||$1.equals("div")){styles+="background-color:"+value+";"}else{ret+=" "+name+'="'+value+'"'}}else if(name=="border"&&value.match(/^[0-5]{1}$/)){ret+=" "+name+'="'+value+'"'}else if((name=="cellspacing"||name=="cellpadding")&&value.match(/^[0-9]{1}$/)){ret+=" "+name+'="'+value+'"'}else if(name=="align"&&value.match(/^(center|left|right|justify|char)$/i)){if($1.equals("table")){ret+=" "+name+'="'+value+'"'}else if(egg.browser.webkit){styles="text-align: "+value+";"}else{ret+=" "+name+'="'+value+'"'}}else if(name=="valign"&&value.match(/^(top|middle|bottom|baseline)$/i)){ret+=" "+name+'="'+value+'"'}else if((name=="rowspan"||name=="colspan")&&value.match(/^[1-9][0-9]{0,2}$/)){ret+=" "+name+'="'+value+'"'}else if(name=="tab"&&value.match(/^[1-9][0-9]?$/)&&parseInt(value,10)<10){styles+="margin-left:"+parseInt(value,10)*40+"px;"}}if(styles!==""){ret+=' style="'+styles+'"'}}return ret+">"});var bahaTag=["b","i","u","s","h1","h2","h3","h4","font","color","bgcolor","size","center","left","right","hr","url","img","movie","em","ol","ul","li","table","tr","td","tbody","th","tab","p","div","wiki"];var htmlTag=["b","i","u","strike","h1","h2","h3","h4","font","font","font","font","div","div","div","hr","a","img","?","img","ol","ul","li","table","tr","td","tbody","th","blockquote","div","div","a"];for(i=0;i<bahaTag.length;i++){regExp=new RegExp("\\["+bahaTag[i]+"\\]","gi");text=text.replace(regExp,"<"+htmlTag[i]+">");regExp=new RegExp("\\[\\/"+bahaTag[i]+"\\]","gi");text=text.replace(regExp,"</"+htmlTag[i]+">")}text=text.replace(/\[acg\]([^\[]+?)\[\/acg\]/gi,function($0,$1){var url=$1.replace(/<[^>]*>/g,"");var acg='<a class="acg" href="http://acg.gamer.com.tw/search.php?encode=utf8&kw='+encodeURI(url)+'">'+$1+"</a>";return acg});if(egg.browser.firefox||$.browser.ie11){text=text.replace(/(<t[dh]>)[\n ]*?(<\/t[dh]>)/gi,"$1&nbsp;$2")}return text},removeEmptyTag:function(node){var dontRemoveTag=$.browser.ie||$.browser.webkit||$.browser.ie11?["td","th","div","p","body"]:["td","th","body"];if(node.childNodes.length===0&&node.nodeType==bahaRte.constants.nodeType.ELEMENT_NODE&&!node.nodeName.inArray(["area","base","basefont","br","col","frame","hr","img","input","isindex","link","meta","param","embed"],true)&&!node.nodeName.inArray(dontRemoveTag,true)){var pNode=node.parentNode;pNode.removeChild(node);bahaRte.convertor.removeEmptyTag(pNode);return true}else if(node.hasChildNodes()){for(var i=0;i<node.childNodes.length;i++){if(bahaRte.convertor.removeEmptyTag(node.childNodes[i])){i--}}}return false},toText:function(html){bahaRte.convertor.removeEmptyTag(bahaRte.doc.body);if(!bahaRte.doc.body){html=""}else{html=bahaRte.doc.body.innerHTML}var result="";var endTagStack=[];var emptyTagList=["area","base","basefont","br","col","frame","hr","img","input","isindex","link","meta","param","embed"];var emptyTags=bahaRte.utility.createMap(emptyTagList);html=html.replace(/[\x00-\x1f\x7f-\x9f\u00a0\u00ad\u0600-\u0604\u061c\u070f\u17b4\u17b5\u180e\u2002-\u200c\u200e\u200f\u2028-\u202f\u205f\u2060-\u206f\ufeff\ufff0-\uffff]/g,"");html=html.replace(/\r\n|\r|\n/g,"");html=html.replace(/\[/g,"&#91;").replace(/\]/g,"&#93;");HTMLParser(html,{start:function(tag,attrs,unary){tag=tag.toLowerCase();var isEmpty=emptyTags[tag];if(tag=="br"){result+="\n"}else{var bahaTags;if(tag.inArray(["img","td","th","tr","table","p","div"],true)){bahaTags=bahaRte.convertor.getBahaTagsWithAttr(tag,attrs,isEmpty)}else{bahaTags=bahaRte.convertor.getBahaTags(tag,attrs,isEmpty)}if(bahaTags.startTags!==""){result+=bahaTags.startTags}if(bahaTags.endTags===""&&!isEmpty){endTagStack.push(false)}else if(bahaTags.endTags!==""){endTagStack.push(bahaTags.endTags)}}if(tag.inArray(["table","tr","ol","ul"],true)){result+="\n"}},end:function(tag){tag=tag.toLowerCase();if(emptyTags[tag]){return}var value=endTagStack.pop();if(value!==false){result+=value}if(tag.inArray(["th","td","tr","li"],true)){result+="\n"}},chars:function(str){result+=str},commnet:function(str){}});result=result.replace(/\&[^;]+;/g,function($0){var entityMap=bahaRte.utility.createMap(bahaRte.constants.entityCode.code,bahaRte.constants.entityCode.value);return entityMap[$0]||$0});return result},getBahaTagsWithAttr:function(htmlTag,attrs,isEmpty){var flag=false,attribute="";var startTags="",endTags="",tabs="",colors="";var movie="",matches,i,color;if(htmlTag=="p"){htmlTag="div"}for(i=0;i<attrs.length;i++){attrs[i].value=attrs[i].value.trim();attrs[i].name=attrs[i].name.trim().toLowerCase();switch(attrs[i].name){case"src":if(attrs[i].value.trim().toLowerCase().indexOf("images/")===0){attrs[i].value=location.href.substring(0,location.href.lastIndexOf("/")+1)+attrs[i].value}var imgMatches;if((imgMatches=attrs[i].value.trim().match(/(^http[s]?:\/\/(?:.*?)\/(?:.*)\.(?:jpg|jpeg|gif|png))(?:\?[^\?]*)?$/i))||attrs[i].value.trim().match(/^https?:\/\/link\.photo\.pchome\.com\.tw\/s[0-9]{1,3}\/[a-zA-Z0-9\_]{4,16}\/[0-9]{1,4}\/[0-9]{10,15}\/$/i)){if(htmlTag=="img"){var regexpEmoticon=new RegExp(bahaRte.constants.emotionUrl+"([1-9][0-9]?).gif");var regexpSticker=new RegExp(bahaRte.constants.stickerUrl+"([0-9]+)/([0-9]+).png");if(matches=attrs[i].value.match(regexpEmoticon)){attribute="="+matches[1]+attribute;htmlTag="em"}else if(matches=attrs[i].value.match(regexpSticker)){attribute="="+matches[1]+"_"+matches[2]+attribute;htmlTag="s"}else{var imgUrl;if(imgMatches){imgUrl=imgMatches[1]}else{imgUrl=attrs[i].value}attribute="="+imgUrl+attribute;flag=true}}}break;case"data-movie":if(htmlTag=="img"){movie=attrs[i].value}break;case"width":case"height":if(attrs[i].value.match(/^[1-9][0-9]{0,2}[%]?$/)){attribute+=" "+attrs[i].name+"="+attrs[i].value}break;case"cellspacing":case"cellpadding":if(attrs[i].value.match(/^[0-9]$/)){attribute+=" "+attrs[i].name+"="+attrs[i].value}break;case"style":var data=bahaRte.convertor.parseStyle(attrs[i].value,htmlTag,true);if(data.attribute.match(/bgcolor/i)){attribute=attribute.replace(/ bgcolor=[^ ]+/i,"")}attribute+=data.attribute;startTags+=data.startTags;endTags=data.endTags+endTags;break;case"bgcolor":if((htmlTag=="td"||htmlTag=="th"||htmlTag=="tr")&&attrs[i].value.match(/^(?:[a-zA-Z]{3,20}|#[0-9A-Fa-f]{6})$/)&&!attribute.match(/bgcolor/i)){attribute+=" bgcolor="+attrs[i].value}break;case"border":if(htmlTag=="table"&&attrs[i].value.match(/^[0-5]{1}$/)){attribute+=" border="+attrs[i].value}break;case"align":case"valign":var pattern;if(attrs[i].name=="align"){if(attrs[i].value.equals("middle")){attrs[i].value="center"}pattern=/^(center|left|right|justify|char)$/i}else{if(attrs[i].value.equals("center")){attrs[i].value="middle"}pattern=/^(top|middle|bottom|baseline)$/i}matches=attrs[i].value.trim().toLowerCase().match(pattern);if(matches&&htmlTag.inArray(bahaRte.constants.allowAlignTag)){attribute+=" "+attrs[i].name+"="+attrs[i].value}break;case"rowspan":case"colspan":if(attrs[i].value.trim().match(/^[1-9][0-9]{0,2}$/)&&(htmlTag=="td"||htmlTag=="th")){attribute+=" "+attrs[i].name+"="+attrs[i].value}break;case"data-thumbnail":attribute+=" thumbnail=yes";break;default:}}if(movie!==""){attribute=attribute.replace("="+bahaRte.constants.movieImgUrl,"="+movie);htmlTag="movie"}if(htmlTag!="img"||htmlTag=="img"&&flag){startTags="["+htmlTag+attribute+"]"+startTags}endTags+=!isEmpty&&startTags!==""?"[/"+htmlTag+"]":"";return{startTags:startTags,endTags:endTags}},getBahaTags:function(htmlTag,attrs,isEmpty){var startTags="",endTags="",matches;var htmlTagList=["strike","del","blockquote","strong","big","em","dfn","var","cite","ins"];var textTagList=["s","s","tab","b","b","i","i","i","i","u"];var transformTags=bahaRte.utility.createMap(htmlTagList,textTagList);htmlTag=transformTags[htmlTag]||htmlTag;var keepTagList=["b","i","u","s","tab","center","h1","h2","h3","h4","hr","li","ul","ol","table","td","tr","th","div","p"];var keepTags=bahaRte.utility.createMap(keepTagList);var isKeepTag=keepTags[htmlTag];if(isKeepTag){startTags+="["+htmlTag+"]"}if(!isEmpty&&isKeepTag){endTags+="[/"+htmlTag+"]"}for(var i=0;i<attrs.length;i++){switch(attrs[i].name){case"href":if(htmlTag=="a"){try{attrs[i].value=decodeURI(attrs[i].value)}catch(e){}attrs[i].value=attrs[i].value.replace(/\&amp;/g,"&");if(attrs[i].value.match(bahaRte.constants.serviceUrl.acgPattern)){startTags+="[acg]";endTags="[/acg]"+endTags}else if((matches=attrs[i].value.match(bahaRte.constants.serviceUrl.wikiUrlPattern))&&bahaRte.config.service=="wiki"){startTags+="[wiki="+matches[1]+":"+matches[2]+"]";endTags="[/wiki]"+endTags}else if((matches=attrs[i].value.match(bahaRte.constants.serviceUrl.guildWikiUrlPattern))&&bahaRte.config.service=="guildwiki"){startTags+="[wiki="+matches[1]+":"+matches[2]+"]";endTags="[/wiki]"+endTags}else if(matches=attrs[i].value.trim().match(/^javascript:confirmLink\('(http[s]?:\/\/[\S]+?)'\)[;]?$/)){startTags+="[url="+matches[1]+"]";endTags="[/url]"+endTags}else if(attrs[i].value.trim().match(/^http[s]?:\/\/.+?$/)){startTags+="[url="+attrs[i].value+"]";endTags="[/url]"+endTags}}break;case"color":var color=bahaRte.utility.switchColor(attrs[i].value);if(color!==""&&htmlTag=="font"){startTags+="[color="+color+"]";endTags="[/color]"+endTags}break;case"face":var fonts=attrs[i].value.replace(/'/g,"").split(/,/);var allowFonts=bahaRte.utility.createMap(bahaRte.constants.allowFontName);if(htmlTag=="font"&&fonts.length>0&&allowFonts[fonts[0]]){startTags+="[font="+fonts[0]+"]";endTags="[/font]"+endTags}break;case"size":var fValue=bahaRte.constants.allowFontSize.fontValue;if(htmlTag=="font"&&attrs[i].value.match(/^[1-7]$/)){startTags+="[size="+attrs[i].value+"]";endTags="[/size]"+endTags}break;case"align":matches=attrs[i].value.trim().toLowerCase().match(/^(left|center|right)$/i);var allowTags=bahaRte.utility.createMap(bahaRte.constants.allowAlignTag);if(matches&&allowTags[htmlTag]){startTags+="["+matches[1]+"]";endTags="[/"+matches[1]+"]"+endTags}break;case"style":if(!isEmpty){var tags=bahaRte.convertor.parseStyle(attrs[i].value,htmlTag,false);startTags+=tags.startTags;endTags=tags.endTags+endTags}break;default:}}return{startTags:startTags,endTags:endTags}},parseStyle:function(attr,tag,withAttr){var startTags="",endTags="",attribute="",matches;var aryStyle=attr.split(";");for(var j=0;j<aryStyle.length;j++){if(aryStyle[j].trim()===""){continue}var aryTmp=aryStyle[j].split(":");var name=aryTmp[0].trim().toLowerCase();if(!aryTmp[1]){continue}var valueAll=aryTmp[1].trim().replace(/^["']([^"']+)["']$/,"$1");var value=valueAll.split(/\s+/);if(value.length===0){continue}switch(name){case"color":case"background-color":var bg=name=="color"?"":"bg";var color=bahaRte.utility.switchColor(valueAll);if(color!==""){if(name=="background-color"&&withAttr){attribute+=" bgcolor="+color}else if(!tag.inArray(["tr","tbody","table"])){startTags+="["+bg+"color="+color+"]";endTags="[/"+bg+"color]"+endTags}}break;case"font-family":var allowFonts=bahaRte.utility.createMap(bahaRte.constants.allowFontName);var fonts=valueAll.replace(/'/g,"").split(/,/);if(fonts.length>0&&allowFonts[fonts[0]]){startTags+="[font="+fonts[0]+"]";endTags="[/font]"+endTags}break;case"font-size":var afs=bahaRte.constants.allowFontSize;var fontSizeMap=bahaRte.utility.createMap(afs.size,afs.fontValue);startTags+="[size="+fontSizeMap[bahaRte.utility.switchSize(value[0])]+"]";endTags="[/size]"+endTags;break;case"font-weight":if(value[0].toLowerCase()=="bold"){startTags+="[b]";endTags="[/b]"+endTags}break;case"font-style":var fsAry=bahaRte.utility.createMap(value);if(fsAry["italic"]||fsAry["oblique"]){startTags+="[i]";endTags="[/i]"+endTags}break;case"text-decoration":var tdAry=bahaRte.utility.createMap(value);if(tdAry["line-through"]){startTags+="[s]";endTags="[/s]"+endTags}if(tdAry["underline"]){startTags+="[u]";endTags="[/u]"+endTags}break;case"margin-left":matches=[];if(matches=value[0].match(/([0-9]{1,3})px/i)){var times=Math.ceil(parseInt(matches[1],10)/40);if(tag=="div"){attribute+=" tab="+times}else{for(var i=0;i<times;i++){startTags+="[tab]";endTags="[/tab]"+endTags}}}break;case"text-align":matches=value[0].trim().toLowerCase().match(/(left|center|right)/i);var allowTags=bahaRte.utility.createMap(bahaRte.constants.allowAlignTag);if(matches&&allowTags[tag]){if(withAttr){attribute+=" align="+matches[1]}else{startTags+="["+matches[1]+"]";endTags="[/"+matches[1]+"]"+endTags}}break;case"vertical-align":matches=value[0].trim().toLowerCase().match(/(top|middle|bottom)/i);var allowTags=bahaRte.utility.createMap(bahaRte.constants.allowAlignTag);if(matches&&allowTags[tag]&&withAttr){attribute+=" valign="+matches[1]}break;case"width":case"height":var size=bahaRte.utility.switchSize(valueAll,true);if(size!==""&&withAttr){attribute+=" "+name+"="+size}break;default:}}return{startTags:startTags,endTags:endTags,attribute:attribute}}},toolbar:{bold:{id:"_bhrte_bold",name:"bold",tooltip:"粗體",disabled:false},italic:{id:"_bhrte_italic",name:"italic",tooltip:"斜體",disabled:false},underline:{id:"_bhrte_underline",name:"underline",tooltip:"底線",disabled:false},strike:{id:"_bhrte_strikethrough",name:"strike",tooltip:"刪除線",disabled:false},heading:{id:"_bhrte_heading",name:"heading",tooltip:"標題",disabled:false},indent:{id:"_bhrte_indent",name:"indent",tooltip:"縮排",disabled:false},outdent:{id:"_bhrte_outdent",name:"outdent",tooltip:"刪除縮排",disabled:false},link:{id:"_bhrte_createlink",name:"link",tooltip:"建立/刪除連結",disabled:false},image:{id:"_bhrte_insertimage",name:"image",tooltip:"引用圖片",disabled:false},hr:{id:"_bhrte_inserthorizontalrule",name:"hr",tooltip:"水平線",disabled:false},orderedList:{id:"_bhrte_insertorderedlist",name:"orderedList",tooltip:"項目編號",disabled:false},unorderedList:{id:"_bhrte_insertunorderedlist",name:"unorderedList",tooltip:"項目符號",disabled:false},center:{id:"_bhrte_justifycenter",name:"center",tooltip:"置中",disabled:false},left:{id:"_bhrte_justifyleft",name:"left",tooltip:"靠左對齊",disabled:false},right:{id:"_bhrte_justifyright",name:"right",tooltip:"靠右對齊",disabled:false},wiki:{id:"_bhrte_wiki",name:"wiki",tooltip:"連結本百科項目",disabled:false},acg:{id:"_bhrte_acg",name:"acg",tooltip:"連結作品介紹",disabled:false},bgColor:{id:"_bhrte_bgcolor",name:"bgColor",tooltip:"背景顏色",disabled:false},foreColor:{id:"_bhrte_forecolor",name:"foreColor",tooltip:"文字顏色",disabled:false},removeFormat:{id:"_bhrte_removeformat",name:"removeFormat",tooltip:"清除文字效果",disabled:false},table:{id:"_bhrte_table",name:"table",tooltip:"建立表格",disabled:false},movie:{id:"_bhrte_movie",name:"movie",tooltip:"插入/編輯影片",disabled:false},emotion:{id:"_bhrte_emotion",name:"emotion",tooltip:"插入表情圖片",disabled:false},font:{id:"_bhrte_font",name:"font",tooltip:"字型",disabled:false},size:{id:"_bhrte_size",name:"size",tooltip:"字體大小",disabled:false},refresh:{id:"_bhrte_refresh",name:"refresh",tooltip:"內文若有不支援的語法，送出後將不會保留\n此功能會將內容更新，只留下支援的語法。",disabled:false},copyFormat:{id:"_bhrte_copyformat",name:"copyFormat",tooltip:"複製格式",disabled:false},undo:{id:"_bhrte_undo",name:"undo",tooltip:"復原",disabled:false},redo:{id:"_bhrte_redo",name:"redo",tooltip:"重做",disabled:false},uploadImage:{id:"_bhrte_uploadimage",name:"uploadImage",tooltip:"上傳 / 引用圖片",disabled:false},quoteImage:{id:"_bhrte_quoteimage",name:"quoteImage",tooltip:"引用已上傳圖片",disabled:true},removeAll:{id:"_bhrte_removeall",name:"removeAll",tooltip:"全文變成純文字",disabled:false},divide:{id:"_bhrte_divide"},newline:{id:"_bhrte_newline"},imageForWiki:{id:"_bhrte_imageforwiki",name:"imageForWiki",tooltip:"引用已上傳圖片",disabled:false},imageForGuildWiki:{id:"_bhrte_imageforguildwiki",name:"imageForGuildWiki",tooltip:"引用已上傳圖片",disabled:false},uploadImageForWiki:{id:"_bhrte_uploadimageforwiki",name:"uploadImageForWiki",tooltip:"上傳新圖片",disabled:false},uploadImageForGuildWiki:{id:"_bhrte_uploadimageforguildwiki",name:"uploadImageForGuildWiki",tooltip:"上傳新圖片",disabled:false},enableButton:function(btnList,enable){if(!btnList){btnList=bahaRte.config.buttonList.button}var style,fdrpdn,bdrpdn,target;for(var i in btnList){var id=btnList[i].id.substring(7);var btn=document.getElementById(btnList[i].id);var cursor=bahaRte.utility.cursor;if(enable){btnList[i].disabled=!(enable=="yes")}if(id.inArray(["divide","newline"])||!btn){continue}if(id=="font"){style=btnList[i].disabled?"solid 1px #cccccc":"solid 1px skyblue";document.getElementById("_bhrte_fonttable").style.border=style;document.getElementById("_bhrte_fontlabel").style.color=btnList[i].disabled?"#cccccc":"black"}else if(id=="heading"){style=btnList[i].disabled?"#cccccc":"black";document.getElementById("_bhrte_headingtable").style.color=style}else{style=btnList[i].disabled?"disabled/":"";btn.style.backgroundImage="url("+bahaRte.constants.editorImgUrl+style+id+".gif)"}if(btnList[i].disabled){switch(id){case"font":$("#_bhrte_fontlabel").removeEvent("mouseover",bahaRte.toolbar.buttonHover).removeEvent("mouseout",bahaRte.toolbar.buttonOut).css("cursor","default");break;case"heading":$("#_bhrte_headinglabel").removeEvent("mouseover",bahaRte.toolbar.buttonHover).removeEvent("mouseout",bahaRte.toolbar.buttonOut);$("#_bhrte_headingtd").css("cursor","default");break;default:if(id=="forecolor"){$("#_bhrte_forecolordropdown").removeEvent("mouseover",bahaRte.toolbar.buttonHover).removeEvent("mouseout",bahaRte.toolbar.buttonOut).css("cursor","default")}if(id=="bgcolor"){$("#_bhrte_bgcolordropdown").removeEvent("mouseover",bahaRte.toolbar.buttonHover).removeEvent("mouseout",bahaRte.toolbar.buttonOut).css("cursor","default")}$(btn).removeEvent("mouseover",bahaRte.toolbar.buttonHover).removeEvent("mouseout",bahaRte.toolbar.buttonOut).css("cursor","default")}}else{switch(id){case"font":$("#_bhrte_fontlabel").addEvent("mouseover",bahaRte.toolbar.buttonHover).addEvent("mouseout",bahaRte.toolbar.buttonOut).css("cursor",cursor);break;case"heading":$("#_bhrte_headinglabel").addEvent("mouseover",bahaRte.toolbar.buttonHover).addEvent("mouseout",bahaRte.toolbar.buttonOut).css("cursor",cursor);$("#_bhrte_headingtd").css("cursor",cursor);break;default:if(id=="forecolor"){$("#_bhrte_forecolordropdown").addEvent("mouseover",bahaRte.toolbar.buttonHover).addEvent("mouseout",bahaRte.toolbar.buttonOut).css("cursor",cursor)}if(id=="bgcolor"){$("#_bhrte_bgcolordropdown").addEvent("mouseover",bahaRte.toolbar.buttonHover).addEvent("mouseout",bahaRte.toolbar.buttonOut).css("cursor",cursor)}$(btn).addEvent("mouseover",bahaRte.toolbar.buttonHover).addEvent("mouseout",bahaRte.toolbar.buttonOut).css("cursor",cursor)}}}},getButtonLayout:function(button){var ret="";var cursor=bahaRte.utility.cursor;var img=bahaRte.constants.editorImgUrl;var mouseDown="javascript:bahaRte.toolbar.buttonClick(event,document.getElementById('"+button.id+"'),'"+button.name+"');";switch(button.id.substring(7)){case"divide":ret='<td width="1"><img src="'+img+'divide.gif"></td>';break;case"newline":ret='</tr></table><table cellpadding="0" cellspacing="4" border="0" width="100%" style="border-spacing: 4px;"><tr>';break;case"font":ret='<td width="110" class="bahaRte_btn_out" style="cursor:'+cursor+';" id="'+button.id+'" title="'+button.tooltip+'" onmousedown="'+mouseDown+'">';ret+='  <table cellpadding="0" cellspacing="2" id="'+button.id+'table" style="border:solid 1px skyblue;">';ret+='    <tr id="'+button.id+'">';ret+='      <td id="'+button.id+'">';ret+='        <div id="'+button.id+'label" class="bahaRte_btn_out" style="width:95px;height:16px;overflow:hidden;">Arial</div>';ret+="      </td>";ret+='      <td style="padding-right:2px;" width="6" id="'+button.id+'">';ret+='        <img id="'+button.id+'" src="'+img+'triangle2.gif">';ret+="      </td>";ret+="    </tr>";ret+="  </table>";ret+="</td>";break;case"heading":ret='<td width="50" style="cursor:'+cursor+';" id="'+button.id+'td" title="'+button.tooltip+'" onmousedown="'+mouseDown+'">';ret+='  <table id="'+button.id+'table">';ret+='    <tr id="'+button.id+'">';ret+='      <td id="'+button.id+'label" class="bahaRte_btn_out" width="30">標題</td>';ret+='      <td id="'+button.id+'" width="6">';ret+='        <img id="'+button.id+'" src="'+img+'triangle2.gif">';ret+="      </td>";ret+="    </tr>";ret+="  </table>";ret+="</td>";break;case"refresh":ret='<td width="50" class="bahaRte_btn_out" onmousedown="'+mouseDown+'" onmouseover="javascript:bahaRte.toolbar.buttonHover(event);" onmouseout="javascript:bahaRte.toolbar.buttonOut(event);" align="center" style="cursor:'+cursor+";background-image:url("+img+'bg3.gif);border:solid 1px black;" title="'+button.tooltip+'" id="_bhrte_refresh">';ret+='  <img id="img_bhrte_refresh" src="'+img+'refresh.gif"> 更新';ret+="</td>";break;case"forecolor":case"bgcolor":var fgcolor,bgcolor;if(fgcolor=document.getElementById("now_bhrte_forecolor")){fgcolor=fgcolor.style.backgroundColor}else{fgcolor="#464646"}if(bgcolor=document.getElementById("now_bhrte_bgcolor")){bgcolor=bgcolor.style.backgroundColor}else{bgcolor="white"}ret='<td width="34" style="cursor:'+cursor+';" title="'+button.tooltip+'">';ret+='  <table cellspacing="0" cellpadding="0" height="28">';ret+="    <tr>";ret+='      <td onmousedown="'+mouseDown+'" id="'+button.id+'" class="bahaRte_btn_out" width="24" align="center" style="background-image:url('+img+button.id.substring(7)+'.gif);background-position:center 5px;background-repeat:no-repeat;">';ret+='        <div id="now'+button.id+'" style="position:relative;font-size:2px;width:16px;height:3px;background-color:'+(button.id=="_bhrte_forecolor"?fgcolor:bgcolor)+';"></div>';ret+="      </td>";ret+='      <td width="10" onmousedown="javascript:bahaRte.toolbar.buttonClick(event,document.getElementById(\''+button.id+"dropdown'),'"+button.name+'\');" id="'+button.id+'dropdown" class="bahaRte_btn_out" style="background-image:url('+img+'triangle2.gif);background-position:center center;background-repeat:no-repeat;">&nbsp;&nbsp;</td>';ret+="    </tr>";ret+="  </table>";ret+="</td>";break;default:ret='<td width="24" height="24" valign="top" class="bahaRte_btn_out" style="background-image:url('+img+button.id.substring(7)+".gif);background-position:center center;background-repeat:no-repeat;cursor:"+cursor+';" id="'+button.id+'" title="'+button.tooltip+'" onmousedown="'+mouseDown+'">&nbsp;</td>'}return ret},buttonOut:function(evt){var target=window.event?window.event.srcElement:evt.target;if(target.id.inArray(["now_bhrte_forecolor","now_bhrte_bgcolor","img_bhrte_refresh"])){target=document.getElementById(target.id.substring(3))}target.className=bahaRte.previousStyle||"bahaRte_btn_out";bahaRte.previousStyle=null},buttonHover:function(evt){var target=window.event?window.event.srcElement:evt.target;if(target.id.inArray(["now_bhrte_forecolor","now_bhrte_bgcolor","img_bhrte_refresh"])){target=document.getElementById(target.id.substring(3))}bahaRte.previousStyle=target.className;target.className="bahaRte_btn_over"},buttonClick:function(evt,button){var status={state:0};var id=jQuery(button).data("id");bahaRte.panel.destroyPopupPanel();try{document.body.removeChild(document.getElementById("bhrte_tip"));document.body.removeChild(document.getElementById("bhrte_tipmask"))}catch(e){}if(bahaRte.isPlainText){bahaRte.source.focus()}else{bahaRte.win.focus()}if($.browser.ie||$.browser.ie11){bahaRte.previousSel=bahaRte.selection.getRange()}switch(id.substring(7)){case"heading":case"emotion":case"font":case"bgcolordropdown":case"forecolordropdown":case"size":break;case"forecolor":case"bgcolor":var color=jQuery('[data-id="now'+id+'"]');if(color.length){color=color.get(0);var c=color.style.fill.match(/rgb\((\d+), (\d+), (\d+)\)/);var rgbTohexC;if(c){var h1=parseInt(c[1]).toString(16);h1=h1.length==1?"0"+h1:h1;var h2=parseInt(c[2]).toString(16);h2=h2.length==1?"0"+h2:h2;var h3=parseInt(c[3]).toString(16);h3=h3.length==1?"0"+h3:h3;rgbToHexC="#"+h1+h2+h3}else{rgbToHexC=color.style.fill}if(id=="_bhrte_forecolor"){bahaRte.toolbar.setForeColor(rgbToHexC)}else{bahaRte.toolbar.setBackgroundColor(rgbToHexC)}}break;case"insertimage":case"createlink":case"table":case"movie":case"uploadimage":case"uploadimageforwiki":case"imageforwiki":case"uploadimageforguildwiki":case"imageforguildwiki":case"wiki":bahaRte.dialog.popupDialog(evt);break;case"acg":bahaRte.toolbar.createAcgLink(evt);break;case"copyformat":bahaRte.toolbar.copyFormatAction(evt);break;case"refresh":bahaRte.toolbar.refreshContent(evt);break;case"removeall":bahaRte.toolbar.removeAllFormat(evt);break;case"chbtn":bahaRte.toolbar.switchButton(evt);break;case"undo":if($.browser.ie){bahaRte.undo.undo()}else{bahaRte.toolbar.command(evt,id.substring(7))}break;case"redo":if($.browser.ie){bahaRte.undo.redo()}else{bahaRte.toolbar.command(evt,id.substring(7))}break;default:bahaRte.toolbar.command(evt,id.substring(7));if(!bahaRte.isPlainText&&id.substring(7).inArray(["justifyleft","justifycenter","justifyright","insertorderedlist","insertunorderedlist"])){status=bahaRte.utility.getTagStatus()}if(id.substring(7).inArray(["bold","italic","underline","strikethrough"])){jQuery('[data-id="'+id+'"]').toggleClass("is-active")}}bahaRte.utility.keepSelection(evt)},removeAllFormat:function(evt){if(bahaRte.isPlainText){return}bahaRte.undo.backup();var html=bahaRte.doc.body.innerHTML;html=html.replace(/<([\/]?[^> ]+)[^>]*>/g,function($0,$1){var dontRemoveTags=["br","div","p","/div","/p","table","/table","th","/th","td","/td","tr","/tr","ol","/ol","ul","/ul","li","/li"];if($1.inArray(dontRemoveTags,true)){return"<"+$1+">"}return""});bahaRte.doc.body.innerHTML=html},copyFormatAction:function(evt){if(bahaRte.isPlainText){return}bahaRte.doc.body.style.cursor="url("+bahaRte.constants.editorImgUrl+"copyformat.gif),auto";bahaRte.copiedState=bahaRte.utility.getTagStatus();bahaRte.selection.getRange().collapse();bahaRte.utility.showBalloonbar()},pasteFormatAction:function(){bahaRte.doc.body.style.cursor="url(),auto";var state=bahaRte.copiedState.state;var tagState=bahaRte.constants.tagState;if(!state||state===0){return}bahaRte.undo.backup();var nowState=bahaRte.utility.getTagStatus().state;if(state&tagState.BOLD&&!(nowState&tagState.BOLD)){bahaRte.doc.execCommand("bold",false,null)}if(state&tagState.ITALIC&&!(nowState&tagState.ITALIC)){bahaRte.doc.execCommand("italic",false,null)}if(state&tagState.UNDERLINE&&!(nowState&tagState.UNDERLINE)){bahaRte.doc.execCommand("underline",false,null)}if(state&tagState.STRIKE&&!(nowState&tagState.STRIKE)){bahaRte.doc.execCommand("strikethrough",false,null)}var color;if(state&tagState.FORECOLOR){color=bahaRte.copiedState.colorList;if(color.length>0){bahaRte.doc.execCommand("forecolor",false,color[0])}}if(state&tagState.BACKGROUNDCOLOR){var command=$.browser.ie?"backcolor":"hilitecolor";color=bahaRte.copiedState.bgcolorList;if(color.length>0){bahaRte.doc.execCommand(command,false,color[0])}}if(state&tagState.FONTNAME){var font=bahaRte.copiedState.fontList;if(font.length>0){bahaRte.doc.execCommand("fontname",false,font[0])}}if(state&tagState.FONTSIZE){var afs=bahaRte.constants.allowFontSize;var fontSizeMap=bahaRte.utility.createMap(afs.size,afs.fontValue);var size=bahaRte.copiedState.sizeList;if(size.length>0){bahaRte.doc.execCommand("fontsize",false,fontSizeMap[size[0]])}}bahaRte.copiedState={state:0}},insertEmotion:function(evt){bahaRte.undo.backup();var src=jQuery(evt.target).attr("src")||jQuery(evt.target).find("img").attr("src");var matches=src.match("([0-9]+).gif");var emoId=matches[1];if(bahaRte.isPlainText){bahaRte.utility.insertTextTag("[em="+emoId+"] ")}else{var text='<img src="'+bahaRte.constants.emotionUrl+emoId+'.gif" /> ';bahaRte.utility.insertHtml(text)}evt.preventDefault()},insertMovie:function(evt,movieValue){if($.browser.ie&&bahaRte.previousSel){bahaRte.previousSel.select()}if($.browser.ie11&&bahaRte.previousSel){var curSel=bahaRte.win.getSelection();curSel.removeAllRanges();curSel.addRange(bahaRte.previousSel)}var c=bahaRte.constants.movieData;movieValue=movieValue||document.getElementById("_bhrte_movieCode").value;var movie="";var width="",height="";var matches,flag=false,key;var paramAry,matches_y,movieArgs,i;for(key in c.code){if(matches=movieValue.match(c.code[key])){switch(key){case"wretch":width=matches[2];height=matches[3];break;case"xuite":width=matches[3];height=matches[4];break;case"nico":width=c.defaultSize.nico.w;height=c.defaultSize.nico.h;break;case"twitchChannel":case"twitchVideo":width=c.defaultSize.twitch.w;height=c.defaultSize.twitch.h;break;case"livehouse":width=c.defaultSize.livehouse.w;height=c.defaultSize.livehouse.h;break;case"facebook":width=c.defaultSize.facebook.w;height=c.defaultSize.facebook.h;break;default:width=matches[1];height=matches[2]}switch(key){case"youtube":case"newtube":movie=c.urlTemplate.youtube.replace("{MOVIE-ID}",matches[3]);paramAry=matches[4].replace(/\&amp;/,"&").split(/\&/);movieArgs="";for(i=0;i<paramAry.length;i++){if(paramAry[i].match(/hd=1/)){movieArgs+="&hd=1"}if(paramAry[i].match(/fs=1/)){movieArgs+="&fs=1"}if(matches_y=paramAry[i].match(/start=(\d+)/)){movieArgs+="&t="+matches_y[1]}if(paramAry[i].match(/rel=0/)){movieArgs+="&rel=0"}}if(movieArgs!==""){movie+=movieArgs}break;case"livehouse":movie=c.urlTemplate[key].replace("{MOVIE-ID}",matches[3]);break;case"xuite":movie=c.urlTemplate[key].replace("{MOVIE-ID}",matches[1]);movieArgs="";if(matches[2]){paramAry=matches[2].replace(/\&amp;/,"&").split(/\&/);for(i=0;i<paramAry.length;i++){if(paramAry[i].match(/as=1/)){movieArgs+="&as=1"}if(paramAry[i].match(/ar=1/)){movieArgs+="&ar=1"}if(matches_y=paramAry[i].match(/volume=(\d+)/)){movieArgs+="&volume="+matches_y[1]}}}if(movieArgs!==""){movie+="?"+movieArgs.substr(1)}break;case"nico":movie=c.urlTemplate["nico"].replace("{MOVIE-ID}",matches[1]);break;case"twitchChannel":movie=c.urlTemplate["twitch"].replace("{MOVIE-ID}",matches[2]);break;case"twitchVideo":movie=c.urlTemplate["twitch"].replace("{MOVIE-ID}","videos/"+matches[2]);break;case"facebook":movie=c.urlTemplate["facebook"].replace("{CHANNEL-ID}",matches[1]).replace("{MOVIE-ID}",matches[2]);break;case"soapbox":case"yam":case"yamMusic":case"wretch":Dialogify.alert("您輸入的影片網址或嵌入碼有誤, 或可能為本站不支援的網站");return;default:}flag=true;break}}for(key in c.url){if(matches=movieValue.match(c.url[key])){if(key==="twitchChannel"){width=c.defaultSize["twitch"].w;height=c.defaultSize["twitch"].h}else{width=c.defaultSize[key].w;height=c.defaultSize[key].h}switch(key){case"youtube":case"newtube":case"sharetube":case"shortstube":movie=c.urlTemplate["youtube"].replace("{MOVIE-ID}",matches[1]);movieArgs="";if(matches[2]){paramAry=matches[2].split(/\&|#|\&#/);for(i=0;i<paramAry.length;i++){if(paramAry[i].match(/hd=1/)){movieArgs+="&hd=1"}if(paramAry[i].match(/fs=1/)){movieArgs+="&fs=1"}if(paramAry[i].match(/fmt=(?:35|22)/)){movieArgs+="&hd=1"}if(matches_y=paramAry[i].match(/t=(\d+)/)){movieArgs+="&t="+matches_y[1]}if(paramAry[i].match(/rel=0/)){movieArgs+="&rel=0"}}}if(movieArgs!==""){movie+=movieArgs}break;case"livehouse":movie=c.urlTemplate[key].replace("{MOVIE-ID}",matches[1]);break;case"xuite":movie=c.urlTemplate[key].replace("{MOVIE-ID}",matches[1]);movieArgs="";if(matches[2]){paramAry=matches[2].split(/\&|#|\&#/);for(i=0;i<paramAry.length;i++){if(paramAry[i].match(/ar=1/)){movieArgs+="&ar=1"}if(paramAry[i].match(/as=1/)){movieArgs+="&as=1"}if(matches_y=paramAry[i].match(/volume=(\d+)/)){movieArgs+="&volume="+matches_y[1]}}}if(movieArgs!==""){movie+="?"+movieArgs.substr(1)}break;case"twitch":movie=c.urlTemplate["twitch"].replace("{MOVIE-ID}","videos/"+matches[1]);break;case"twitchChannel":movie=c.urlTemplate["twitch"].replace("{MOVIE-ID}",matches[1]);break;case"nico":movie="http://www.nicovideo.jp/watch/"+matches[1];break;case"facebook":movie="https://www.facebook.com/"+matches[1]+"/videos/"+matches[2]+"/";break;case"soapbox":case"yam":Dialogify.alert("您輸入的影片網址或嵌入碼有誤, 或可能為本站不支援的網站");return;default:}flag=true;break}}if(!flag){Dialogify.alert("您輸入的影片網址或嵌入碼有誤, 或可能為本站不支援的網站");return}if(parseInt(width,10)>c.defaultSize.max.w){width=c.defaultSize.max.w}if(parseInt(height,10)>c.defaultSize.max.h){height=c.defaultSize.max.h}bahaRte.dialog.destroyPopupDialog("pdmovie");bahaRte.undo.backup();var text;if(bahaRte.isPlainText){text="[movie="+movie+" width="+width+" height="+height+"]";bahaRte.utility.insertTextTag(text)}else{var movieId=(new Date).getTime();text='<img id="'+movieId+'" width="'+width+'" height="'+height+'" data-movie="'+movie+'" src="'+bahaRte.constants.movieImgUrl+'" />';bahaRte.utility.insertHtml(text);if($.browser.firefox){var node=bahaRte.doc.getElementById(movieId);if(node){node.setAttribute("data-movie",movie)}}}Forum.Editor.detectThumbnail()},createLink:function(evt,url,label){if($.browser.ie&&bahaRte.previousSel){bahaRte.previousSel.select()}if($.browser.ie11&&bahaRte.previousSel){var curSel=bahaRte.win.getSelection();curSel.removeAllRanges();curSel.addRange(bahaRte.previousSel)}var pattern=/^http[s]?:\/\/.+?/i;var sel=bahaRte.selection.getSelectedText();var imageData=bahaRte.selection.getSelectedImageInfo();var hasException=false;url=url||document.getElementById("_bhrte_linkurl").value.trim();try{url=decodeURI(url)}catch(e){hasException=true}if(url===""){if(!bahaRte.isPlainText){bahaRte.toolbar.removeLink()}return}if(!url.match(pattern)){url="http://"+url}url=url.replace(/\[/,"&#91;").replace(/\]/,"&#93;");if(bahaRte.isPlainText){if(sel===""){label=label||document.getElementById("_bhrte_linktext").value||url||""}bahaRte.dialog.destroyPopupDialog("pdcreatelink");if(label!==""&&label!=undefined){bahaRte.utility.insertTextTag(label)}bahaRte.utility.insertTextTag("[url="+url+"]{text}[/url]",true);return}var linktext=document.getElementById("_bhrte_linktext").value;bahaRte.dialog.destroyPopupDialog("pdcreatelink");if(sel===""&&!imageData.isImage){sel=label||linktext||url;bahaRte.selection.insertAnchorNode(sel)}bahaRte.undo.backup();!hasException&&(url=encodeURI(url));bahaRte.doc.execCommand("createlink",false,url);!hasException&&bahaRte.utility.checkSpecialLink()},removeLink:function(){if(bahaRte.isPlainText){alert("disabled");return}bahaRte.dialog.destroyPopupDialog("pdcreatelink");var isLink=false;var node=bahaRte.selection.getSelectedNode();while(node&&!node.tagName.equals("body")&&!isLink){if(node.tagName.equals("a")&&node.getAttribute("href")!==null){isLink=true}else{node=node.parentNode}}if(isLink){bahaRte.undo.backup();bahaRte.selection.selectNode(node);bahaRte.doc.execCommand("unlink",false,null)}},listTruthImage:function(evt,page){var list=jQuery("#bhImgTruth");var btn=jQuery("#bhImgMoreBtn");var msg=jQuery("#bhImgMsg");page=page||list.data("page");btn.hide();var param="p="+page;jQuery.get("/ajax/forum_editor_listtruthimage.php",{p:page},function(responseText){if(responseText=="ERR_NOLOGIN"){alert("請先登入");return}else if(responseText=="ERR_EMPTY"){msg.addClass("is-error").text("您的小屋圖庫裡沒有圖片了!").show();return}if(page==1){list.html(responseText)}else{list.append(responseText)}btn.show();msg.removeClass("is-error").hide();list.data("page",++page)})},listWikiImage:function(evt,page,search){var param="n="+bahaRte.config.wikiNamespace;param+="&p="+page;if(search!==""){param+="&s="+encodeURI(search)}var listUrl=bahaRte.config.service=="guildwiki"?"/editor/listGuildwikiimage.php":"/editor/listwikiimage.php";$.ajax({method:"GET",url:listUrl,param:param,success:function(responseText){if(page==1){document.getElementById("_bhrte_imageList").innerHTML=responseText}else{var container=document.getElementById("_bhrte_moreImage"+page);var div=document.createElement("div");div.innerHTML=responseText;container.parentNode.appendChild(div);container.parentNode.removeChild(container)}},fail:function(code){alert("發生錯誤, 請稍後再試一次")}})},insertSelectedImage:function(evt,url){if(!url){url="";var elements=$(":checkbox[name=_bhrte_chkImage]:checked").get();for(var i=0;i<elements.length;i++){url+=elements[i].value+"\n"}if(url===""){alert("請勾選要引用的圖片");return}}bahaRte.dialog.destroyPopupDialog();bahaRte.toolbar.insertUploadedImage(url)},createWikiLink:function(evt){if($.browser.ie&&bahaRte.previousSel){bahaRte.previousSel.select()}if($.browser.ie11&&bahaRte.previousSel){var curSel=bahaRte.win.getSelection();curSel.removeAllRanges();curSel.addRange(bahaRte.previousSel)}var serviceUrl=bahaRte.constants.serviceUrl;var sel=bahaRte.selection.getSelectedText();var data=bahaRte.config.wikiNamespace;var wikiSn;if(!data){return}data=data.split(":",2);wikiSn=data[0];var text=decodeURI(document.getElementById("_bhrte_wikitext").value);if(text===""){var anchorInfo=bahaRte.selection.getSelectedAnchorInfo();if(anchorInfo.isWiki){bahaRte.toolbar.removeLink()}else{bahaRte.dialog.destroyPopupDialog()}return}var label=sel;if(label===""){label=document.getElementById("_bhrte_wikilabel").value;if(label===""){label=text}}if(bahaRte.isPlainText){if(sel===""){bahaRte.utility.insertTextTag(label,false)}bahaRte.utility.insertTextTag("[wiki="+wikiSn+":"+text+"]{text}[/wiki]",true);bahaRte.dialog.destroyPopupDialog("pdwiki");return}var url;if(bahaRte.config.service=="guildwiki"){url="http://guild.gamer.com.tw/wiki.php?sn="+wikiSn+"&n="+encodeURI(text)}else{url=serviceUrl.wiki+wikiSn+":"+encodeURI(text)}bahaRte.undo.backup();if(sel===""){bahaRte.selection.insertAnchorNode(label)}bahaRte.doc.execCommand("createlink",false,url);bahaRte.utility.checkSpecialLink();bahaRte.dialog.destroyPopupDialog("pdwiki")},createAcgLink:function(evt){evt=window.event||evt;if($.browser.ie&&bahaRte.previousSel){bahaRte.previousSel.select()}if($.browser.ie11&&bahaRte.previousSel){var curSel=bahaRte.win.getSelection();curSel.removeAllRanges();curSel.addRange(bahaRte.previousSel)}var text=bahaRte.selection.getSelectedText();var target=evt.srcElement||evt.target;var anchorInfo=bahaRte.selection.getSelectedAnchorInfo();if(anchorInfo.isAcg){bahaRte.toolbar.removeLink();return}if(text===""&&target.id=="_bhrte_acg"){bahaRte.dialog.popupDialog(evt);return}else if(text===""&&target.nodeName.equals("form")){text=decodeURI(document.getElementById("_bhrte_acgtext").value);if(text===""){bahaRte.dialog.destroyPopupDialog();return}if(bahaRte.isPlainText){bahaRte.utility.insertTextTag(text,false)}else{bahaRte.selection.insertAnchorNode(text)}}if(anchorInfo.isAcg&&!target.nodeName.equals("form")){bahaRte.toolbar.removeLink();return}if(bahaRte.isPlainText){bahaRte.utility.insertTextTag("[acg]{text}[/acg]",true);if(target.nodeName.equals("form")){bahaRte.dialog.destroyPopupDialog("pdacg")}else{bahaRte.utility.keepSelection(evt)}return}var url=bahaRte.constants.serviceUrl.acg+encodeURI(text);bahaRte.undo.backup();bahaRte.doc.execCommand("createlink",false,url);bahaRte.utility.checkSpecialLink();if(target.nodeName.equals("form")){bahaRte.dialog.destroyPopupDialog("pdacg")}else{bahaRte.utility.keepSelection(evt)}},insertImage:function(evt,url){if($.browser.ie&&bahaRte.previousSel){bahaRte.previousSel.select()}if($.browser.ie11&&bahaRte.previousSel){var curSel=bahaRte.win.getSelection();curSel.removeAllRanges();curSel.addRange(bahaRte.previousSel)}var pattern=/(^http[s]?:\/\/(?:.*?)\.(?:jpg|jpeg|gif|png))(?:\?[^\?]*)?$/i;var patternPchome=/^https?:\/\/link\.photo\.pchome\.com\.tw\/s[0-9]{1,3}\/[a-zA-Z0-9\_]{4,16}\/[0-9]{1,4}\/[0-9]{10,15}\/$/i;url=url||encodeURI(decodeURI(document.getElementById("bhImgImageUrl").value));var matches;if(!url||!(matches=url.match(pattern)||url.match(patternPchome))){alert("圖片網址有誤");return}if(matches){url=matches[1]}url=Util.HttpImgFilter.forceToHttps(url);if(!url){alert("這個圖床不支援 https 唷!");return}bahaRte.dialog.destroyPopupDialog("pdinsertimage");bahaRte.undo.backup();if(bahaRte.isPlainText){bahaRte.utility.insertTextTag("[img="+url+"]")}else{bahaRte.win.focus();bahaRte.doc.execCommand("insertimage",false,url)}Forum.Editor.detectThumbnail()},insertUploadedImage:function(data){if($.browser.ie&&bahaRte.previousSel){bahaRte.previousSel.select()}if($.browser.ie11&&bahaRte.previousSel){var curSel=bahaRte.win.getSelection();curSel.removeAllRanges();curSel.addRange(bahaRte.previousSel)}bahaRte.dialog.destroyPopupDialog();bahaRte.undo.backup();var url=data.split(/\n/);var text="";for(var i=0;i<url.length;i++){if(url[i]===""){continue}if(url[i].match(/^https?:\/\/truth\.bahamut\.com\.tw\/guildwiki\/S\/[0-9a-z]{32}\.(?:JPG|PNG|GIF)$/)){url[i]=url[i].replace("guildwiki/S/","guildwiki/B/")}if(bahaRte.isPlainText){text+="[img="+url[i]+"]\n"}else{text+='<img src="'+url[i]+'" /><br />'}}if(text!==""){if(bahaRte.isPlainText){bahaRte.utility.insertTextTag(text)}else{bahaRte.win.focus();bahaRte.utility.insertHtml(text)}}Forum.Editor.detectThumbnail()},insertTable:function(evt){if($.browser.ie&&bahaRte.previousSel){bahaRte.previousSel.select()}if($.browser.ie11&&bahaRte.previousSel){var curSel=bahaRte.win.getSelection();curSel.removeAllRanges();curSel.addRange(bahaRte.previousSel)}var border,align,cp,cs,width,height;if($("#_bhrte_tbIsModify").val()=="yes"){var alignMap=[undefined,"left","center","right"];var table=bahaRte.selection.getSelectedNode();while(!table.nodeName.inArray(["table","body"],true)){table=table.parentNode}if(table.nodeName.equals("body")){return}border=jQuery("#_bhrte_tbborder").data("value");align=jQuery("#_bhrte_tbalign").data("value");cp=parseInt($("#_bhrte_tbcellpadding").val(),10);cs=parseInt($("#_bhrte_tbcellspacing").val(),10);width=$("#_bhrte_tbwidth").val();height=$("#_bhrte_tbheight").val();var attr={};attr.border=border;align&&(attr.align=align)||$(table).removeAttr("align");cp&&(attr.cellPadding=cp)||$(table).removeAttr("cellPadding");cs&&(attr.cellSpacing=cs)||$(table).removeAttr("cellSpacing");if(width&&!isNaN(width)){width+="%"}$(table).removeAttr("width").css("width",width);if(height&&height.indexOf("%")==-1){height+="px"}$(table).removeAttr("height").css("height",height);$(table).attr(attr);bahaRte.dialog.destroyPopupDialog();bahaRte.undo.backup();return}var rows=parseInt(document.getElementById("_bhrte_tbrow").value,10);var cols=parseInt(document.getElementById("_bhrte_tbcol").value,10);if(isNaN(rows)||isNaN(cols)||rows<1||cols<1||rows>200||cols>50){alert("欄列數輸入有誤");return}width=parseInt(document.getElementById("_bhrte_tbwidth").value,10);if(isNaN(width)||width<1||width>100){width=' width="98%"'}else{width=' width="'+width+'%"'}height=parseInt(document.getElementById("_bhrte_tbheight").value,10);if(isNaN(height)||height<1||height>2e3){height=""}else{height=' height="'+height+'"'}cs=parseInt(document.getElementById("_bhrte_tbcellspacing").value,10);if(isNaN(cs)||cs<0||cs>20){cs=""}else{cs=' cellspacing="'+cs+'"'}cp=parseInt(document.getElementById("_bhrte_tbcellpadding").value,10);if(isNaN(cp)||cp<0||cp>20){cp=""}else{cp=' cellpadding="'+cp+'"'}border=parseInt(jQuery("#_bhrte_tbborder").data("value"),10);border=' border="'+border+'"';align=jQuery("#_bhrte_tbalign").data("value");if(!align){align=""}else{align=' align="'+align+'"'}var text="<table"+width+height+cs+cp+border+align+">",tdTemp="",i,j;if($.browser.ie){tdTemp="<td></td>"}else if($.browser.ie11){tdTemp="<td>&nbsp;</td>"}else{tdTemp="<td><br /></td>"}for(i=0;i<rows;i++){text+="<tr>";for(j=0;j<cols;j++){text+=tdTemp}text+="</tr>"}text+="</table>\n<br />";bahaRte.dialog.destroyPopupDialog("pdtable");bahaRte.undo.backup();if(bahaRte.isPlainText){bahaRte.utility.insertTextTag(text.replace(/<br \/>/gi,"").replace(/</g,"[").replace(/>/g,"]").replace(/"/g,""))}else{bahaRte.utility.insertHtml(text)}if(!$.browser.opera){$(".c-post__header span").html("在表格中按右鍵可以開啟進階功能。");setTimeout(function(){$(".c-post__header span").html("")},3e3)}},command:function(evt,id){evt=window.event||evt;var target=evt.srcElement||evt.target;var i;if(bahaRte.isPlainText){switch(id){case"bold":bahaRte.utility.insertTextTag("[b]{text}[/b]",true);break;case"italic":bahaRte.utility.insertTextTag("[i]{text}[/i]",true);break;case"strikethrough":bahaRte.utility.insertTextTag("[s]{text}[/s]",true);break;case"underline":bahaRte.utility.insertTextTag("[u]{text}[/u]",true);break;case"indent":bahaRte.selection.getCursorLine(true);bahaRte.utility.insertTextTag("[tab]{text}[/tab]",true);break;case"inserthorizontalrule":bahaRte.utility.insertTextTag("[hr]");break;case"justifyleft":case"justifycenter":case"justifyright":bahaRte.selection.getCursorLine(true);bahaRte.utility.insertTextTag("["+id.substring(7)+"]{text}[/"+id.substring(7)+"]",true);break;case"insertorderedlist":case"insertunorderedlist":var lines=bahaRte.selection.getCursorLine(true,true);var tag=id=="insertorderedlist"?"ol":"ul";var text="["+tag+"]\n";for(i=0;i<lines.length;i++){text+="  [li]"+lines[i]+"[/li]\n"}text+=text="[/"+tag+"]";bahaRte.utility.insertTextTag(text);break;case"outdent":case"removeformat":case"undo":case"redo":break;default:}}else{bahaRte.undo.backup();if(id.equals("removeformat")){var cells=bahaRte.selection.getSelectedCells();if(cells){for(i=0;i<cells.length;i++){cells[i].style.backgroundColor="";cells[i].removeAttribute("bgcolor")}}}try{bahaRte.doc.execCommand(id,false,null)}catch(e){}}},setForeColor:function(color){bahaRte.undo.backup();if(bahaRte.isPlainText){bahaRte.utility.insertTextTag("[color="+color+"]{text}[/color]",true)}else{let style=bahaRte.doc.createElement("style");style.type="text/css";style.id="tmp_style";if(color=="#000000"){style.innerHTML="body.editstyle{ color:#FFFFFF; }"}else{style.innerHTML="body.editstyle{ color:#000000; }"}bahaRte.doc.getElementsByTagName("head")[0].appendChild(style);bahaRte.doc.execCommand("styleWithCSS",false,true);bahaRte.doc.execCommand("forecolor",false,color);bahaRte.doc.getElementById("tmp_style").remove()}jQuery('[data-id="now_bhrte_forecolor"]').css("fill",color);bahaRte.panel.destroyPopupPanel()},setBackgroundColor:function(color){bahaRte.undo.backup();if(bahaRte.isPlainText){bahaRte.utility.insertTextTag("[bgcolor="+color+"]{text}[/bgcolor]",true)}else{var cells=bahaRte.selection.getSelectedCells();if(!cells){bahaRte.doc.execCommand($.browser.ie?"backcolor":"hilitecolor",false,color)}else{for(var i=0;i<cells.length;i++){cells[i].style.backgroundColor=color}}}jQuery('[data-id="now_bhrte_bgcolor"]').css("fill",color);bahaRte.panel.destroyPopupPanel()},setFont:function(item){bahaRte.undo.backup();var font=jQuery(item).data("value");if(bahaRte.isPlainText){bahaRte.utility.insertTextTag("[font="+font+"]{text}[/font]",true)}else{bahaRte.doc.execCommand("fontname",false,font)}},setSize:function(item){var size=jQuery(item).data("value");var afs=bahaRte.constants.allowFontSize;var fontSizeMap=bahaRte.utility.createMap(afs.size,afs.fontValue);bahaRte.undo.backup();if(bahaRte.isPlainText){bahaRte.utility.insertTextTag("[size="+fontSizeMap[size]+"]{text}[/size]",true)}else{bahaRte.doc.execCommand("fontsize",false,fontSizeMap[size])}},insertHeading:function(item){var heading=jQuery(item).data("value");if(bahaRte.isPlainText){bahaRte.selection.getCursorLine(true);bahaRte.utility.insertTextTag("["+heading+"]{text}[/"+heading+"]",true)}else{bahaRte.undo.backup();var node=bahaRte.selection.getSelectedNode();var nodes=bahaRte.utility.getAllContainer(node);var flag=false;for(var i in nodes){if(nodes[i].nodeName.toLowerCase().equals(heading)){bahaRte.doc.execCommand("formatblock",false,"<p>");flag=true;break}}try{if(!flag){bahaRte.doc.execCommand("formatblock",false,"<"+heading+">")}}catch(e){}}bahaRte.panel.destroyPopupPanel()},refreshContent:function(evt){if(bahaRte.isPlainText){bahaRte.doc.body.innerHTML=bahaRte.convertor.toHtml(bahaRte.source.value);bahaRte.isPlainText=false;bahaRte.source.value=bahaRte.convertor.toText(bahaRte.doc.body.innerHTML);bahaRte.isPlainText=true}else{bahaRte.undo.backup();bahaRte.source.value=bahaRte.convertor.toText(bahaRte.doc.body.innerHTML);bahaRte.isPlainText=true;bahaRte.doc.body.innerHTML=bahaRte.convertor.toHtml(bahaRte.source.value);bahaRte.isPlainText=false}},switchButton:function(evt){bahaRte.panel.destroyPopupPanel();var buttonName="";if(bahaRte.buttonSetName.indexOf("simple")==-1){buttonName=bahaRte.buttonSetName.replace("advance","simple")}else{buttonName=bahaRte.buttonSetName.replace("simple","advance")}var buttons=bahaRte.buttonSet.get(buttonName);bahaRte.config.buttonList=buttons;bahaRte.toolbar.show();var buttonSet=buttonName.indexOf("simple")==-1?"advance":"simple";$.cookie.set("ckBhrteButtonSet",buttonSet,".gamer.com.tw","/",30)},toolbarOnClick:function(evt){var target=window.event?window.event.srcElement:evt.target;if(target.id===""){bahaRte.panel.destroyPopupPanel()}bahaRte.utility.destroyContextMenu();bahaRte.utility.keepSelection(evt)},show:function(){var img=bahaRte.constants.editorImgUrl;var cursor=bahaRte.utility.cursor;var textStyle="",rteStyle="";if(bahaRte.isPlainText){textStyle=' style="background-image:url('+img+"bg2.gif);border:solid 1px black;border-bottom:none 0px;cursor:"+cursor+'"';rteStyle=' style="border:solid 1px black;border-right:none 0px;cursor:'+cursor+'"'}else{rteStyle=' style="background-image:url('+img+"bg2.gif);border:solid 1px black;border-bottom:none 0px;cursor:"+cursor+'"';textStyle=' style="border:solid 1px black;border-left:none 0px;cursor:'+cursor+'"'}var toolbarHtml="";toolbarHtml='<table onmousedown="bahaRte.toolbar.toolbarOnClick(event);" width="'+bahaRte.config.width+'" cellpadding="0" cellspacing="0" border="0" align="center">';toolbarHtml+="<tr>";toolbarHtml+='<td id="_bhrte_btn_rte" height="24" onmousedown="bahaRte.toolbar.alternateView(this);" width="80" valign="middle" title="切換到所見所得模式" align="center"'+rteStyle+">所見所得</td>";toolbarHtml+='<td id="_bhrte_btn_text" width="80" onmousedown="bahaRte.toolbar.alternateView(this);" title="切換到原始碼模式" align="center"'+textStyle+">原始碼</td>";toolbarHtml+='<td id="_bhrte_statusbar" width="'+(bahaRte.config.width-200)+'" style="padding-left:5px;border-bottom:solid 1px black;">&nbsp;</td>';toolbarHtml+='<td width="60" class="bahaRte_btn_out" onmousedown="javascript:bahaRte.utility.manualSave();" onmouseover="javascript:bahaRte.toolbar.buttonHover(event);" onmouseout="javascript:bahaRte.toolbar.buttonOut(event);" align="center" style="cursor:'+cursor+";background-image:url("+img+'bg3.gif);border:solid 1px black;" title="立即備份" id="_bhrte_savenow">立即備份</td>';toolbarHtml+='<td width="3" style="border-bottom:solid 1px black;">&nbsp;</td>';toolbarHtml+=bahaRte.toolbar.getButtonLayout(bahaRte.toolbar.refresh);toolbarHtml+="</tr>";toolbarHtml+="<tr>";toolbarHtml+='<td colspan="8" style="background-image:url('+img+'bg1.gif);border-left:solid 1px black;border-right:solid 1px black;">';toolbarHtml+='<table width="100%" height="100%" border="0" cellspacing="0" cellpadding="0" valign="middle">';toolbarHtml+="<tr>";toolbarHtml+='<td width="'+(bahaRte.config.width-9)+'" valign="middle" align="left" style="border-bottom:solid 1px #d0e5e6;">';toolbarHtml+='<table cellpadding="0" cellspacing="4" border="0" width="100%" style="border-spacing: 4px;">';toolbarHtml+="<tr>";for(var i in bahaRte.config.buttonList.button){toolbarHtml+=bahaRte.toolbar.getButtonLayout(bahaRte.config.buttonList.button[i])}toolbarHtml+='<td id="_bhrte_chbtn" align="right" class="bhrte_chbtn" style="color:blue;background-image:url('+bahaRte.constants.editorImgUrl+"triangle4.gif);cursor:"+bahaRte.utility.cursor+'" onmousedown="bahaRte.toolbar.switchButton(event)">進階</td>';toolbarHtml+="</tr></table></td></tr></table></td></tr></table>";bahaRte.config.toolbar.innerHTML=toolbarHtml;var div,top;top="6px";div=document.getElementById("now_bhrte_forecolor");if(div){div.style.top=top}div=document.getElementById("now_bhrte_bgcolor");if(div){div.style.top=top}div=document.getElementById("_bhrte_chbtn");if(bahaRte.buttonSetName.indexOf("simple")==-1){div.innerHTML="簡易";div.title="換回簡易編輯模式"}else{div.innerHTML="進階";div.title="展開進階編輯模式"}bahaRte.toolbar.enableButton()},alternateView:function(focus){var onSourceView=jQuery(".fe_source").hasClass("is-active");if(onSourceView&&!bahaRte.isPlainText||!onSourceView&&bahaRte.isPlainText){return}var img=bahaRte.constants.editorImgUrl;var cursor=bahaRte.utility.cursor;var disabledItems='[data-id="_bhrte_copyformat"], [data-id="_bhrte_undo"], [data-id="_bhrte_redo"], [data-id="_bhrte_outdent"], [data-id="_bhrte_removeformat"]';if(onSourceView){var text=bahaRte.source.value;bahaRte.doc.body.innerHTML=bahaRte.convertor.toHtml(text);bahaRte.isPlainText=false;bahaRte.config.target.style.display="block";bahaRte.source.style.display="none";jQuery(disabledItems).removeClass("is-disabled").removeAttr("disabled");bahaRte.source.blur();if(focus){bahaRte.win.focus()}bahaRte.undoStack.stack=[];bahaRte.undoStack.range=[];bahaRte.undoFlag=false;bahaRte.undoPosition=0;bahaRte.undo.backup();jQuery(".fe_source").removeClass("is-active")}else{var html=bahaRte.doc.body.innerHTML;bahaRte.source.value=bahaRte.convertor.toText(html);bahaRte.isPlainText=true;bahaRte.config.target.style.display="none";bahaRte.source.style.display="block";bahaRte.utility.resetTagStatus();jQuery(disabledItems).addClass("is-disabled").attr("disabled","disabled");if(focus){bahaRte.source.focus()}jQuery(".fe_source").addClass("is-active")}var view=bahaRte.isPlainText?"bahacode":"rte";$.cookie.set("ckBhrteView",view,".gamer.com.tw","/",30)},bhImgOnOk:function(){var checked=parseInt(egg(":radio[name=bhImgMode]:checked").val(),10);switch(checked){case 1:egg("#BH-popup :radio,#bhImgBtnOk").attr("disabled",true);egg("#bhImgMsg").html("圖片上傳中, 請稍候...").show();egg("#bhImgModeUpload").hide();break;case 2:bahaRte.toolbar.insertSelectedImage();return false;break;case 3:bahaRte.toolbar.insertImage();return false;break;default:}return true},bhImgModeChange:function(mode){egg("#bhImgModeUpload,#bhImgModeInsertUrl,#bhImgModeTruth,#bhImgTruth").hide();switch(mode){case 1:egg("#bhImgModeUpload").show();egg("#BH-popup").css("width","350px");break;case 2:egg("#BH-popup :radio,#bhImgBtnOk").attr("disabled",true);egg("#bhImgMsg").html("取得資料中, 請稍候...").show();egg("#bhImgTruth").html("");egg("#bhImgModeTruth").show();bahaRte.toolbar.listTruthImage(undefined,1);break;case 3:egg("#BH-popup").css("width","350px");egg("#bhImgModeInsertUrl").show();break;default:}egg.lightbox.refresh()}},table:{wrongActionMsg:function(){$("#_bhrte_statusbar").html('<span style="color:red;">操作錯誤！無法執行此動作！</span>');setTimeout(function(){$("#_bhrte_statusbar").html("")},3e3)},simplify:function(rowOrCol){var info=bahaRte.selection.getSelectedTableInfo(),i,j,cell,flag;var targetAttr=rowOrCol?"rowSpan":"colSpan",value,min,prevCell;var major=rowOrCol?info.rows:info.cols;var minor=rowOrCol?info.cols:info.rows;for(i=0;i<major;i++){flag=false;min=-1;for(j=0;j<minor;j++){cell=rowOrCol?info.cells[i][j]:info.cells[j][i];value=cell[targetAttr];prevCell=rowOrCol?info.cells[i-1]?info.cells[i-1][j]:undefined:info.cells[j][i-1];if(value==1||!cell.available&&prevCell&&cell.cell!==prevCell.cell){flag=true;break}if(min>value||min<0){min=value}}if(flag){continue}min--;for(j=0;j<minor;j++){cell=rowOrCol?info.cells[i][j]:info.cells[j][i];value=cell[targetAttr]-min;if(value<2){cell.cell.removeAttribute(targetAttr)}else{cell.cell.setAttribute(targetAttr,value)}}}},setCellAttr:function(evt){if($.browser.ie&&bahaRte.previousSel){bahaRte.previousSel.select()}if($.browser.ie11&&bahaRte.previousSel){var curSel=bahaRte.win.getSelection();curSel.removeAllRanges();curSel.addRange(bahaRte.previousSel)}var td=bahaRte.selection.getSelectedCells();if(!td){return}bahaRte.undo.backup();td=td[0];var width=$("#_bhrte_cellwidth").val();var height=$("#_bhrte_cellheight").val();if(width&&!isNaN(width)){width+="%"}$(td).removeAttr("width").css("width",width);if(height&&height.indexOf("%")==-1){height+="px"}$(td).removeAttr("height").css("height",height);bahaRte.dialog.destroyPopupDialog()},insertRow:function(direction){var info=bahaRte.selection.getSelectedTableInfo(),i;var targetIndex=info.selectedRowIndex+direction;if(info.cells[targetIndex]){for(i=0;i<info.cells[targetIndex].length;i++){if(!info.cells[targetIndex][i].available&&info.cells[targetIndex][i].rowSpan>1&&info.cells[info.selectedRowIndex][i].rowSpan>1){bahaRte.utility.destroyContextMenu();bahaRte.table.wrongActionMsg();return}}}bahaRte.undo.backup();var row=info.table.insertRow(targetIndex);var cell;for(i=0;i<info.cols;i++){cell=row.insertCell(i);cell.innerHTML=$.browser.ie?"":"<br />"}bahaRte.utility.destroyContextMenu()},insertColumn:function(direction){var info=bahaRte.selection.getSelectedTableInfo(),i;var targetIndex=info.selectedX+direction;for(i=0;i<info.cells.length;i++){if(!info.cells[i][targetIndex]){break}if(!info.cells[i][targetIndex].available&&info.cells[i][targetIndex].colSpan>1&&info.cells[i][info.selectedX].colSpan>1){bahaRte.utility.destroyContextMenu();bahaRte.table.wrongActionMsg();return}}bahaRte.undo.backup();var cell,diff,j;var tr=$(info.table).find("tr").get();for(i=0;i<tr.length;i++){diff=0;for(j=0;j<targetIndex;j++){!info.cells[i][j].available&&diff++}cell=tr[i].insertCell(targetIndex-diff);cell.innerHTML=$.browser.ie?"":"<br />"}bahaRte.utility.destroyContextMenu()},mergeCell:function(direction){if(!direction.inArray(["up","down","left","right"])){return}var isVertical=direction.inArray(["up","down"]);var isPlus=direction.inArray(["down","right"]);var info=bahaRte.selection.getSelectedTableInfo(),i,targetCell,newIndex;var rowSpan=info.selectedCell.rowSpan||1;var colSpan=info.selectedCell.colSpan||1;var diff=isPlus?1:-1;i=isVertical?info.selectedRowIndex:info.selectedX;i+=diff;var x=isVertical?info.selectedX:i;var y=isVertical?i:info.selectedRowIndex;while(info.cells[y]&&(targetCell=info.cells[y][x])&&!targetCell.available){if(isVertical){y+=diff}else{x+=diff}}if(!targetCell||!targetCell.available){bahaRte.utility.destroyContextMenu();bahaRte.table.wrongActionMsg();return}var flag=isVertical?colSpan!=targetCell.colSpan:rowSpan!=targetCell.rowSpan;if(flag){bahaRte.utility.destroyContextMenu();bahaRte.table.wrongActionMsg();return}bahaRte.undo.backup();info.cells[info.selectedRowIndex][info.selectedX].merged=true;targetCell.merged=true;var cell1=isPlus?info.selectedCell:targetCell.cell;var cell2=isPlus?targetCell.cell:info.selectedCell;cell1.innerHTML+=cell2.innerHTML;if(isVertical){cell1.setAttribute("rowSpan",rowSpan+targetCell.rowSpan);newIndex=y}else{cell1.setAttribute("colSpan",colSpan+targetCell.colSpan);newIndex=x}var cell2Parent=cell2.parentNode;cell2Parent.removeChild(cell2);if($("td,th",cell2Parent).size()===0){cell2Parent.parentNode.removeChild(cell2Parent)}bahaRte.selection.selectNode(cell1);bahaRte.table.simplify(isVertical);bahaRte.utility.destroyContextMenu()},horizontalSplitCell:function(){var info=bahaRte.selection.getSelectedTableInfo(),i;var rowSpan=parseInt(info.selectedCell.getAttribute("rowSpan"),10)||1;if(rowSpan!=1&&rowSpan%2!==0){bahaRte.utility.destroyContextMenu();bahaRte.table.wrongActionMsg();return}bahaRte.undo.backup();var newRow,newCell,newRowSpan,cell,prevCell,colSpan;if(rowSpan==1){newRow=info.table.insertRow(info.selectedRowIndex+1);newCell=newRow.insertCell(0);newCell.innerHTML=$.browser.ie?"":"<br />";colSpan=parseInt(info.selectedCell.getAttribute("colSpan"),10)||1;if(colSpan>1){newCell.colSpan=colSpan}for(i=0;i<info.cols;i++){cell=info.cells[info.selectedRowIndex][i].cell;if(cell===info.selectedCell||cell===prevCell){continue}newRowSpan=parseInt(cell.getAttribute("rowSpan"),10)||1;cell.rowSpan=newRowSpan+1;prevCell=cell}}else{newRowSpan=rowSpan/2;var tr=$("tr",info.table).get();var newRowIndex=info.selectedRowIndex+newRowSpan,x=0;i=0;while(info.cells[newRowIndex][i].cell!==info.selectedCell){if(info.cells[newRowIndex][i].available){x++}i++}newCell=tr[newRowIndex].insertCell(x);newCell.innerHTML=$.browser.ie?"":"<br />";colSpan=parseInt(info.selectedCell.getAttribute("colSpan"),10)||1;if(colSpan>1){newCell.colSpan=colSpan}if(newRowSpan>1){info.selectedCell.rowSpan=newRowSpan;newCell.rowSpan=newRowSpan}else{info.selectedCell.removeAttribute("rowSpan")}}bahaRte.utility.destroyContextMenu()},verticalSplitCell:function(){var info=bahaRte.selection.getSelectedTableInfo(),i;var colSpan=parseInt(info.selectedCell.getAttribute("colSpan"),10)||1;if(colSpan!=1&&colSpan%2!==0){bahaRte.utility.destroyContextMenu();bahaRte.table.wrongActionMsg();return}bahaRte.undo.backup();var newCell,newColSpan,cellColSpan,cell,prevCell,rowSpan;newColSpan=parseInt(colSpan/2,10);newCell=info.selectedCell.parentNode.insertCell(info.selectedColIndex+1);newCell.innerHTML=$.browser.ie?"":"<br />";rowSpan=parseInt(info.selectedCell.getAttribute("rowSpan"),10)||1;if(rowSpan>1){newCell.rowSpan=rowSpan}if(newColSpan===0){for(i=0;i<info.rows;i++){cell=info.cells[i][info.selectedX].cell;if(cell===info.selectedCell||cell==prevCell){continue}cellColSpan=parseInt(cell.getAttribute("colSpan"),10)||1;cell.colSpan=cellColSpan+1;prevCell=cell}}else if(newColSpan==1){info.selectedCell.removeAttribute("colSpan")}else{info.selectedCell.colSpan=newColSpan;newCell.colSpan=newColSpan}bahaRte.utility.destroyContextMenu()},deleteRow:function(){var info=bahaRte.selection.getSelectedTableInfo(),i;for(i=0;i<info.cells[info.selectedRowIndex].length;i++){if(info.cells[info.selectedRowIndex][i].rowSpan>1){bahaRte.utility.destroyContextMenu();bahaRte.table.wrongActionMsg();return}}bahaRte.undo.backup();info.table.deleteRow(info.selectedRowIndex);if($(info.table).find("td,th").size()===0){info.table.parentNode.removeChild(info.table)}else{bahaRte.selection.selectNode($("td,th",info.table).get(0));bahaRte.table.simplify(false)}bahaRte.utility.destroyContextMenu()},deleteColumn:function(){var info=bahaRte.selection.getSelectedTableInfo(),i;for(i=0;i<info.cells.length;i++){if(info.cells[i][info.selectedX].colSpan>1){bahaRte.utility.destroyContextMenu();bahaRte.table.wrongActionMsg();return}}bahaRte.undo.backup();var diff,j,cell;var tr=$(info.table).find("tr").get();for(i=0;i<tr.length;i++){cell=info.cells[i][info.selectedX];if(cell.cell){cell.cell.parentNode.removeChild(cell.cell);for(j=i;j<i+cell.rowSpan;j++){info.cells[j][info.selectedX].cell=null}}}if($(info.table).find("td,th").size()===0){info.table.parentNode.removeChild(info.table)}else{i=0;while(i<info.table.rows.length){if($("td,th",info.table.rows[i]).size()===0){info.table.deleteRow(i)}else{i++}}bahaRte.selection.selectNode($("td,th",info.table).get(0));bahaRte.table.simplify(true)}bahaRte.utility.destroyContextMenu()}},utility:{getPosition:function(target,belowTarget){var x=target.offsetLeft;var y=target.offsetTop;var parent=target;while(parent.offsetParent){parent=parent.offsetParent;x+=parent.offsetLeft;y+=parent.offsetTop}if(belowTarget){y+=target.offsetHeight}return{x:x,y:y}},tip:function(evt,msg,target,adjustPos){var exists=document.getElementById("bhrte_tip");if(exists&&exists.innerHTML.replace(/<br(?: ?\/)?>/gi,"\n")==msg){try{document.body.removeChild(document.getElementById("bhrte_tip"));document.body.removeChild(document.getElementById("bhrte_tipmask"))}catch(e){}return}var span=document.createElement("span");span.id="bhrte_tip";span.className="bhrte_tip";span.innerHTML=msg.replace(/\n/g,"<br />");var spanMask=document.createElement("span");spanMask.id="bhrte_tipmask";spanMask.className="bhrte_tipmask";spanMask.innerHTML=msg.replace(/\n/g,"<br />");var pos=bahaRte.utility.getPosition(target||(window.event?window.event.srcElement:evt.target));span.style.left=pos.x+adjustPos.x+"px";span.style.top=pos.y+adjustPos.y+"px";spanMask.style.left=pos.x+adjustPos.x+2+"px";spanMask.style.top=pos.y+adjustPos.y+2+"px";document.body.appendChild(spanMask);document.body.appendChild(span);if(target){setTimeout(function(){try{document.body.removeChild(document.getElementById("bhrte_tip"));document.body.removeChild(document.getElementById("bhrte_tipmask"))}catch(e){}},3e3)}},stringReplaceAt:function(str,pos,replacement){return str.substring(0,pos)+replacement+str.substring(pos+1)},createMap:function(aryKey,aryValue){var map={};var len=aryKey.length,i;for(i=0;i<len;i++){if(aryValue){map[isNaN(aryKey[i])?aryKey[i].toLowerCase():aryKey[i]]=aryValue[i]}else{map[aryKey[i]]=true}}return map},getMovieCode:function(data){var c=bahaRte.constants.movieData;var width,height;if(data.w&&data.h){width=data.w;height=data.h}else{width=c.defaultSize[data.which].w;height=c.defaultSize[data.which].h}var ret;var domainParameter="&parent=forum.gamer.com.tw&parent=home.gamer.com.tw&parent=api.gamer.com.tw&parent=m.gamer.com.tw";switch(data.which){case"youtube":case"newtube":case"sharetube":case"shortstube":ret='<iframe class="youtube-player" width="'+width+'" height="'+height+'" src="https://www.youtube.com/embed/'+data.url+'" frameborder="0" allowFullScreen></iframe>';break;case"xuite":ret="<iframe marginwidth='0' marginheight='0' src='//vlog.xuite.net/embed/"+data.url+"' width='"+width+"' height='"+height+"' scrolling='no' frameborder='0'></iframe>";break;case"twitchChannel":ret='<iframe width="'+width+'" height="'+height+'" src="//player.'+data.url.host+".tv/?autoplay=false&channel="+data.url.channel+domainParameter+'" frameborder="0" scrolling="no"></iframe>';break;case"twitchVideo":ret='<iframe width="'+width+'" height="'+height+'" src="//player.'+data.url.host+".tv/?autoplay=false&video="+data.url.videoType+data.url.vid+domainParameter+'" frameborder="0" scrolling="no"></iframe>';break;case"livehouse":ret='<iframe width="'+width+'" height="'+height+'" src="https://livehouse.in/embed/channel/'+data.url+'/video" frameborder="0" allowfullscreen></iframe>';break;case"nico":ret='<a href="http://www.nicovideo.jp/watch/'+data.url+'" target="_blank" style="display: inline-block; position: relative;"><img src="https://i2.bahamut.com.tw/icon_videoplayer.svg" style="position: absolute; top: 50%; left: 50%; margin: 0; width: 30%; max-height: 50%; transform: translate(-50%, -50%);"><div style="background: #000000 url(http://tn-skr3.smilevideo.jp/smile?i='+data.url.replace(/sm|nm|ca|cd|ax|yo|nl|ig|na|cw|za|zb|zc|zd|ze|om|sk|yk|so|am|fz/,"")+') center center no-repeat; background-size: contain; width: 425px; height: 250px;"></div></a>';break;case"facebook":ret='<iframe src="https://www.facebook.com/plugins/video.php?href=https://www.facebook.com/'+data.channel+"/videos/"+data.vid+"/&width="+width+"&show_text=false&height="+height+'&appId" width="'+width+'" height="'+height+'" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowTransparency="true" allow="encrypted-media" allowFullScreen="true"></iframe>';break;default:}return ret},switchSize:function(size,forLength){var bs=bahaRte.constants.baseSize;var result=0;var sizeArray=["small","medium","large","x-large","xx-large"];var sizeValue=["13px","15px","18px","24px","32px"];if(size.inArray(sizeArray,true)){var sizeMap=bahaRte.utility.createMap(sizeArray,sizeValue);return sizeMap[size.trim().toLowerCase()]}if(matches=size.match(/\s*([0-9]{0,3}(?:\.[0-9]{1,6})?)(%|px|pt|em|ex|pc|cm|mm|in)\s*/i)){if(matches[2].inArray(["%","em"],true)&&forLength){return size}var num=parseFloat(matches[1]);if(!isNaN(num)){switch(matches[2]){case"%":result=bahaRte.utility.round(num/100*bs,6);break;case"px":result=num;break;case"pt":result=bahaRte.utility.round(num/.75,6);break;case"em":result=num*bs;break;case"ex":result=num*9.333333;break;case"pc":result=num*bs;break;case"cm":result=bahaRte.utility.round(num*37.795276,6);break;case"mm":result=bahaRte.utility.round(num*3.779527,6);break;case"in":result=num*96;break;default:}if(forLength){return bahaRte.utility.round(result,0)}var min=2147483647,index=0;var aryFS=bahaRte.constants.allowFontSize.size;for(var i=0;i<aryFS.length;i++){var fsize=parseFloat(aryFS[i].substr(0,aryFS[i].length-2));if(Math.abs(result-fsize)<min){min=Math.abs(result-fsize);index=i}}result=aryFS[index]}}return result===0?bs+"px":result},round:function(num,precision){multi=Math.pow(10,precision);return Math.round(num*multi)/multi},switchColor:function(color){var result=color,matches=[];if(matches=color.match(/\s*rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)\s*/i)){var r=bahaRte.utility.dec2hex(matches[1]);var g=bahaRte.utility.dec2hex(matches[2]);var b=bahaRte.utility.dec2hex(matches[3]);if(r<0||g<0||b<0){result=""}else{result="#"+r+g+b}}return result},dec2hex:function(decStr){var hex="";var aryHex=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];var num=parseInt(decStr,10);if(isNaN(num)||num<0){return-1}while(num>0){hex=aryHex[num%16]+hex;num=Math.floor(num/16)}if(hex===""){hex="00"}else if(hex.length==1){hex="0"+hex}return hex},getAllContainer:function(node){var ret=[];while(node&&!node.nodeName.equals("body")){if(node.nodeType!=bahaRte.constants.nodeType.TEXT_NODE){ret.push(node)}node=node.parentNode}return ret},setButtonStyle:function(id){jQuery('[data-id="_bhrte_'+id+'"]').addClass("is-active")},checkSpecialLink:function(){var tags=bahaRte.doc.getElementsByTagName("a");var attr;for(var i=0;i<tags.length;i++){attr=tags[i].getAttribute("href");try{attr=decodeURI(attr)}catch(e){}if(attr&&(attr.match(bahaRte.constants.serviceUrl.wikiUrlPattern)||attr.match(bahaRte.constants.serviceUrl.guildWikiUrlPattern))){tags[i].className="wiki"}else if(attr&&attr.match(bahaRte.constants.serviceUrl.acgPattern)){tags[i].className="acg"}}},resetTagStatus:function(){jQuery(".editor-toolbar .is-active:not(.fe_source)").removeClass("is-active");jQuery('[data-id="fe_font"] span').text("Arial");jQuery('[data-id="fe_fontsize"] span').text("中");jQuery('[data-id="fe_header"] span').text("標題")},showBalloonbar:function(){var selection=bahaRte.win.getSelection();if(!selection||selection.rangeCount==0){return}var range=selection.getRangeAt(0);if(!range){return}jQuery(".js-dropdown-list:visible").slideUp(200);jQuery("body").off("mousedown");var toolbar=jQuery("#fe_balloon_toolbar");if(range.collapsed&&toolbar.is(":visible")){toolbar.fadeOut(200)}if(!range.collapsed){var rect=range.getBoundingClientRect();toolbar.css({top:rect.bottom+jQuery("#editor").offset().top-80,left:rect.left+(rect.right-rect.left)/2});if(toolbar.is(":hidden")){toolbar.fadeIn(200)}}},editorOnKeyUp:function(evt){evt=bahaRte.win.event||evt;if(evt.keyCode>=33&&evt.keyCode<=40||evt.keyCode==8||evt.keyCode==17||evt.keyCode==46||evt.keyCode==91||evt.keyCode==93||evt.keyCode==224){bahaRte.utility.getTagStatus();bahaRte.utility.showBalloonbar()}},editorOnMouseUp:function(evt){if(bahaRte.copiedState.state!==0){bahaRte.toolbar.pasteFormatAction()}setTimeout(function(){bahaRte.utility.getTagStatus();bahaRte.utility.showBalloonbar()},1)},editorOnMouseDown:function(evt){bahaRte.utility.destroyContextMenu();bahaRte.panel.destroyPopupPanel()},editorOnBeforeUnload:function(evt){var text="",html="";html=bahaRte.isPlainText?bahaRte.convertor.toHtml(bahaRte.source.value):bahaRte.doc.body.innerHTML;text=bahaRte.convertor.toText(html);text=text.replace(/\r\n/g,"\n");if(bahaRte.autosave){bahaRte.autosave=bahaRte.autosave.replace(/\r\n/g,"\n")}if(text!=bahaRte.autosave&&html!=bahaRte.config.content){bahaRte.deleteAutosaveFlag=true;return"您的文章尚未備份，\n離開此頁後，你所編輯的內容都將消失！"}},editorOnUnload:function(evt){if(bahaRte.deleteAutosaveFlag){$.ajax({method:"POST",url:"/editor/delAutosave.php",param:"service="+bahaRte.config.service})}},editorOnContextMenu:function(evt){var cells=bahaRte.selection.getSelectedCells();if(!cells){return}var html='<div class="editor__edit-table">'+'<div><a data-id="_bhrte_modifytable" href="javascript:;">設定表格屬性</a></div>'+'<div><a data-id="_bhrte_cellattr" href="javascript:;">設定儲存格寬高</a></div>'+'<div><a id="_bhrte_insertRow" href="javascript:;">插入列</a></div>'+'<div><a id="_bhrte_insertCol" href="javascript:;">插入欄</a></div>'+'<div><a id="_bhrte_deleteRow" href="javascript:;">刪除整列</a></div>'+'<div><a id="_bhrte_deleteCol" href="javascript:;">刪除整欄</a></div>'+'<div><a id="_bhrte_merge" href="javascript:;">合併</a></div>'+'<div><a id="_bhrte_split" href="javascript:;">分割</a></div>'+"</div>";var div=jQuery("<div>").addClass("balloon-editor editor-tool__box");var pos=$("#editor").pos();div.css({"z-index":96,left:pos.x+evt.clientX+"px",top:pos.y+evt.clientY+"px"}).attr("id","_bhrteTableContextMenu").html(html).appendTo("body");jQuery(".editor__edit-table a").click(function(e){var id=jQuery(this).attr("id")||jQuery(this).data("id");switch(id){case"_bhrte_modifytable":case"_bhrte_cellattr":bahaRte.dialog.popupDialog(e);bahaRte.utility.destroyContextMenu();break;case"_bhrte_deleteRow":bahaRte.table.deleteRow();break;case"_bhrte_deleteCol":bahaRte.table.deleteColumn();break;default:}}).mouseover(function(e){var id=jQuery(this).attr("id")||jQuery(this).data("id");switch(id){case"_bhrte_insertRow":case"_bhrte_insertCol":case"_bhrte_merge":case"_bhrte_split":bahaRte.utility.showSubContextMenu(this);break;default:bahaRte.utility.destroySubContextMenu()}});$.event.preventDefault(evt)},destroyContextMenu:function(){jQuery("#_bhrteTableContextMenu").remove();bahaRte.utility.destroySubContextMenu()},showSubContextMenu:function(which){bahaRte.utility.destroySubContextMenu();var html='<div class="editor__edit-table">';switch(which.id.substring(7)){case"insertRow":html+='<div><a href="javascript:bahaRte.table.insertRow(0);">於上</a></div>';html+='<div><a href="javascript:bahaRte.table.insertRow(1);">於下</a></div>';break;case"insertCol":html+='<div><a href="javascript:bahaRte.table.insertColumn(0);">於左</a></div>';html+='<div><a href="javascript:bahaRte.table.insertColumn(1);">於右</a></div>';break;case"merge":html+="<div><a href=\"javascript:bahaRte.table.mergeCell('up');\">向上合併</a></div>";html+="<div><a href=\"javascript:bahaRte.table.mergeCell('down');\">向下合併</a></div>";html+="<div><a href=\"javascript:bahaRte.table.mergeCell('left');\">向左合併</a></div>";html+="<div><a href=\"javascript:bahaRte.table.mergeCell('right');\">向右合併</a></div>";break;case"split":html+='<div><a href="javascript:bahaRte.table.horizontalSplitCell();">分割為上下兩列</a></div>';html+='<div><a href="javascript:bahaRte.table.verticalSplitCell();">分割為左右兩欄</a></div>';break;default:}html+="</div>";var div=jQuery("<div>").addClass("balloon-editor editor-tool__box");var pos=$(which).pos();div.css({"z-index":97,left:pos.x+which.offsetWidth-5+"px",top:pos.y+"px"}).attr("id","_bhrteTableSubContextMenu").html(html).appendTo("body")},destroySubContextMenu:function(evt){jQuery("#_bhrteTableSubContextMenu").remove()},createSourceWindow:function(){var textarea=document.createElement("textarea");jQuery(textarea).attr({name:"source",id:"source"}).addClass("form-control main-editor").hide().on("focus",function(e){jQuery(".BH-menuE,#BH-master,#BH-slave").addClass("editor-is-selected");jQuery("#source").addClass("is-focused");jQuery("#postTips").remove();if(jQuery("#source").hasClass("is-error")){jQuery("#source").removeClass("is-error")}Forum.Post.checkSubboard();Forum.Post.checkTitle()}).on("blur",function(e){jQuery("#source").removeClass("is-focused");Forum.Editor.detectThumbnail()}).on("mouseup",function(){bahaRte.utility.resetTagStatus();bahaRte.panel.destroyPopupPanel()});return textarea},getHomeCss:function(user,ver){user=user.toLowerCase();var num=0;for(var i=0;i<user.length;i++){num+=user.charCodeAt(i)}num=num%100;num=String(num);if(num.length==1){num+="0"+num}if(ver!=parseInt(ver,10))ver="";else ver="?v="+ver;return"https://p2.bahamut.com.tw/HOMECSSNEW/"+num+"/"+user+".css"+ver},initContent:function(){if(bahaRte.doc.initialized){return}var doctype=bahaRte.doc.implementation.createDocumentType("html","-//W3C//DTD XHTML 1.0 Transitional//EN","http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd");bahaRte.doc.insertBefore(doctype,bahaRte.doc.childNodes[0]);var head=bahaRte.doc.createElement("head");var headHtml='<meta http-equiv="Content-Type" content="text/html; charset=utf-8">';if(bahaRte.config.uid&&bahaRte.config.uid!==""){headHtml+='<link type="text/css" rel="stylesheet" href="'+bahaRte.utility.getHomeCss(bahaRte.config.uid,bahaRte.config.version)+'">'}headHtml+='<link type="text/css" rel="stylesheet" href="'+bahaRte.constants.editorCssUrl+'baharte_editor.css?_=2">';headHtml+='<link type="text/css" rel="stylesheet" href="'+bahaRte.constants.editorCssUrl+'forum_editor.css?_=4">';if(Cookies.get("ckForumDarkTheme")=="yes"){headHtml+='<link type="text/css" rel="stylesheet" href="'+bahaRte.constants.editorCssUrl+'forum_editor_dark.css?_=2">'}head.innerHTML=headHtml;if(bahaRte.doc.documentElement.childNodes[0]&&bahaRte.doc.documentElement.childNodes[0].tagName=="HEAD"){bahaRte.doc.documentElement.replaceChild(head,bahaRte.doc.documentElement.childNodes[0])}else{bahaRte.doc.documentElement.appendChild(head)}var body=bahaRte.doc.createElement("body");body.className="editstyle";var defaultContent;if($.browser.ie){defaultContent="<p></p>"}else{defaultContent="<p><br></p>"}var html="";if(bahaRte.config.bahacode){if(bahaRte.config.content){html=bahaRte.convertor.toHtml(bahaRte.config.content)}}else{html=bahaRte.convertor.parseHtmlCode(bahaRte.config.content)}if(bahaRte.doc.documentElement.childNodes[1]&&bahaRte.doc.documentElement.childNodes[1].tagName=="BODY"){bahaRte.doc.documentElement.replaceChild(body,bahaRte.doc.documentElement.childNodes[1])}else{bahaRte.doc.documentElement.appendChild(body)}bahaRte.doc.body.innerHTML=html||defaultContent;Forum.Editor.detectThumbnail(true);setTimeout(function(){html&&bahaRte.win.focus()},1);if(bahaRte.setupAutoHeight){bahaRte.rteHeightWatcher()}var view=$.cookie.get("ckBhrteView");if(bahaRte.getAutosaveFlag){$.ajax({method:"POST",url:"/editor/getAutosave.php",param:"service="+bahaRte.config.service,success:function(responseText){if(!responseText.inArray(["","NO_LOGIN","ERROR"])){bahaRte.toolbar.refreshContent();let oriHTML=bahaRte.convertor.toHtml(bahaRte.source.value);let newHTML=bahaRte.convertor.toHtml(responseText);if(oriHTML==newHTML){html&&bahaRte.win.focus();return}bahaRte.autosave=responseText;Dialogify.confirm("是否載入自動儲存的內容？<br>按「確定」載入，按「取消」將不會載入",{ok:function(){view=="bahacode"&&bahaRte.toolbar.alternateView();if(bahaRte.isPlainText){bahaRte.source.value=responseText;bahaRte.source.focus()}else{bahaRte.doc.body.innerHTML=bahaRte.convertor.toHtml(responseText);bahaRte.win.focus()}},cancel:function(){html&&bahaRte.win.focus()}})}}})}if(bahaRte.checkViewFlag){view=="bahacode"&&bahaRte.toolbar.alternateView()}bahaRte.undo.backup();jQuery(bahaRte.win).on("focus",function(e){jQuery(".BH-menuE,#BH-master,#BH-slave").addClass("editor-is-selected");jQuery("#editor").addClass("is-focused");jQuery("#postTips").remove();if(jQuery("#editor").hasClass("is-error")){jQuery("#editor").removeClass("is-error")}Forum.Post.checkSubboard();Forum.Post.checkTitle()}).on("blur",function(e){jQuery("#editor").removeClass("is-focused");Forum.Editor.detectThumbnail()}).on("click",function(e){Forum.Editor.hidePanel()});bahaRte.doc.body.addEventListener("paste",function(e){var text;if(window.clipboardData){text=window.clipboardData.getData("Text")}else{text=e.clipboardData.getData("text/plain")}Forum.Editor.onPaste(e,text);setTimeout(function(){bahaRte.utility.getTagStatus();bahaRte.utility.showBalloonbar()},1)});$(bahaRte.doc).mousedown(bahaRte.utility.editorOnMouseDown).mouseup(bahaRte.utility.editorOnMouseUp).keyup(bahaRte.utility.editorOnKeyUp);if($.browser.ie){$(bahaRte.doc).keydown(bahaRte.undo.undoKeyHandler)}window.onbeforeunload=bahaRte.utility.editorOnBeforeUnload;window.onunload=bahaRte.utility.editorOnUnload;bahaRte.config.content=bahaRte.doc.body.innerHTML;bahaRte.doc.initialized=true},loadBackup:function(){if(!bahaRte.loadBackupFlag){return false}if(bahaRte.isPlainText){bahaRte.source.value=bahaRte.autosave}else{bahaRte.doc.body.innerHTML=bahaRte.convertor.toHtml(bahaRte.autosave)}document.getElementById("_bhrte_statusbar").innerHTML="&nbsp;";bahaRte.win.focus()},manualSave:function(){if(!bahaRte.utility.save()){alert("目前文章內容空白或你沒有編輯新的內容，不需儲存。")}},save:function(){if(!bahaRte.autosaveFlag){return false}var text="";if(bahaRte.isPlainText){text=bahaRte.convertor.toHtml(bahaRte.source.value);bahaRte.doc.body.innerHTML=text;text=bahaRte.convertor.toText(text)}else{text=bahaRte.convertor.toText(bahaRte.doc.body.innerHTML)}if(text==bahaRte.autosave||text.trim()===""||text.trim()=="[div][/div]"||text=="[div] [/div]"||bahaRte.config.content==bahaRte.doc.body.innerHTML){clearTimeout(bahaRte.autosaveTimer);bahaRte.autosaveTimer=setTimeout(bahaRte.utility.save,bahaRte.constants.autosaveTick);return false}var realLength=text.replace(/\r?\n/g,"\r\n").utf8Length();if(realLength>5e5){return false}var warningMsg="";if(realLength>bahaRte.constants.maxContentLength){warningMsg='，<span style="color:red;">已超過字數上限!</span>'}$.ajax({method:"POST",param:"content="+encodeURIComponent(text)+"&service="+bahaRte.config.service,url:"/editor/autosave.php",success:function(responseText){if(responseText=="DONE"){var date=new Date;date=date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate()+" "+date.getHours()+":"+date.getMinutes();bahaRte.statusbar.html("草稿已儲存於 "+date+"，共 "+realLength+" 個 byte"+warningMsg);bahaRte.autosave=text;bahaRte.loadBackupFlag=true;bahaRte.deleteAutosaveFlag=false}else if(responseText=="NO_LOGIN"){egg.msgbox("你的帳號已被系統登出<br />請自行備份你的文章後重新登入。",{height:"100px",buttons:egg.msgbox.OK,onOk:function(){egg.msgbox.close()}})}},fail:function(status){}});clearTimeout(bahaRte.autosaveTimer);bahaRte.autosaveTimer=setTimeout(bahaRte.utility.save,bahaRte.constants.autosaveTick);bahaRte.autosaveFlag=false;setTimeout(function(){bahaRte.autosaveFlag=true},1e4);return true},resizable:function(){var dragging=false;var resizer=document.createElement("div");var root=egg.body();jQuery(resizer).addClass("editor-resizer").attr({unselectable:"on",title:"按住滑鼠左鍵拖曳可改變編輯區域大小"}).css({position:"absolute",left:0,right:0,"background-image":"none"}).insertAfter("#source").mousedown(function(evt){evt.preventDefault();var maskW=root.clientWidth>root.scrollWidth?root.clientWidth:root.scrollWidth;var maskH=root.clientHeight>root.scrollHeight?root.clientHeight:root.scrollHeight;dragging=true;jQuery(document.createElement("div")).attr({id:"editorResizerHoverDiv",unselectable:"on"}).css({"background-color":"black",position:"absolute","z-index":101,width:maskW+"px",height:maskH+"px",left:"0px",top:"0px",cursor:"n-resize",opacity:0}).mousemove(function(evt){if(!dragging){return}evt.preventDefault();var scrollTop=window.pageYOffset||root.scrollTop||document.body.scrollTop||0;var target=Cookies.get("ckBhrteView")=="bahacode"?bahaRte.source:bahaRte.config.target;var height=evt.clientY+scrollTop-jQuery(target).offset().top;var sourceHeight=height;var adjustHeight=2;if(document.compatMode&&document.compatMode=="CSS1Compat"){adjustHeight=5}sourceHeight-=adjustHeight;if(height<100){return}jQuery(bahaRte.config.target).css("height",height+"px");jQuery(bahaRte.source).css("height",sourceHeight+"px")}).mouseup(function(evt){dragging=false;jQuery("#editorResizerHoverDiv").remove()}).appendTo(document.body)})}},dialog:{popupDialog:function(evt){var target=jQuery(evt.target||window.event.srcElement);if(!target.data("id")){target=target.parents("[data-id]")}var service=target.data("id")=="colorselector"?target.data("id"):target.data("id").substring(7);if(($.browser.ie||$.browser.ie11)&&service.inArray(["modifytable","cellattr"])){bahaRte.previousSel=bahaRte.selection.getRange()}switch(service){case"movie":Forum.Editor.showVideoDialog();break;case"table":case"modifytable":Forum.Editor.showTableDialog();break;case"cellattr":Forum.Editor.showTableCellDialog();break;case"createlink":Forum.Editor.showLinkDialog();break;case"colorselector":Forum.Editor.showColorDialog();break;default:}bahaRte.utility.keepSelection(evt)},show:function(content){var id=content.substring(0,content.indexOf("::"));var selection=bahaRte.selection;var cursor=bahaRte.utility.cursor;var focusNode=null,data,i;content=content.substring(content.indexOf("::")+2);$.lightbox(content,{className:"BH-popup",css:{visibility:"hidden"},closeTrigger:bahaRte.dialog.destroyPopupDialog});var okButton=document.getElementById("_bhrte_btnOk");if($.browser.ie&&bahaRte.previousSel){bahaRte.previousSel.select()}if($.browser.ie11&&bahaRte.previousSel){var curSel=bahaRte.win.getSelection();curSel.removeAllRanges();curSel.addRange(bahaRte.previousSel)}switch(id){case"createlink":data=selection.getSelectedAnchorInfo();var imageData=selection.getSelectedImageInfo();document.getElementById("_bhrte_linkurl").value=data.url;if(data.text===""&&!imageData.isImage&&!data.isLink){egg("#_bhrte_displayText").show()}if(data.isLink){document.getElementById("_bhrte_displayUnlink").style.display="block"}focusNode=document.getElementById("_bhrte_linkurl");break;case"insertimage":data=selection.getSelectedImageInfo();if(data.isImage&&data.movie===""&&!data.emotion){document.getElementById("_bhrte_imageurl").value=decodeURI(data.url)}else{var selText=bahaRte.selection.getSelectedText();if(selText.match(/^http[s]?:\/\/(?:.*?)\.(?:jpg|jpeg|gif|png)(?:\?[^\?]*)?$/i)){document.getElementById("_bhrte_imageurl").value=selText}}focusNode=document.getElementById("_bhrte_imageurl");break;case"colorselector":var isBg=jQuery(".editor-button.editor-button__s.is-active").prev("button").attr("id")=="_bhrte_bgcolor";document.getElementById("_bhrte_isBg").value=isBg;bahaRte.panel.destroyPopupPanel();var hex=["00","33","66","99","cc","ff"];var html='<table cellpadding="0" cellspacing="0">';var index=0;var mover="javascript:document.getElementById('_bhrte_previewColor').style.backgroundColor=document.getElementById('_bhrte_previewHex').innerHTML=bahaRte.utility.switchColor(this.style.backgroundColor);";var mout="javascript:document.getElementById('_bhrte_previewColor').style.backgroundColor='transparent';document.getElementById('_bhrte_previewHex').innerHTML=''";var click="javascript:document.getElementById('_bhrte_selectedColor').style.backgroundColor=document.getElementById('_bhrte_selectedColorText').value=bahaRte.utility.switchColor(this.style.backgroundColor);";for(i=0;i<hex.length;i++){for(var j=0;j<hex.length;j++){for(var k=0;k<hex.length;k++){if(index%18===0){html+="<tr>"}html+='<td style="cursor:'+cursor+";font-size:0px;width:15px;height:15px;background-color:#"+hex[i]+hex[j]+hex[k]+';" onmouseover="'+mover+'" onmouseout="'+mout+'" onclick="'+click+'">&nbsp;</td>';index++;if(index%18===0){html+="</tr>"}}}}html+="<tr>";for(i=0;i<18;i++){var color=i<6?"#"+hex[i]+hex[i]+hex[i]:"#000000";html+='<td style="cursor:'+cursor+";font-size:0px;width:15px;height:15px;background-color:"+color+';" onmouseover="'+mover+'" onmouseout="'+mout+'" onclick="'+click+'">&nbsp;</td>'}html+="</tr></table>";document.getElementById("_bhrte_colortable").innerHTML=html;var state=bahaRte.utility.getTagStatus(true);var bit=isBg?bahaRte.constants.tagState.BACKGROUNDCOLOR:bahaRte.constants.tagState.FORECOLOR;var list=isBg?state.bgcolorList:state.colorList;if(state.state&bit){document.getElementById("_bhrte_selectedColor").style.backgroundColor=list[0];document.getElementById("_bhrte_selectedColorText").value=list[0]}focusNode=document.getElementById("_bhrte_btnOk");break;case"movie":data=selection.getSelectedImageInfo();if(data.isImage&&data.movie!==""){document.getElementById("_bhrte_movieCode").value=data.movie;bahaRte.dialog.previewMovie()}focusNode=document.getElementById("_bhrte_movieCode");break;case"table":focusNode=document.getElementById("_bhrte_tbrow");break;case"modifytable":var table=bahaRte.selection.getSelectedNode();while(!table.nodeName.inArray(["table","body"],true)){table=table.parentNode}if(table.nodeName.equals("table")){var align=table.getAttribute("align")||0;var height=$(table).css("height")||table.getAttribute("height")||"";var width=$(table).css("width")||table.getAttribute("width")||"";var alignMap={0:0,left:1,center:2,right:3};$("#_bhrte_tbrow,#_bhrte_tbcol").attr("disabled","true").val("");$("#_bhrte_tbborder").get(0).selectedIndex=parseInt(table.getAttribute("border"),10)||0;$("#_bhrte_tbalign").get(0).selectedIndex=alignMap[align];$("#_bhrte_tbcellpadding").val(parseInt(table.getAttribute("cellPadding"),10)||"");$("#_bhrte_tbcellspacing").val(parseInt(table.getAttribute("cellSpacing"),10)||"");$("#_bhrte_tbwidth").val(width.replace("px","").replace("%",""));$("#_bhrte_tbheight").val(height.replace("px",""));$("#_bhrte_tbIsModify").val("yes");$("p.bahaRte_title").html("設定表格屬性");focusNode=document.getElementById("_bhrte_btnOk")}break;case"cellattr":var td=bahaRte.selection.getSelectedCells();if(td){td=td[0];var height=$(td).css("height")||td.getAttribute("height")||"";var width=$(td).css("width")||td.getAttribute("width")||"";$("#_bhrte_cellwidth").val(width.replace("px","").replace("%",""));$("#_bhrte_cellheight").val(height.replace("px",""))}focusNode=document.getElementById("_bhrte_cellwidth");break;case"acg":data=selection.getSelectedAnchorInfo();if(data.isAcg){var matches=data.url.match(bahaRte.constants.serviceUrl.acgPattern);document.getElementById("_bhrte_acgtext").value=matches[1];document.getElementById("_bhrte_displayUnlink").style.display="block"}focusNode=document.getElementById("_bhrte_acgtext");break;case"wiki":data=selection.getSelectedAnchorInfo();if(data.isWiki){if(bahaRte.config.service=="guildwiki"){matches=data.url.match(bahaRte.constants.serviceUrl.guildWikiUrlPattern)}else{matches=data.url.match(bahaRte.constants.serviceUrl.wikiUrlPattern)}document.getElementById("_bhrte_wikitext").value=matches[2];document.getElementById("_bhrte_wikilabel").value=data.text;document.getElementById("_bhrte_displayUnlink").style.display="block"}if(data.text===""&&!data.isLink){egg("#_bhrte_displayText").show()}focusNode=document.getElementById("_bhrte_wikitext");break;case"uploadimage":var imageUrl="";data=selection.getSelectedImageInfo();if(data.isImage&&data.movie===""&&!data.emotion){imageUrl=decodeURI(data.url)}else{var selText=bahaRte.selection.getSelectedText();if(selText.match(/^http[s]?:\/\/(?:.*?)\.(?:jpg|jpeg|gif|png)(?:\?[^\?]*)?$/i)){imageUrl=selText}}if(imageUrl!==""){egg("#bhImgImageUrl").val(imageUrl);egg(":radio[name=bhImgMode][value=3]").attr("checked",true).click();focusNode=document.getElementById("bhImgImageUrl")}break;case"uploadimageforwiki":document.getElementById("_bhrte_wikiNamespace").value=bahaRte.config.wikiNamespace;break;case"uploadimageforguildwiki":document.getElementById("_bhrte_wikiNamespace").value=bahaRte.config.wikiNamespace;var wikiName=bahaRte.config.wikiNamespace.split(":");wikiName=wikiName[1]||"";egg("input[type=text]").val(wikiName);break;case"imageforwiki":break;default:}egg("#egg_box").css("visibility","visible");$.lightbox.refresh();if(focusNode){focusNode.focus()}},previewMovie:function(){var target=document.getElementById("_bhrte_previewMovie");var code=document.getElementById("_bhrte_movieCode").value;var c=bahaRte.constants.movieData;var matches,flag=false,data,key;var paramAry,matches_y,movieArgs,i;for(key in c.code){if(matches=code.match(c.code[key])){switch(key){case"youtube":case"newtube":data={which:key,url:matches[3],w:425,h:344};if((key=="youtube"||key=="newtube")&&matches[4]){paramAry=matches[4].replace(/\&amp;/,"&").split(/\&/);movieArgs="";for(i=0;i<paramAry.length;i++){if(paramAry[i].match(/hd=1/)){movieArgs+="&hd=1"}if(paramAry[i].match(/fs=1/)){movieArgs+="&fs=1"}if(matches_y=paramAry[i].match(/start=(\d+)/)){movieArgs+="&start="+matches_y[1]}if(paramAry[i].match(/rel=0/)){movieArgs+="&rel=0"}}if(movieArgs!=""){data.url+="?"+movieArgs.substring(1)}}break;case"xuite":data={which:key,url:matches[1],w:425,h:344};if(key=="xuite"&&matches[2]){paramAry=matches[2].replace(/\&amp;/,"&").split(/\&/);movieArgs="";for(i=0;i<paramAry.length;i++){if(paramAry[i].match(/as=1/)){movieArgs+="&as=1"}if(paramAry[i].match(/ar=1/)){movieArgs+="&ar=1"}if(matches_y=paramAry[i].match(/volume=(\d+)/)){movieArgs+="&volume="+matches_y[1]}}if(movieArgs!=""){data.url+="?"+movieArgs.substring(1)}}break;case"nico":data={which:key,url:matches[1],w:490,h:370};break;case"twitchChannel":data={which:key,w:425,h:344};data.url={host:"twitch",channel:matches[2]};break;case"twitchVideo":var videoParam=matches[2].match(/(c|b|v)([\d]+)/);data={which:key,w:425,h:344};data.url={host:"twitch",videoType:videoParam[1],vid:videoParam[2]};break;case"livehouse":data={which:key,url:matches[3],w:425,h:344};break;case"facebook":data={which:key,channel:matches[1],vid:matches[2],w:425,h:238};break;case"soapbox":case"yam":case"wretch":case"yamMusic":Forum.Editor.dialogInst.$buttonList[1].disable();return}flag=true;target.innerHTML=bahaRte.utility.getMovieCode(data);target.style.display="block";Forum.Editor.dialogInst.$buttonList[1].enable();break}}if(flag){return}for(key in c.url){if(matches=code.match(c.url[key])){if(key==="soapbox"||key==="yam"||key==="wretch"||key==="yamMusic"){continue}flag=true;data={which:key,url:matches[1],w:425,h:344};if((key=="youtube"||key=="newtube"||key=="sharetube"||key=="shortstube")&&matches[2]){movieArgs="";paramAry=matches[2].split(/\&|#|\&#/);for(i=0;i<paramAry.length;i++){if(paramAry[i].match(/hd=1/)){movieArgs+="&hd=1"}if(paramAry[i].match(/fs=1/)){movieArgs+="&fs=1"}if(paramAry[i].match(/fmt=(?:35|22)/)){movieArgs+="&hd=1"}if(matches_y=paramAry[i].match(/t=(\d+)/)){movieArgs+="&start="+matches_y[1]}if(paramAry[i].match(/rel=0/)){movieArgs+="&rel=0"}}if(movieArgs!=""){data.url+="?"+movieArgs.substring(1)}}else if(key=="xuite"&&matches[2]){movieArgs="";paramAry=matches[2].split(/\&|#|\&#/);for(i=0;i<paramAry.length;i++){if(paramAry[i].match(/ar=1/)){movieArgs+="&ar=1"}if(paramAry[i].match(/as=1/)){movieArgs+="&as=1"}if(matches_y=paramAry[i].match(/volume=(\d+)/)){movieArgs+="&volume="+matches_y[1]}}if(movieArgs!=""){data.url+="?"+movieArgs.substring(1)}}else if((key==="twitch"||key==="twitchChannel")&&matches[1]){if(key==="twitch"){data.which="twitchVideo";var videoParam=matches[1].match(/([bcv]?)([\d]+)/);data.url={host:"twitch",videoType:videoParam[1]?videoParam[1]:"v",vid:videoParam[2]}}else{data.which="twitchChannel";data.url={host:"twitch",channel:matches[1]}}}else if(key==="facebook"&&matches[1]&&matches[2]){data.channel=matches[1];data.vid=matches[2];data.h=238}target.innerHTML=bahaRte.utility.getMovieCode(data);target.style.display="block";Forum.Editor.dialogInst.$buttonList[1].enable();break}}if(!flag){Forum.Editor.dialogInst.$buttonList[1].disable();jQuery(target).empty().hide()}},setColor:function(evt){var isBg=document.getElementById("_bhrte_isBg").value;var color=bahaRte.utility.switchColor(document.getElementById("_bhrte_selectedColorText").value);if(color===""||color=="transparent"){alert("您尚未選擇顏色");return}bahaRte.dialog.destroyPopupDialog("pdcolorselector");if(isBg=="true"){bahaRte.toolbar.setBackgroundColor(color)}else{bahaRte.toolbar.setForeColor(color)}},destroyPopupDialog:function(){try{document.body.removeChild(document.getElementById("bhrte_tip"));document.body.removeChild(document.getElementById("bhrte_tipmask"))}catch(e){}var youtubeIframe=egg("#egg_box").find(".youtube-player");if(youtubeIframe.size()){youtubeIframe.get(0).src="about:blank"}$.lightbox.close();if(Forum.Editor.dialogInst&&Forum.Editor.dialogInst.isOpen()){Forum.Editor.dialogInst.close();Forum.Editor.restoreSelection()}bahaRte.win.focus();if($.browser.ie&&bahaRte.previousSel){bahaRte.previousSel.select()}if($.browser.ie11&&bahaRte.previousSel){var curSel=bahaRte.win.getSelection();curSel.removeAllRanges();curSel.addRange(bahaRte.previousSel)}}},panel:{destroyPopupPanel:function(){},getPanelContent:function(id){var itemPerRow,items,html,i;var cursor=bahaRte.utility.cursor;switch(id){case"_bhrte_font":case"_bhrte_fontlabel":case"_bhrte_fonttable":items=bahaRte.constants.allowFontName;html='<table cellpadding="1">';for(i in items){html+='<tr><td class="bahaRte_btn_out" onmousedown="javascript:bahaRte.utility.keepSelection(event);" onmouseup="javascript:bahaRte.toolbar.setFont(event);" onmouseover="javascript:this.className=\'bahaRte_btn_over\';" onmouseout="javascript:this.className=\'bahaRte_btn_out\';" id="'+items[i]+'" style="cursor:'+cursor+";color:black;font-size:12px;font-family:"+items[i]+';">'+items[i]+"</td></tr>"}html+="</table>";break;case"_bhrte_size":var hoverAction=" onmouseover=\"javascript:this.className='bahaRte_btn_over';\" onmouseout=\"javascript:this.className='bahaRte_btn_out';\"";items=bahaRte.constants.allowFontSize.label;var size=["10px","13px","15px","18px","24px","32px"];var showRange={max:5,min:bahaRte.config.wikiNamespace?0:1};html='<table cellpadding="0" cellspacing="0">';for(i=showRange.min;i<=showRange.max;i++){html+='<tr><td class="bahaRte_btn_out" onmousedown="javascript:bahaRte.utility.keepSelection(event);"'+hoverAction+' onmouseup="javascript:bahaRte.toolbar.setSize(event);" id="'+size[i]+'" style="cursor:'+cursor+";color:black;font-size:"+size[i]+';">'+items[i]+"</td></tr>"}html+="</table>";break;case"_bhrte_forecolordropdown":case"_bhrte_bgcolordropdown":var eventName=id.indexOf("bgcolor")!=-1?"setBackgroundColor":"setForeColor";itemPerRow=8;items=bahaRte.constants.colorTable;var defaultColor="#464646";if(id.indexOf("bgcolor")!=-1){defaultColor="transparent"}html='<table cellspacing="0" cellpadding="2"><tr>';html+='<tr><td onmousedown="javascript:bahaRte.utility.keepSelection(event);" onmouseup="javascript:bahaRte.toolbar.'+eventName+"('"+defaultColor+'\');" class="bahaRte_btn_out" onmouseover="javascript:this.className=\'bahaRte_btn_over\';" onmouseout="javascript:this.className=\'bahaRte_btn_out\';" colspan="'+itemPerRow+'" style="cursor:'+cursor+';"><table cellpadding="0" cellspacing="0" width="100%"><tr><td style="font-size:0px;width:20px;"><div style="background-color:'+defaultColor+';width:13px;height:13px;border:solid 1px gray;">&nbsp;</div></td><td align="center" style="font-size:12px;color:black;">自動</td></tr></table></td></tr>';for(i=0;i<items.length;i++){if(i%itemPerRow===0){html+="<tr>"}html+='<td onmousedown="javascript:bahaRte.utility.keepSelection(event);" onmouseup="javascript:bahaRte.toolbar.'+eventName+"('"+items[i]+'\');" class="bahaRte_btn_out" onmouseover="javascript:this.className=\'bahaRte_btn_over\';" onmouseout="javascript:this.className=\'bahaRte_btn_out\';" style="cursor:'+cursor+';font-size:0px;" align="center" valign="center"><div style="background-color:'+items[i]+';width:13px;height:13px;border:solid 1px gray;">&nbsp;</div></td>';if((i+1)%itemPerRow===0){html+="</tr>"}}html+='<tr><td colspan="'+itemPerRow+'" id="colorselector" onmousedown="javascript:bahaRte.utility.keepSelection(event);" onmouseup="javascript:bahaRte.dialog.popupDialog(event);" class="bahaRte_btn_out" onmouseover="javascript:this.className=\'bahaRte_btn_over\';" onmouseout="javascript:this.className=\'bahaRte_btn_out\';" style="color:black;cursor:'+cursor+';" align="center">更多顏色...</td>';html+="</table>";break;case"_bhrte_emotion":html="";var emoSetCount=[11,12,10,10];var emoName=1;for(i in emoSetCount){html+='<table cellspacing="0" cellpadding="2"><tr>';for(var j=0;j<emoSetCount[i];j++){var eid=j+emoName;html+='<td id="emo'+eid+'" class="bahaRte_btn_out" onmousedown="javascript:bahaRte.utility.keepSelection(event);" onmouseup="javascript:bahaRte.toolbar.insertEmotion(event);" onmouseover="javascript:this.className=\'bahaRte_btn_over\';" onmouseout="javascript:this.className=\'bahaRte_btn_out\';" style="cursor:'+cursor+';"><img style="display:block;visibility:visible;" src="'+bahaRte.constants.emotionUrl+eid+'.gif" id="emo'+eid+'" /></td>'}html+="</tr></table>";emoName+=emoSetCount[i]}break;case"_bhrte_heading":case"_bhrte_headingtd":case"_bhrte_headinglabel":case"_bhrte_headingtable":var label=["","大標","中標","小標"];html='<table cellpadding="1">';for(i=1;i<=3;i++){html+='<tr><td id="h'+i+'" class="bahaRte_btn_out" onmousedown="javascript:bahaRte.utility.keepSelection(event);" onmouseup="javascript:bahaRte.toolbar.insertHeading(event);" onmouseover="javascript:this.className=\'bahaRte_btn_over\';" onmouseout="javascript:this.className=\'bahaRte_btn_out\';" style="cursor:'+cursor+';font-size:12px;color:black;">'+label[i]+"</td></tr>"}html+="</table>";break;default:}return html},popupPanel:function(evt){var target=window.event?window.event.srcElement:evt.target;var div=document.createElement("div");div.id="popup"+target.id;div.style.fontSize="12px";div.style.border="solid 1px #b3d4d5";div.style.padding="5px";div.style.backgroundColor="white";div.style.position="absolute";div.style.zIndex=99;bahaRte.popupList.push(div);$(div).mousedown(bahaRte.utility.keepSelection);var pos;switch(target.id){case"_bhrte_font":case"_bhrte_fonttable":pos=bahaRte.utility.getPosition(document.getElementById("_bhrte_fontlabel"),true);break;case"_bhrte_heading":case"_bhrte_headingtable":pos=bahaRte.utility.getPosition(document.getElementById("_bhrte_headinglabel"),true);break;default:pos=bahaRte.utility.getPosition(target,true)}div.style.top=pos.y+"px";div.style.left=pos.x+"px";div.innerHTML=bahaRte.panel.getPanelContent(target.id);document.body.appendChild(div)}},buttonSet:{get:function(setName){var ary=bahaRte.buttonSet[setName]();var nameList=[];for(var i in ary){nameList.push(ary[i].id)}nameList=bahaRte.utility.createMap(nameList);bahaRte.buttonSetName=setName;return{button:ary,nameList:nameList}},simple:function(){var tb=bahaRte.toolbar;var ary=[tb.size,tb.bold,tb.italic,tb.underline,tb.foreColor,tb.bgColor,tb.divide,tb.link,tb.uploadImage,tb.movie,tb.emotion,tb.divide,tb.wiki,tb.acg];return ary},advance:function(){var tb=bahaRte.toolbar;var ary=[tb.font,tb.size,tb.divide,tb.bold,tb.italic,tb.underline,tb.strike,tb.divide,tb.foreColor,tb.bgColor,tb.divide,tb.link,tb.uploadImage,tb.movie,tb.emotion,tb.table,tb.divide,tb.wiki,tb.acg,tb.newline,tb.heading,tb.divide,tb.unorderedList,tb.orderedList,tb.indent,tb.outdent,tb.hr,tb.divide,tb.left,tb.center,tb.right,tb.divide,tb.copyFormat,tb.removeFormat,tb.removeAll,tb.divide,tb.undo,tb.redo];return ary},simpleWithoutImage:function(){var tb=bahaRte.toolbar;var ary=bahaRte.buttonSet.simple();tb.uploadImage.disabled=true;return ary},advanceWithoutImage:function(){var tb=bahaRte.toolbar;var ary=bahaRte.buttonSet.advance();tb.uploadImage.disabled=true;return ary},simpleWithoutMovie:function(){var tb=bahaRte.toolbar;var ary=bahaRte.buttonSet.simple();tb.movie.disabled=true;return ary},advanceWithoutMovie:function(){var tb=bahaRte.toolbar;var ary=bahaRte.buttonSet.advance();tb.movie.disabled=true;return ary},simpleWithoutImageAndMovie:function(){var tb=bahaRte.toolbar;var ary=bahaRte.buttonSet.simple();tb.uploadImage.disabled=true;tb.movie.disabled=true;return ary},advanceWithoutImageAndMovie:function(){var tb=bahaRte.toolbar;var ary=bahaRte.buttonSet.advance();tb.uploadImage.disabled=true;tb.movie.disabled=true;return ary},simpleForWiki:function(){var tb=bahaRte.toolbar;var ary=[tb.heading,tb.size,tb.bold,tb.italic,tb.underline,tb.foreColor,tb.bgColor,tb.divide,tb.link,tb.uploadImageForWiki,tb.imageForWiki,tb.movie,tb.emotion,tb.divide,tb.wiki,tb.acg];return ary},advanceForWiki:function(){var tb=bahaRte.toolbar;var ary=[tb.font,tb.size,tb.divide,tb.bold,tb.italic,tb.underline,tb.strike,tb.divide,tb.foreColor,tb.bgColor,tb.divide,tb.link,tb.uploadImageForWiki,tb.imageForWiki,tb.movie,tb.emotion,tb.table,tb.divide,tb.wiki,tb.acg,tb.newline,tb.heading,tb.divide,tb.unorderedList,tb.orderedList,tb.indent,tb.outdent,tb.hr,tb.divide,tb.left,tb.center,tb.right,tb.divide,tb.copyFormat,tb.removeFormat,tb.removeAll,tb.divide,tb.undo,tb.redo];return ary},simpleForGuildWiki:function(){var tb=bahaRte.toolbar;var ary=[tb.heading,tb.size,tb.bold,tb.italic,tb.underline,tb.foreColor,tb.bgColor,tb.divide,tb.link,tb.uploadImageForGuildWiki,tb.imageForGuildWiki,tb.movie,tb.emotion,tb.divide,tb.wiki,tb.acg];return ary},advanceForGuildWiki:function(){var tb=bahaRte.toolbar;var ary=[tb.font,tb.size,tb.divide,tb.bold,tb.italic,tb.underline,tb.strike,tb.divide,tb.foreColor,tb.bgColor,tb.divide,tb.link,tb.uploadImageForGuildWiki,tb.imageForGuildWiki,tb.movie,tb.emotion,tb.table,tb.divide,tb.wiki,tb.acg,tb.newline,tb.heading,tb.divide,tb.unorderedList,tb.orderedList,tb.indent,tb.outdent,tb.hr,tb.divide,tb.left,tb.center,tb.right,tb.divide,tb.copyFormat,tb.removeFormat,tb.removeAll,tb.divide,tb.undo,tb.redo];return ary}},undo:{backup:function(){if(bahaRte.isPlainText||!$.browser.ie){return}if(bahaRte.undoFlag){var removedStack=bahaRte.undoStack.stack.splice(bahaRte.undoPosition,bahaRte.undoStack.stack.length-bahaRte.undoPosition);var removedRange=bahaRte.undoStack.range.splice(bahaRte.undoPosition,bahaRte.undoStack.range.length-bahaRte.undoPosition);for(var i=0;i<removedStack.length;i++){delete removedStack[i];delete removedRange[i]}}var content=bahaRte.doc.body.innerHTML;var last=bahaRte.undoStack.stack[bahaRte.undoStack.stack.length-1];var flag=false;var bookmark=null;if(content!=last){bahaRte.undoStack.stack.push(content);if(bahaRte.selection.getSelection().type!="Control"){bookmark=bahaRte.selection.getRange().getBookmark()}bahaRte.undoStack.range.push(bookmark);if(bahaRte.undoStack.stack.length>bahaRte.constants.maxUndoSteps+1){bahaRte.undoStack.stack.shift();bahaRte.undoStack.range.shift()}flag=true}bahaRte.undoPosition=bahaRte.undoStack.stack.length;bahaRte.undoFlag=false;return flag},undo:function(){if(bahaRte.isPlainText){return}if(bahaRte.undoStack.stack.length){if(bahaRte.undoPosition===0){return}if(bahaRte.undoFlag===false){var flag=bahaRte.undo.backup();if(flag){bahaRte.undoPosition--}}bahaRte.doc.body.innerHTML=bahaRte.undoStack.stack[--bahaRte.undoPosition];var range=bahaRte.selection.getRange();if(bahaRte.undoStack.range[bahaRte.undoPosition]){range.moveToBookmark(bahaRte.undoStack.range[bahaRte.undoPosition])}range.select();bahaRte.undoFlag=true}},redo:function(){if(bahaRte.isPlainText){return}if(bahaRte.undoPosition+1>=bahaRte.undoStack.stack.length){return}bahaRte.doc.body.innerHTML=bahaRte.undoStack.stack[++bahaRte.undoPosition];var range=bahaRte.selection.getRange();if(bahaRte.undoStack.range[bahaRte.undoPosition]){range.moveToBookmark(bahaRte.undoStack.range[bahaRte.undoPosition])}range.select();bahaRte.undoFlag=true},undoKeyHandler:function(){evt=bahaRte.win.event;if(evt.ctrlKey&&evt.keyCode==90){bahaRte.undo.undo();evt.returnValue=false}else if(evt.ctrlKey&&evt.keyCode==89){bahaRte.undo.redo();evt.returnValue=false}else if(evt.ctrlKey&&evt.keyCode==86){bahaRte.undo.backup()}else if(evt.keyCode==13){if(navigator.userAgent.toLowerCase().indexOf("kkman3.0")!=-1){var nid="bhrte_new_node"+(new Date).getTime();bahaRte.selection.getRange().pasteHTML('<br id="'+nid+'" />');var node=bahaRte.doc.getElementById(nid);bahaRte.selection.selectNode(node);bahaRte.selection.collapse(false);evt.returnValue=false}bahaRte.undo.backup()}else if((evt.keyCode==8||evt.keyCode==46)&&!bahaRte.selection.isCollapsed()){bahaRte.undo.backup()}}}};