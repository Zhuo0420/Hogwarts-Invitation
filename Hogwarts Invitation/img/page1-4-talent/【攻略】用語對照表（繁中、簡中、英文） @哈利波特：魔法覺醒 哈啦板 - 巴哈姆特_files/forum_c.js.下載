(function($,window){var ForumC={bindEditor:function(){var iframe=$("#editor").contents();iframe.on("click",function(){checkIsLogin()});$("#editor").on("adjustHeight",function(e,height){if(height!=120){$("#editor").height(height)}else{$("#editor").outerHeight(height)}})},onTipsClick:function(){if(checkIsLogin()==true){var elem=bahaRte.isPlainText?bahaRte.source:bahaRte.win;jQuery(elem).focus()}},bindOptionMenuTippy:function(){tippy(".tippy-option-menu:not([aria-expanded])",{content:window.document.getElementById("optionMenu").innerHTML,allowHTML:true,placement:"top",arrow:true,interactive:true,hideOnClick:false,theme:"light",offset:[0,5],duration:240,onShow:instance=>{var popper=instance.popper;var elem=instance.reference;var data=$(elem).data("tippy");$(popper).find("a:eq(0)").attr("href",function(){var url="C.php?bsn="+data["bsn"]+"&snA="+data["snA"];return data["readingAuthor"]?url:url+"&s_author="+data["author"]}).html(function(){return data["readingAuthor"]?"顯示全部文章":"看他的文"});$(popper).find("a:eq(1)").off("click").on("click",function(e){instance.hide();FORUM_homeBookmark(data["area"],data["bsn"],data["sn"],data["title"],data["dc_c1"],data["dc_c2"],data["dc_type"],data["dc_machine"],data["dc_name"])});$(popper).find("a:eq(2)").off("click").on("click",function(e){instance.hide();accuse_step1(data["bsn"],data["sn"],"1",data["donateIsOpen"])});$(popper).find("a:eq(3)").off("click").on("click",function(e){instance.hide();pdel(data["sn"])});$(popper).find("a:eq(4)").off("click").on("click",function(e){instance.hide();pmodify(data["snA"],data["sn"],1)});$(popper).find("a:eq(5)").off("click").on("click",function(e){instance.hide();FORUM_homeBookmark(data["area"],data["bsn"],data["sn"],data["title"],data["dc_c1"],data["dc_c2"],data["dc_type"],data["dc_machine"],data["dc_name"])});let commentFollowButton=$(popper).find("a:eq(6)");fetch(`https://api.gamer.com.tw/forum/v1/comment_follow_check.php?bsn=${data["bsn"]}&snB=${data["sn"]}`,{credentials:"include"}).then(resp=>resp.json()).then(json=>{if(json.error){throw new Error(json.error.message)}if(json.data.followStatus){commentFollowButton.html("取消卡留言")}else{commentFollowButton.html("卡留言")}}).catch(reason=>{$(popper).find("ul:eq(3)").hide();console.error(reason)});commentFollowButton.off("click").on("click",function(){let csrf=new Bahamut.Csrf;csrf.setCookie();let formData=new FormData;formData.append("bsn",data["bsn"]);formData.append("snB",data["sn"]);fetch("https://api.gamer.com.tw/forum/v1/comment_follow_toggle.php",{method:"post",body:formData,headers:csrf.getFetchHeaders(),credentials:"include"}).then(resp=>resp.json()).then(json=>{if(json.error){throw new Error(json.error.message)}if(json.data.followStatus){commentFollowButton.html("取消卡留言")}else{commentFollowButton.html("卡留言")}}).catch(reason=>{Dialogify.alert(reason)})});$(popper).find("a:eq(7)").off("click").on("click",function(e){instance.hide();ForumC.embed(data["title"],data["bsn"],data["sn"])});if(data["area"]=="G2"){$(popper).find("ul:eq(0)").hide();$(popper).find("ul:eq(1)").hide();$(popper).find("ul:eq(3)").hide()}else{$(popper).find("ul:eq(2)").hide();data["owner"]&&$(popper).find("ul:eq(1)").show()||$(popper).find("ul:eq(1)").hide()}}})},bindManageMenuTippy:function(){tippy(".tippy-manage-menu:not([aria-expanded])",{content:window.document.getElementById("manageMenu").innerHTML,allowHTML:true,placement:"top",arrow:true,interactive:true,hideOnClick:false,theme:"light",duration:240,onShow:instance=>{var popper=instance.popper;var elem=instance.reference;var data=$(elem).data("tippy");$(popper).find("a:eq(0)").off("click").on("click",function(e){instance.hide();del(data["sn"])});$(popper).find("a:eq(1)").off("click").on("click",function(e){instance.hide();Dialogify.confirm("水桶同時請注意文章是否需要刪除，確定要水桶了嗎？",{ok:function(){FORUM_water(data["bsn"],data["author"],"1","https://forum.gamer.com.tw/Co.php?bsn="+data["bsn"]+"&sn="+data["sn"])}})});$(popper).find("a:eq(2)").off("click").on("click",function(e){instance.hide();M(data["sn"])});$(popper).find("a:eq(3)").off("click").on("click",function(e){instance.hide();gather(data["sn"])});$(popper).find("a:eq(4)").off("click").on("click",function(e){instance.hide();location.href="BMADMIN/index.php?bsn="+data["bsn"]+"&p="+data["parent"]});if(data["area"]=="G2"){$(popper).find("ul:eq(0)").hide()}else{$(popper).find("ul:eq(1)").hide();data["isBM"]&&$(popper).find("li:eq(0), li:eq(1)").show()||$(popper).find("li:eq(0), li:eq(1)").hide()}}})},bindPostInfoTippy:function(){tippy(".tippy-post-info:not([aria-expanded])",{content:window.document.getElementById("postInfo").innerHTML,allowHTML:true,placement:"bottom",arrow:true,interactive:true,delay:[600,300],theme:"light",hideOnClick:false,offset:[0,5],duration:240,onShow:instance=>{var elem=instance.reference;var ip=$(elem).data("hideip");var mtime=$(elem).data("mtime");$(instance.popper).find("p:eq(0)").text(ip).end().find("p:eq(1)").text(mtime);var elemIp=$(instance.popper).find("li:eq(0)");$(elem).data("area")=="G2"&&elemIp.hide()||elemIp.show()}})},bindReplyMenuTippy:function(root){var elems=$(root||"body").find(".tippy-reply-menu:not([aria-expanded])").get();tippy(elems,{content:window.document.getElementById("replyMenu").innerHTML,allowHTML:true,placement:"bottom-end",arrow:true,interactive:true,trigger:"click",theme:"light",animateFill:false,offset:[0,5],duration:240,onShow:instance=>{var popper=instance.popper;var elem=instance.reference;var data=$(elem).parents(".c-reply__item").data("comment");var items=$(popper).find("a");items.removeAttr("style");if($(elem).parents(".c-reply__item").find(".content-edit").length){items.off("click").css("color","#999");return}$(popper).find("a:eq(2)").off("click").on("click",function(e){instance.hide();if(data["isLogin"]){return showaccuseCommend(data["bsn"],data["snB"],data["sn"],"1")}else{location.href="https://user.gamer.com.tw/login.php"}});var del=$(popper).find("a:eq(1)");if(data["deletable"]){del.parent("li").show();del.off("click").on("click",function(e){instance.hide();return delCommend(data["bsn"],data["snB"],data["sn"])})}else{del.off("click").parent("li").hide()}var edit=$(popper).find("a:eq(0)");if(data["editable"]){edit.parent("li").show();edit.off("click").on("click",function(e){instance.hide();editComment(elem)})}else{edit.off("click").parent("li").hide()}}})},bindSimpleTippy:function(){tippy('.tippy-gpbp:not([data-gtm="贊助"]), .usercareer, .userrace, .usergp',{delay:600,duration:240,touch:"hold",theme:"gpbp",allowHTML:true});tippy(".tippy-guild-flag",{delay:600,duration:240,touch:"hold",theme:"gpbp"})},bindGpBpListTippy:function(){tippy(".tippy-gpbp-list",{content:'<div id="gpbpList"></div>',allowHTML:true,placement:"bottom-start",arrow:true,trigger:"click",theme:"light",interactive:true,duration:240,maxWidth:"460px",onShow:instance=>{$(instance.popper).find(".tippy-content #gpbpList").html('<img src="https://i2.bahamut.com.tw/mobile/loading.svg">');var data=$(instance.reference).data("tippy");gpbpList(instance.popper,data,1)}})},showDonateHint:function(){if(Cookies.get("ck_forumCDonateShowHint")==="yes"){return}let $target=$(".buttonbar_dontate").first();if($target.length===0){return}let $hint=$(`
                <div id="driver-popover-item" style="display: block;">
                    <div class="driver-popover-tip left position-center"></div>
                    <div class="driver-popover-title">☆★ 支持創作 X 立即贊助 ★☆</div>
                    <div class="driver-popover-description">透過「贊助」支持創作者、鼓勵好文持續輸出！</div>
                    <div class="driver-clearfix driver-popover-footer" style="display: block;">
                        <button class="driver-close-btn driver-close-only-btn">我知道了</button>
                    </div>
                </div>
            `);$hint.css({left:$target.get(0).offsetLeft+$target.width()+20}).find("button").click(()=>{Cookies.set("ck_forumCDonateShowHint","yes",{expires:365,path:"/",domain:".gamer.com.tw"});$hint.hide()});$hint.appendTo($target)},bindDonorListTippy:function(){tippy(".tippy-donor-list",{content:'<div id="donorList"></div>',allowHTML:true,placement:"top",arrow:true,trigger:"click",theme:"light",interactive:true,duration:240,maxWidth:"460px",onShow:instance=>{$(instance.popper).find(".tippy-content #donorList").html('<img src="https://i2.bahamut.com.tw/mobile/loading.svg">');var data=$(instance.reference).data("tippy");donorList(instance.popper,data,1)}})},bindArticleFooterButtonHover:function(){$(".article-footer_right-btn").hover(function(){let img=$(this).find("img");img.attr("src",img.data("hover-src"))},function(){let img=$(this).find("img");img.attr("src",img.data("src"))})},bindCommentGpBpListTippy:function(root){root=root||"body";var elems=[];$(root).find(".gp-count:not([aria-expanded]), .bp-count:not([aria-expanded])").each(function(){if(!isNaN(parseInt($(this).text(),10))){elems.push(this)}});if(elems.length==0){return}tippy(elems,{content:'<div id="gpbpList"></div>',allowHTML:true,placement:"bottom-start",arrow:true,trigger:"click",theme:"light",interactive:true,duration:240,maxWidth:"460px",onShow:instance=>{$(instance.popper).find(".tippy-content #gpbpList").html('<img src="https://i2.bahamut.com.tw/mobile/loading.svg">');var elem=$(instance.reference);var type=elem.hasClass("gp-count")?TYPE_GP:TYPE_BP;var data=elem.parents(".c-reply__item").data("comment");commentGpBpList(instance.popper,type,data,1)}})},bindCommentWarningTippy:function(){tippy(".reply-input:not([aria-expanded])",{trigger:"manual",arrow:true,hideOnClick:"toggle"})},bindCommentDateTippy:function(root){var elem=$(root||"body").find(".reply-content__footer .edittime[data-tippy-content]").get();tippy(elem,{trigger:"click",duration:240,theme:"gpbp"})},bindTemplateList:function(){$(".add-template_c").click(function(e){$(".add-template_box").toggle();$(".add-template_box").find("img").addClass("lazypreload");$(".add-template_c").toggleClass("is-active");if($(".add-template_c").hasClass("is-active")){$(".add-template_c").html('<i class="fa fa-minus"></i>關閉範本</button>');$(".add-template_c").attr("title","關閉範本")}else{$(".add-template_c").html('<i class="fa fa-plus"></i>插入範本</button>');$(".add-template_c").attr("title","插入範本")}});$(".toolbarBtn").click(function(e){if($(this).hasClass("add-template_c")==false&&$(".add-template_c").hasClass("is-active")){$(".add-template_box").toggle();$(".add-template_c").toggleClass("is-active");$(".add-template_c").html('<i class="fa fa-plus"></i>插入範本</button>');$(".add-template_c").attr("title","插入範本")}});tippy(".tippy-template",{content:'<div id="templatePreview"></div>',allowHTML:true,arrow:false,animation:"fade",offset:[0,5],placement:"top",theme:"light",onShow:instance=>{var previewItem=$(instance.reference).find(".c-post__template__item").clone();previewItem.css("display","");let $popper=$(instance.popper);$popper.addClass("tippy-popper-template").find("#templatePreview").html(previewItem)}})},initCommentInput:function(elem){var editing=$(elem).parents(".c-reply__item").length;$(elem||".reply-input > .content-edit").click(function(e){var sn=$(this).data("snb");commentLoginCheck(sn);tourComment(this)}).keypress(function(e){if(!Cookies.get("BAHAID")){return}var bsn=$(this).data("bsn");var snB=$(this).data("snb");var snC=$(this).data("snc")||0;switch(e.which||e.keyCode){case 13:e.preventDefault();if(tagListTippyShown){$(e.target._tippy.popper).find(".tag-user.active").click()}else{postComment(this,bsn,snB,snC)}break;default:}}).keydown(function(e){if(!Cookies.get("BAHAID")){return}switch(e.which||e.keyCode){case 38:case 40:if(tagListTippyShown){e.preventDefault();$popper=$(e.target._tippy.popper);selectTagItem($popper,(e.which||e.keyCode)==38?"-1":"+1")}break;case 27:if(editing&&!tagListTippyShown){ForumC.editCommentCancel(this)}break;default:}}).keyup(function(e){if(!Cookies.get("BAHAID")){return}var keyCode=e.which||e.keyCode;if(!(keyCode==38||keyCode==40)){showTagListTippy(this,keyCode)}}).on("input focus",function(e){commentLimitCheck(this,85);commentAutoSize(this)})},showHonor:function(){const honorData=window.honorData();const honorTypeShouldShowDialog=[3,4];const avatarDomain="avatar1.gamer.com.tw";const imgDomain="p2.bahamut.com.tw";$(".c-user__honor").each(function(i,elem){if(!$(elem).data("honors")){return}let honors=$(elem).data("honors").toString().split(",");honors.forEach(honorType=>{if(honorType==""||honorType==0){return}let url='href="javascript:;"';let userid=$(elem).data("userid");let hasLink=honorData[honorType][1]==1;if(hasLink){if(honorTypeShouldShowDialog.includes(parseInt(honorType,10))){url=`href="javascript:showHonorDialog('${userid}', ${honorType})"`}else{url=`href="https://${avatarDomain}/switchhonor.php?uid=${userid}&htype=${honorType}" target="_blank"`}}let html=`<a ${url}><img src="https://${imgDomain}/HOME/honor/${honorType}.gif${honorData[honorType][2]}" title="${honorData[honorType][0]}"/></a>`;$(elem).append(html)})})},commentFormatter:function(elems){elems=$(elems);elems.each(function(index){var elem=$(this);if(elem.data("formatted")=="yes"){return}var html=elem.parents("[data-comment]").data("comment").content;html=html.replace(/https?:\/\/[!#-&(-;=?-Z\^-~]+/gi,function(url){var youtube=/^https?:\/\/(?:www\.)?youtube\.com\/(?:watch\?v=|shorts|live\/)([0-9a-zA-Z_-]{11})(?:&(t=[hms0-9]+))?/;var sharetube=/^https?:\/\/youtu\.be\/([0-9a-zA-Z_-]{11})(?:\?(t=[hms0-9]+))?/;var facebook=/^https?:\/\/www\.facebook\.com\/(\w+)\/videos\/(\d+)\//;var matches,snippet;var detectUrl=url.replace(/(?:&quot;|&#0?39;|&lt;|&gt;)/g,function(match){var mapping={"&quot;":'"',"&lt;":"<","&gt;":">","&#039;":"'","&#39;":"'"};return mapping[match]});if(/^https:\/\/[^"'<>]+?\.(?:jpe?g|gif|png)(?:\?w=[0-9]+)?$/i.test(detectUrl)){snippet='<img class="lazyload" data-src="'+url+'">';if(!/^(?:https:\/\/im\.bahamut\.com\.tw\/sticker\/\d+\/\d+\.png|https:\/\/i2\.bahamut\.com\.tw\/editor\/emotion\/\d+\.gif)/.test(detectUrl)){snippet=`<a class="photoswipe-image" target="_blank" href="${url}">${snippet}</a>`}}else if(matches=url.match(youtube)||url.match(sharetube)){elem.addClass("forum-reply-video");snippet='<a target="_blank" href="https://www.youtube.com/watch?v='+matches[1]+(matches[2]?"&"+matches[2]:"")+'">';snippet+='<img src="https://i2.bahamut.com.tw/icon_videoplayer.svg">';snippet+='<div style="width: 120px; height: 90px; background-image: url(https://img.youtube.com/vi/'+matches[1]+'/default.jpg);"></div></a>'}else if(matches=url.match(facebook)){elem.addClass("forum-reply-video");snippet='<a target="_blank" href="https://www.facebook.com/'+matches[1]+"/videos/"+matches[2]+'/">';snippet+='<img src="https://i2.bahamut.com.tw/icon_videoplayer.svg">';snippet+='<div style="width: 120px; height: 90px; background-image: url(https://graph.facebook.com/'+matches[2]+'/picture); background-position: center;"></div></a>'}else{snippet='<a target="_blank" onclick="Forum.C.refurl(this);" href="'+url+'">'+url+"</a>"}return snippet});html=html.replace(/(^|\s+)#([0-9]+)/g,function(match,space,to){var bsn=window.location.search.match(/bsn=([0-9]+)/);var snA=window.location.search.match(/snA=([0-9]+)/);if(bsn&&snA){var replacement=space+'<a href="https://forum.gamer.com.tw';replacement+=window.location.pathname;replacement+="?bsn="+bsn[1]+"&snA="+snA[1]+"&to="+to+'">#'+to+"</a>";return replacement}return match});html=html.replace(/\[([a-zA-Z][a-zA-Z0-9]{1,11}):([^\]]*)\]/g,function(tag,userid,nickname){return'<a target="_blank" href="https://home.gamer.com.tw/'+userid+'">'+nickname+"</a>"});html=html.replace(/\#(B\d+):(\d+)\#/g,function(floorData,floor,snC){let commentParent=elem.parent().closest('[name="comment_parent"]').data("comment");var floorTag=floor+"("+commentParent[floor]+")";if(commentParent[floor]==null){floorTag=floor}return'<a href="javascript:Forum.C.openCommentDialog('+commentParent.bsn+", "+commentParent.snB+","+snC+');">'+floorTag+"</a>"});elem.attr("data-formatted","yes").html(html)})},openCommentDialog:function(bsn,snB,snC){var params={bsn:bsn,snB:snB,snC:snC,type:"pc"};$.ajax({url:"https://api.gamer.com.tw/forum/v1/comment_get.php",method:"get",data:params,dataType:"json",xhrFields:{withCredentials:true}}).done(function(data){if(data.error){toastr.warning(data.error.message,"",{tapToDismiss:true});return}let html=$(data.data.comment.html);html.find(".buttonbar").remove();html.find(".tippy-reply-menu").remove();let id="Dialog_"+html.prop("id");html.prop("id",id);new Dialogify(html.prop("outerHTML")).showModal();ForumC.commentFormatter("#"+id+" .reply-content__article > span")})},refurl:function(anchor){if(!anchor.href.match(/^https?:\/\/ref\.gamer\.com\.tw/)){anchor.href="https://ref.gamer.com.tw/redir.php?url="+encodeURIComponent(anchor.href)}},dockedTitle:function(){var menu=$(".BH-menu");var wrapper=$("#BH-wrapper");var fixedHeader=$(".c-fixed--header");var fixedMenu=$(".c-fixed--header .c-menu");var barHeight=$(".TOP-data").height();var menuHeight=menu.outerHeight();var triggerTop=Math.max(menu.offset().top-barHeight,0);var wrapperMarginTop=menu.outerHeight(true);menu.addClass("box-shadow__soft");if($(".bh-banner").height()==0){wrapperMarginTop+=barHeight}var prevScrollTop=0;if(menu.hasClass("fixed")){menu.removeClass("fixed").removeAttr("style");wrapper.css("marginTop",0);triggerTop=Math.max(menu.offset().top-barHeight,0);menu.addClass("fixed");menu.css("top",barHeight-menuHeight);menu.removeClass("box-shadow__soft");wrapper.css("marginTop",wrapperMarginTop);fixedHeader.show();fixedMenu.addClass("is-scroll is-switch")}var onScroll=function(){var scrollTop=$(window).scrollTop();if(scrollTop>triggerTop&&!menu.hasClass("fixed")){menu.addClass("fixed");fixedHeader.show();fixedMenu.addClass("is-scroll is-switch")}else if(scrollTop<=triggerTop&&menu.hasClass("fixed")){menu.removeClass("fixed").removeAttr("style");fixedHeader.hide();fixedMenu.removeClass("is-scroll is-switch")}if(menu.hasClass("fixed")){if(prevScrollTop>scrollTop&&!fixedMenu.hasClass("is-switch")){menu.css("top",barHeight);menu.addClass("box-shadow__soft");fixedMenu.addClass("is-switch")}else if(prevScrollTop<scrollTop&&fixedMenu.hasClass("is-switch")){menu.css("top",barHeight-menuHeight);menu.removeClass("box-shadow__soft");fixedMenu.removeClass("is-switch")}}prevScrollTop=scrollTop};$(function(){menuHeight=menu.outerHeight();$(window).off("scroll",BahamutMenu.onScroll).on("scroll",onScroll);onScroll()})},elevator:function(event,bsn,snA){event=event||window.event;if(event.keyCode==13){var to=parseInt((event.target||event.srcElement).value,10);if(!isNaN(to)){if($("[data-floor="+to+"]").length){var elem=$("[data-floor="+to+"]:visible").parents(".c-post, .c-disable");var scrollTop=elem.offset().top-130;jQuery("html, body").scrollTop(scrollTop);elem.css("animation","2s highlight")}else{var loc=window.location;loc.href="https://"+loc.host+loc.pathname+"?bsn="+bsn+"&snA="+snA+"&to="+to}}}},toggleDisplayImage:function(){if(Cookies.get("ckForumShrinkMedia")=="yes"){Cookies.remove("ckForumShrinkMedia",{domain:"gamer.com.tw"});Forum.Common.expandAll();$(".BH-menu-forumA-right.dropList dl dd:nth-last-child(3) a").text("關閉圖片影片")}else{Cookies.set("ckForumShrinkMedia","yes",{expires:365,domain:"gamer.com.tw"});window.location.reload()}},tourC:function(){if(isBot()){return}var tour=new Shepherd.Tour({defaults:{classes:"shepherd-theme-arrows",showCancelLink:true}});tour.on("start",function(){showOverlay()});tour.on("complete",function(){removeOverlay();window.scroll({top:0,left:0,behavior:"smooth"})});tour.on("cancel",function(){removeOverlay()});var tourList=[{text:"文中的”圖片／影片”想預設 開 或 關？<br>圖片開關，方便你隨心所欲自由切換。",attachTo:{element:".btn-loadpic",on:"bottom"},title:"圖片開關",buttons:{text:"我知道了",action:tour.next},scrollTo:true,scrollToHandler:function(){window.scroll({top:0,left:0,behavior:"smooth"})}},{text:"不管是”看他的文、收藏文章、檢舉違規”<br>還是”編輯、刪除”自己的文章，全收納在”點點點”。",attachTo:{element:".tippy-option-menu",on:"right"},title:"單篇更多功能“點點點",buttons:{text:"我知道了",action:tour.next},scrollTo:true,scrollToHandler:function(){window.scroll({top:$(".tippy-option-menu:first").offset().top-240,left:0,behavior:"smooth"})}},{text:"1. 輸入指定樓數，「電梯」就能帶你快速前往！<br>2. 返回文章列表<br>3. 回頁面上方",attachTo:{element:".jumpfloor",on:"left"},title:"常駐動線",buttons:{text:"我知道了",action:tour.next},when:{show:function(){if($(".c-fixed--header:visible").length>0){tour.addStep("stepFixedHeader",{text:"討論串功能置頂顯示，讓你不管看到哪，都能隨時使用。<br>這裡也有圖片開關唷！",attachTo:".c-fixed--header bottom",title:"置頂標題工具列",buttons:{text:"我知道了",action:tour.next}})}}}},{text:"1. 免換頁，快速回文最方便。<br>2. 連結／圖片連結／影片連結皆可無腦貼上，不需要另外插入。<br>3. 寫到哪編到哪，將文字反白即可直接顯示功能選項。",attachTo:{element:".c-editor",on:"top"},title:"快速回覆區直覺式編輯",buttons:{text:"我知道了",action:tour.next},scrollTo:true,scrollToHandler:function(){window.scroll({top:$(".c-editor__input:first").offset().top-240,left:0,behavior:"smooth"})}}];if(tourList.length>0){for(var i in tourList){if($(tourList[i].attachTo.element).length){tour.addStep("step"+(i+1),tourList[i])}}tour.start()}},tagUser:function(sn,userid,nickname,snC){var selector="textarea[data-snb="+sn+"]";selector+=snC?"[data-snc="+snC+"]":":not([data-snc])";var textarea=$(selector).get(0);textarea.focus();var start=textarea.value.lastIndexOf("@",textarea.selectionStart);if(start==-1){start=textarea.selectionStart}var end=textarea.selectionEnd;var before=textarea.value.substring(0,start);var after=textarea.value.substring(end,textarea.value.length);nickname=nickname.replace("[","&#91;").replace("]","&#93;");textarea.value=before+"["+userid+":"+nickname+"]"+after;start=textarea.value.length-after.length;textarea.setSelectionRange(start,start);commentAutoSize(textarea);if(tagListTippyShown){tagListTippy.hide()}ga("send","event","互動","哈啦區","標記")},replyToFloor:function(snB,snC,floor){if(floor==undefined||floor==0){return}var selector="textarea[data-snb="+snB+"]";selector+=":not([data-snc])";var textarea=$(selector).get(0);textarea.focus();var start=textarea.value.lastIndexOf("@",textarea.selectionStart);if(start==-1){start=textarea.selectionStart}var end=textarea.selectionEnd;var before=textarea.value.substring(0,start);var after=textarea.value.substring(end,textarea.value.length);textarea.value=before+"#B"+floor+":"+snC+"# "+after;start=textarea.value.length-after.length;textarea.setSelectionRange(start,start);commentAutoSize(textarea)},commentGp:function(elem){var data=$(elem).parents(".c-reply__item").data("comment");commentGpBp(elem,TYPE_GP,data)},commentBp:function(elem){var data=$(elem).parents(".c-reply__item").data("comment");commentGpBp(elem,TYPE_BP,data)},commentRestoreGpBp:function(bsn,snB,snC){var id=bsn+"_"+snB+"_"+snC;toastr.clear(TOASTRES[id],{force:true});delete TOASTRES[id];getCSRFToken().done(function(token){var params={token:token,bsn:bsn,snB:snB,snC:snC};$.post("/ajax/comment_restore_gpbp.php",params,function(json){if(json.message){toastr.warning(json.message,"",{tapToDismiss:true});return}commentGpBpUpdate(json.type,json.snC,-1);toastr.info("您的動作已復原","",{tapToDismiss:true})})})},unfoldComment:function(elem){$(elem).parent().next().show(400).end().remove()},editCommentCancel:function(elem){var layout=$(elem).parents(".c-reply__item");let tippy=layout.find(".reply-input").get(0)._tippy;tippy.hide();layout.find(".reply-content").html(editingCommentHtml);ForumC.bindCommentGpBpListTippy(layout);ForumC.bindCommentDateTippy(layout)},insertImage:function(elem){if(window.User&&window.User.Login&&!window.User.Login.requireLoginIframe()){return}if(elem instanceof HTMLElement){elem=$(elem).parents(".reply-input").find("textarea")}else{elem="#editor"}var dialog=new Bahamut.TruthImage;dialog.setEditor(elem);dialog.showDialog()},showAd:function(isBanner,bsn){let adUnitPath="/1017768/AD_desktopweb_forum_c_article_banner";let adUnitPath2="/1017768/AD_desktopweb_forum_c_article_banner_2";let AD_ID="ad-native-c";let AD_ID2="ad-native-c-2";let adSize=[[728,90]];let adHtml=`
                <section class="c-section" style="display:none;">
                    <div class="c-section__main">
                        <div class="c-post__header" id="${AD_ID}" style="padding-left:18px; padding-top:2px; margin-bottom:0px;">
                        </div>
                    </div>
                </section>
            `;let adHtml2=`
                <section class="c-section" style="display:none;">
                    <div class="c-section__main">
                        <div class="c-post__header" id="${AD_ID2}" style="padding-left:18px; padding-top:2px; margin-bottom:0px;">
                        </div>
                    </div>
                </section>
            `;googletag.cmd.push(function(){$(".c-section[id^=post_]:eq(0)").after(adHtml);let slots=[];slots.push(googletag.defineSlot(adUnitPath,adSize,AD_ID).addService(googletag.pubads()).setTargeting("bsn",bsn).setTargeting("service","forum"));if($(".c-section[id^=post_]:eq(1)").length){$(".c-section[id^=post_]:eq(1)").after(adHtml2);slots.push(googletag.defineSlot(adUnitPath2,adSize,AD_ID2).addService(googletag.pubads()).setTargeting("bsn",bsn).setTargeting("service","forum"))}let bahalv=Cookies.get("BAHALV")||"";if(bahalv){for(const slot of slots){slot.setTargeting("LV",bahalv)}}if(Cookies.get("ckForumDarkTheme")=="yes"){for(const slot of slots){slot.setTargeting("Theme","dark")}}window.DFP.setTargeting();googletag.pubads().addEventListener("slotRenderEnded",function(e){if(e.slot.getSlotElementId()==AD_ID||e.slot.getSlotElementId()==AD_ID2){let section=$("#"+e.slot.getSlotElementId()).parents("section.c-section");if(e.isEmpty){section.remove()}else{section.fadeIn(200)}}});googletag.enableServices();for(const slot of slots){googletag.display(slot)}})},embed:function(title,bsn,sn){var embedUrl="https://forum.gamer.com.tw/embed.php?bsn="+bsn+"&sn="+sn;var content='<h1 class="re-c-post__header__title postembed__title">'+title+"</h1>";content+='<div class="postembed-url">';content+='<div class="input-box">';content+='<a href="" class="clearall"></a>';content+='<textarea id="embedCode" type="text" class="form-control" readonly>&lt;iframe src="'+embedUrl+'" width="100%" height="350" frameborder="0" allowtransparency="true"&gt;&lt;/iframe&gt;</textarea>';content+="</div>";content+='<iframe id="embedPreview" src="'+embedUrl+'&preview" width="100%" height="350" frameborder="0" allowtransparency="true"></iframe></div>';new Dialogify(content,{dialog:{style:{width:"540"}}}).title("文章嵌入碼").buttons([{type:Dialogify.BUTTON_PRIMARY,text:"複製代碼",click:function(e){window.document.querySelector("#embedCode").select();window.document.execCommand("copy")}}]).showModal()},donate:function(elem,bsn,snA,snB){if(!window.donateDialog){window.donateDialog={}}if(window.donateDialog[`${bsn}_${snB}`]){window.donateDialog[`${bsn}_${snB}`].reopenDialog()}else{window.donateDialog[`${bsn}_${snB}`]=new Bahamut.Donate({area:"forum",bsn:bsn,snA:snA,snB:snB},{onDonateSuccess:donateSuccess,loginReturnUrlParameter:`#donate${snB}`});window.donateDialog[`${bsn}_${snB}`].init()}},gotoPostPage:function(bsn,snA,subbsn,sn=0){let form=$("<form></form>");form.attr("method","post");if(sn===0){form.attr("action",`post1.php?bsn=${bsn}&type=2&snA=${snA}&subbsn=${subbsn}`)}else{form.attr("action",`post1.php?bsn=${bsn}&type=2&snA=${snA}&subbsn=${subbsn}&sn=${sn}&re=1`)}text=bahaRte.convertor.toText(bahaRte.doc.body.innerHTML);if(text.trim()===""||text.trim()=="[div][/div]"||text=="[div] [/div]"||text=="[div]\n[/div]"){$("body").append(form);form.submit();return}let realLength=text.replace(/\r?\n/g,"\r\n").utf8Length();if(realLength>bahaRte.constants.maxContentLength){Dialogify.alert("已超過字數上限!");return}let field=$("<input></input>");field.attr("type","hidden");field.attr("name","CPageContent");field.attr("value",text);form.append(field);$("body").append(form);form.submit()},toggleThreadFollow:function(bsn,snA){let csrf=new Bahamut.Csrf;csrf.setCookie();let formData=new FormData;formData.append("bsn",bsn);formData.append("snA",snA);fetch("https://api.gamer.com.tw/forum/v1/thread_follow_toggle.php",{method:"post",body:formData,headers:csrf.getFetchHeaders(),credentials:"include"}).then(resp=>{return resp.json()}).then(json=>{if(json.error){throw new Error(json.error.message)}if(json.data.followStatus){toastr.success(json.data.message,"",{positionClass:"toast-bottom-center"})}else{toastr.warning(json.data.message,"",{positionClass:"toast-bottom-center"})}}).catch(error=>{Dialogify.alert(error.message)})}};const TYPE_GP=1;const TYPE_BP=2;var TAG_DATA={};var TOASTRES={};var tagListTippy=null;var tagListTippyShown=false;var editingCommentHtml;var tagListTippyOptions={content:'<div class="tag-list"><img src="https://i2.bahamut.com.tw/mobile/loading.svg"></div>',allowHTML:true,placement:"bottom",trigger:"manual",interactive:true,theme:"light",zIndex:2,sticky:true,onShow:instance=>{tagListTippyShown=true;var elem=instance.reference;tagList(elem)},onShown:instance=>{var elem=instance.reference;elem.focus()},onHidden:instance=>{tagListTippyShown=false}};if(window.Quill){var sizes=Quill.import("attributors/style/size");sizes.whitelist=["13px","18px","24px","32px"];Quill.register(sizes,true)}function showOverlay(){$("<div />").addClass("tour-overlay").attr("id","tourOverlay").appendTo("body")}function removeOverlay(){$("#tourOverlay").remove()}function isBot(){return/bot|googlebot|crawler|spider|robot|crawling/i.test(window.navigator.userAgent)}function matchVideoUrl(url){var youtube=/^https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([0-9a-zA-Z_-]{11})(?:.*(?:&(?:t|time_continue)=(\d+)))?/;var youtubeShare=/^https?:\/\/youtu\.be\/([0-9a-zA-Z_-]{11})(?:.*(?:(?:&|\?)(?:t|time_continue)=(\d+)))?/;var youtubeShorts=/^https?:\/\/(?:www\.)?youtube\.com\/(?:shorts|live)\/([0-9a-zA-Z_-]{11})/;var twitch=/^https?:\/\/www\.twitch\.tv\/([a-zA-Z0-9_-]+)/;var twitchVod=/^https?:\/\/www\.twitch\.tv\/videos\/([0-9]+)/;var xuite=/^https?:\/\/vlog\.xuite\.net\/play\/([a-zA-Z0-9+\/=]+)/;var nico=/^https?:\/\/www\.nicovideo\.jp\/watch\/((?:sm|nm|ca|cd|ax|yo|nl|ig|na|cw|za|zb|zc|zd|ze|om|sk|yk|so|am|fz)[0-9]{1,14}|[0-9]{10})/;var livehouse=/^https:\/\/livehouse\.in\/channel\/(\w+)/;var facebook=/^https:\/\/www\.facebook\.com\/(\w+)\/videos\/(\d+)\//;var matches;if(matches=url.match(youtube)||url.match(youtubeShare)||url.match(youtubeShorts)){var ytUrl="https://www.youtube.com/watch?v="+matches[1];if(matches[2]){ytUrl+="&t="+matches[2]}return ytUrl}else if(matches=url.match(twitchVod)){return null}else if(matches=url.match(twitch)||url.match(xuite)||url.match(nico)||url.match(livehouse)||url.match(facebook)){return matches[0]}return null}function gpbpList(popper,data,page){$.ajax({type:"GET",url:"/ajax/GPBPlist.php",data:{t:data["type"],bsn:data["bsn"],snB:data["sn"],p:page},dataType:"json",success:function(json){var div=$(popper).find(".tippy-content #gpbpList");var prev,next;if(json["status"]=="F"){div.text(json["msg"])}else{var list=JSON.parse(json["u"]);var html="";for(var userid in list){html+='<a target="_blank" href="https://home.gamer.com.tw/'+userid+'">';html+='<img class="gamercard" data-gamercard-userid="'+userid+'" src="'+list[userid]["avatar"]+'"></a>'}if(json["page"]){html+='<div class="buttons">';if(json["page"]["p"]){prev=function(){gpbpList(popper,data,json["page"]["p"])};html+='<button id="gpbpListPrev" type="button" class="btn--sm btn--normal">上一頁</button>'}if(json["page"]["n"]){next=function(){gpbpList(popper,data,json["page"]["n"])};html+='<button id="gpbpListNext" type="button" class="btn--sm btn--normal">下一頁</button>'}html+="</div>"}div.html(html)}$(popper).find("#gpbpListPrev").off("click").on("click",prev||function(){});$(popper).find("#gpbpListNext").off("click").on("click",next||function(){})}})}function donorList(popper,data,page){let donation_id=`${data["bsn"]}_${data["snB"]}`;fetch(`https://api.gamer.com.tw/donate/v1/donor_list.php?donation_id=${donation_id}&page=${page}&area=forum`,{credentials:"include"}).then(resp=>resp.json()).then(json=>{if(json.error){throw new Error(json.error.message)}let content=$(popper).find(".tippy-content #donorList");if(parseInt(json.data.totalItemNum,10)==0){content.html("贊助支持他持續輸出！");return}let contentHtml=`<div class="donate-list">
              <h5>
                <img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/PjxzdmcgdmVyc2lvbj0iMS4xIiBpZD0iJiN4NTcxNjsmI3g1QzY0O18xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCIgdmlld0JveD0iMCAwIDEyIDEwIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCAxMiAxMDsiIHhtbDpzcGFjZT0icHJlc2VydmUiPjxnPjxyZWN0IHk9IjEiIHN0eWxlPSJmaWxsOiM4RDhEOEQ7IiB3aWR0aD0iMyIgaGVpZ2h0PSIzIi8+PHJlY3QgeT0iNyIgc3R5bGU9ImZpbGw6IzhEOEQ4RDsiIHdpZHRoPSIzIiBoZWlnaHQ9IjMiLz48cmVjdCB4PSIzIiB5PSI0IiBzdHlsZT0iZmlsbDojOEQ4RDhEOyIgd2lkdGg9IjMiIGhlaWdodD0iMyIvPjwvZz48L3N2Zz4=">
                這些勇者覺得不贊不行
              </h5>`;let rank=(page-1)*parseInt(json.data.pageRows,10)+1;json.data.donorList.forEach(donor=>{let rankMark="";if(rank<=3){rankMark=`no0${rank}`}contentHtml+=`<div class="donate-list-item"><div><span>${rank}</span>`;if(donor.lowerUserid==="sysop"){contentHtml+=`<a class="${rankMark}">`;contentHtml+=`<img src="${donor.avatar}">`;contentHtml+="<p>神秘贊助者<small>&nbsp;</small></p></a></div></div>"}else{contentHtml+=`<a class="${rankMark}" target="_blank" href="https://home.gamer.com.tw/${donor.lowerUserid}">`;contentHtml+=`<img class="gamercard" data-gamercard-userid="${donor.lowerUserid}" src="${donor.avatar}">`;contentHtml+=`<p>${donor.nick}<small>${donor.lowerUserid}</small></p></a></div></div>`}rank+=1});contentHtml+='<div class="buttons">';let prev=null;let next=null;if(page>1){prev=()=>donorList(popper,data,page-1);contentHtml+='<button id="donorListPrev" type="button" class="btn--sm btn--normal">上一頁</button>'}if(page<parseInt(json.data.totalPage,10)){next=()=>donorList(popper,data,page+1);contentHtml+='<button id="donorListNext" type="button" class="btn--sm btn--normal">下一頁</button>'}contentHtml+="</div>";content.html(contentHtml);$(popper).find("#donorListPrev").off("click").on("click",prev||function(){});$(popper).find("#donorListNext").off("click").on("click",next||function(){})}).catch(error=>{Dialogify.alert("系統忙碌中");console.error(error)})}function commentGpBpList(popper,type,data,page){var params={bsn:data.bsn,snB:data.snB,snC:data.sn,t:type,p:page};$.get("/ajax/comment_gpbp_list.php",params,function(json){var div=$(popper).find(".tippy-content #gpbpList");var prev,next;if(json["message"]){div.text(json["message"])}else{var list=json["list"];var html="";for(var i in list){html+='<a target="_blank" href="https://home.gamer.com.tw/'+list[i]["userid"]+'">';html+='<img class="gamercard" data-gamercard-userid="'+list[i]["userid"]+'" src="'+list[i]["avatar"]+'"></a>'}if(json["next"]||json["prev"]){html+='<div class="buttons">';if(json["prev"]){prev=function(){commentGpBpList(popper,type,data,json["prev"])};html+='<button id="gpbpListPrev" type="button" class="btn--sm btn--normal">上一頁</button>'}if(json["next"]){next=function(){commentGpBpList(popper,type,data,json["next"])};html+='<button id="gpbpListNext" type="button" class="btn--sm btn--normal">下一頁</button>'}html+="</div>"}div.html(html)}$(popper).find("#gpbpListPrev").off("click").on("click",prev||function(){});$(popper).find("#gpbpListNext").off("click").on("click",next||function(){})})}function showTagListTippy(textarea,keyCode){var start=textarea.value.lastIndexOf("@",textarea.selectionStart);if(start==-1){start=textarea.selectionStart}else if(start>0){start--}var str=textarea.value.substring(start,textarea.selectionEnd);if(!str.match(/^ ?@$/)||tagListTippyShown){if(tagListTippyShown){if(keyCode==27||[8,33,34,35,36,37,39].indexOf(keyCode)!=-1&&!str.match(/^ ?@.*$/)){tagListTippy.hide()}else{if([16,17,18].indexOf(keyCode)==-1){updateTagList(textarea)}}}return}var caret=getCaretCoordinates(textarea,textarea.selectionEnd);var offset=caret.left-$(textarea).width()/2;tagListTippyOptions.offset=[offset,0];tagListTippyOptions.appendTo=window.document.body;tagListTippy=tippy(textarea,tagListTippyOptions);tagListTippy.show()}function tagLayout(sn,data,snC){return`
<li>
  <a class="tag-user" href="javascript:;" onclick="Forum.C.tagUser(${sn}, '${data["userid"]}', '${data["nickname"]}', ${snC});">
    <div class="userpic">
      <img class="lazyload" data-src="${data["avatar"]}">
    </div>
    <span class="username">${data["nickname"]}</span>
  </a>
</li>`}function updateTagList(textarea){if(!tagListTippyShown){return}var start=textarea.value.lastIndexOf("@",textarea.selectionStart);if(start==-1){return}var search=textarea.value.substring(start+1,textarea.selectionEnd).toLowerCase();var sn=$(textarea).data("snb");var snC=$(textarea).data("snc")||0;var key="post_"+sn;var htmlFriend="",htmlComment="";for(var k in TAG_DATA[key]){var tag=TAG_DATA[key][k];if(tag["nickname"].toLowerCase().indexOf(search)!=-1&&tag["userid"].toLowerCase()!=Cookies.get("BAHAID").toLowerCase()){htmlComment+=tagLayout(sn,tag,snC)}}if(htmlComment){htmlComment="<h3>留言名單</h3><ul>"+htmlComment+"</ul>"}for(var i in TAG_DATA["friend"]){if(TAG_DATA["friend"][i]["nickname"].toLowerCase().indexOf(search)!=-1){htmlFriend+=tagLayout(sn,TAG_DATA["friend"][i],snC)}}if(htmlFriend){htmlFriend="<h3>好友名單</h3><ul>"+htmlFriend+"</ul>"}var $popper=$(textarea._tippy.popper);if(htmlComment||htmlFriend){$popper.find(".tag-list").html(htmlComment+htmlFriend)}else{$popper.find(".tag-list").html("<h3>沒有相符的名單</h3>")}var listItem=$popper.find(".tag-user");listItem.mouseenter(function(e){listItem.removeClass("active");$(this).addClass("active")});setTimeout(function(){selectTagItem($popper,0)},1)}function selectTagItem($popper,itemIndex){var items=$popper.find(".tag-user");var current=items.filter(".active");var item,index;if(items.length==0){return}if(typeof itemIndex=="string"){var diff=parseInt(itemIndex,10);index=items.index(current)+diff;if(index>=items.length){index=0}else if(index<0){index=items.length-1}}else{index=itemIndex}item=items.filter(":eq("+index+")");current.removeClass("active");item.addClass("active");var list=$popper.find(".tag-list");var top=item.position().top+list.scrollTop()-150+16;list.stop().animate({scrollTop:top},200)}function tagList(elem){var snB=$(elem).data("snb");if(!TAG_DATA["friend"]){var params={u:Cookies.get("BAHAID")};$.get("/ajax/tag_list_friend.php",params,function(json){if(json.error){toastr.error(json.error)}else{TAG_DATA["friend"]=json;findPostTagData(snB);updateTagList(elem)}})}else{findPostTagData(snB);updateTagList(elem)}}function findPostTagData(sn){var key="post_"+sn;var data={};var post=$("#"+key);var author=post.find(".c-post__header__author");var userid=author.find(".userid").text();data[userid.toLowerCase()]={userid:userid,nickname:author.find(".username").text(),avatar:getAvatarImage(userid)};var commentList=post.find("#Commendlist_"+sn+" div.c-reply__item");commentList.each(function(){var img=$(this).find(".gamercard");var userid=img.data("gamercard-userid");data[userid.toLowerCase()]={userid:userid,nickname:$(this).find(".reply-content__user").text(),avatar:img.data("src")}});TAG_DATA[key]=data}function commentLoginCheck(snB){if(!Cookies.get("BAHAID")){var loc=window.location;var from="https://"+loc.host+loc.pathname+loc.search+"#reply"+snB;Cookies.set("ckFrom",from,{path:"/",domain:".gamer.com.tw"});loc.href="https://user.gamer.com.tw/login.php"}}function commentAutoSize(elem){$(elem).height(20);$(elem).height(elem.scrollHeight)}function commentLimitCheck(elem,limit){limit*=3;var text=$(elem).val();var $container=$(elem).parents(".reply-input");let tippy=$container.get(0)._tippy;if(Forum.Common.utf8Length(text)>limit){$container.addClass("warning");tippy.show()}else{$container.removeClass("warning");tippy.hide()}}function getAvatarImage(userid){userid=userid.toLowerCase();var url="https://avatar2.bahamut.com.tw/avataruserpic/";url+=userid.charAt(0)+"/"+userid.charAt(1)+"/";url+=userid+"/"+userid+"_s.png";return url}function postComment(textarea,bsn,snB,snC){var limit=85*3;var value=textarea.value;if(Forum.Common.utf8Length(value)>limit){toastr.warning("留言字數過多！");textarea.focus();return}else if(value.replace(/(^\s*)|(\s*$)/g,"")==""||""==value.replace(/ |　/g,"")){toastr.warning("請輸入留言");textarea.focus();return}var url=snC?"/ajax/edit_comment.php":"/ajax/newCommend.php";textarea.disabled=true;let csrf=new Bahamut.Csrf;csrf.setCookie();$.ajax({url:url,method:"POST",data:{bsn:bsn,snB:snB,snC:snC||0,c:value,returnHtml:1},xhrFields:{withCredentials:true},headers:csrf.getJqueryHeaders()}).done(function(rdata){if(rdata["errMsg"]){toastr.error(rdata["errMsg"]);return}var commentSelector="#Commendcontent_"+rdata["snC"];if(snC){$(commentSelector).replaceWith(rdata["html"])}else{$("#Commendlist_"+snB).append(rdata["html"])}ForumC.bindReplyMenuTippy(commentSelector);ForumC.bindCommentGpBpListTippy(commentSelector);ForumC.bindCommentDateTippy(commentSelector);ForumC.commentFormatter(commentSelector+" .reply-content__article > span.comment_content");textarea.value="";var gaLabel=snC?"編輯留言":"留言";ga("send","event","互動","哈啦區",gaLabel);if(parseInt(bsn,10)==60076){ga("send","event","互動","哈啦區",gaLabel+"-場外")}}).always(function(){textarea.disabled=false;textarea.focus()})}function tourComment(elem){var key="FOURM_TOUR_comment";if(!Cookies.get("BAHAID")||window.localStorage.getItem(key)=="shown"){return}var tour=new Shepherd.Tour({defaults:{classes:"shepherd-theme-arrows",showCancelLink:true}});tour.on("start",function(){showOverlay()});tour.on("complete",function(){removeOverlay();elem.focus();window.localStorage.setItem(key,"shown")});tour.on("cancel",function(){removeOverlay();elem.focus();window.localStorage.setItem(key,"shown")});tour.addStep("step1",{text:"1. 點擊「回覆」留言者，讓通知不漏接。<br>2. 輸入「@好友暱稱」，分享好文給巴哈好友！",attachTo:{element:elem,on:"top"},title:"留言標記功能",buttons:{text:"我知道了",action:tour.next}});tour.start()}function commentGpBp(button,type,data){if(!Cookies.get("BAHAID")){window.location.href="https://user.gamer.com.tw/login.php";return}$(button).prop("disabled",true);getCSRFToken().done(function(token){var params={token:token,bsn:data.bsn,snB:data.snB,snC:data.sn,t:type};$.post("/ajax/comment_gpbp.php",params,function(json){$(button).prop("disabled",false);if(json.message){if(json.code==1){ForumC.commentRestoreGpBp(data.bsn,data.snB,data.sn)}else{toastr.warning(json.message,"",{tapToDismiss:true})}return}var bsn=json.bsn;var snB=json.snB;var snC=json.snC;var type=json.type;var restore="Forum.C.commentRestoreGpBp("+bsn+", "+snB+", "+snC+");";var toastrHtml='<a href="javascript:'+restore+'" style="float:right;color:yellow;">復原</a>';if(type==TYPE_GP){toastrHtml="勇者獲得了 1 點能量"+toastrHtml;ga("send","event","互動","哈啦區","留言推")}else{toastrHtml="勇者削弱了 1 點精神"+toastrHtml;ga("send","event","互動","哈啦區","留言噓")}commentGpBpUpdate(type,snC,1);TOASTRES[bsn+"_"+snB+"_"+snC]=toastr.success(toastrHtml,"",{timeOut:1e4})})})}function commentGpBpUpdate(type,snC,diffValue){var dataName=type==TYPE_GP?"gp":"bp";var commentElem=$("#Commendcontent_"+snC);var elem=commentElem.find("."+dataName+"-count");var value=parseInt(elem.data(dataName),10)||0;value+=diffValue;elem.data(dataName,value);if(type==TYPE_GP){if(value>0){elem.text(value);if(!elem.hasClass("is-highlight")){elem.addClass("is-highlight").prev("button").addClass("is-highlight")}}else{elem.text("");if(elem.hasClass("is-highlight")){elem.removeClass("is-highlight").prev("button").removeClass("is-highlight")}}}else{value<5&&elem.text("")||elem.text(value)}ForumC.bindCommentGpBpListTippy(commentElem)}function editComment(elem){var layout=$(elem).parents(".c-reply__item");editingCommentHtml=layout.find(".reply-content").html();var data=layout.data("comment");layout.addClass("c-reply__editor").find(".reply-content").empty().html(`
<div class="reply-input" data-tippy-content="超過85個字了喔～">
  <textarea data-bsn="${data.bsn}" data-snb="${data.snB}" data-snc="${data.sn}" placeholder="留言⋯" class="content-edit"></textarea>
  <div class="comment_icon">
    <a class="gif_box gif_box_emoji" title="插入表情符號、GIF、貼圖" href="javascript:;">
      <img src="https://i2.bahamut.com.tw/forum/icons/comment_emoji.svg" onmouseout="this.src='https://i2.bahamut.com.tw/forum/icons/comment_emoji.svg'" onmouseover="this.src='https://i2.bahamut.com.tw/forum/icons/comment_emoji_active.svg'">
    </a>
    <a title="插入圖片" href="javascript:;" onclick="Forum.C.insertImage(this);"><img src="https://i2.bahamut.com.tw/forum/icons/comment_image.svg"></a>
  </div>
</div>
<div class="reply-content__send">
  <p>按 enter 送出 或按 esc <a href="javascript:;" onclick="Forum.C.editCommentCancel(this);">取消</a></p>
</div>`);var editContent=data.content.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&#0?39;/g,"'").replace(/&quot;/g,'"').replace(/https:\/\/[^"'<>]+?\.(?:jpe?g|gif|png)\?w=[0-9]+/gi,function(match){return match.split("?")[0]});layout.find(".content-edit").text(editContent);tippy(layout.find(".reply-input").get(0),{trigger:"manual",arrow:true,hideOnClick:"toggle"});var edit=layout.find(".content-edit");ForumC.initCommentInput(edit);edit.focus()}function donateSuccess(){let message=this.model.anonymous?"感謝匿名聲援，讓創作能量生生不息！":"請留言聲援創作者，讓他持續輸出！";toastr.success(message,"贊助完成！",{positionClass:"toast-bottom-center"});let serviceData=this.model.serviceData;let donationId=`${serviceData["bsn"]}_${serviceData["snB"]}`;fetch(`https://api.gamer.com.tw/donate/v1/donor_list.php?donation_id=${donationId}&area=forum`,{credentials:"include"}).then(resp=>{resp.json().then(json=>{if(json.error){Dialogify.alert(json.error.message);return}jQuery(`#post_${serviceData["snB"]} .tippy-donor-list`).text(json.data.totalItemNum)})}).catch(error=>{Dialogify.alert("系統忙碌中");console.error(error)})}window.Forum=window.Forum||{};window.Forum.C=ForumC})(jQuery,window);(function(){var properties=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","borderStyle","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing","tabSize","MozTabSize"];var isBrowser=typeof window!=="undefined";var isFirefox=isBrowser&&window.mozInnerScreenX!=null;function getCaretCoordinates(element,position,options){if(!isBrowser){throw new Error("textarea-caret-position#getCaretCoordinates should only be called in a browser")}var debug=options&&options.debug||false;if(debug){var el=document.querySelector("#input-textarea-caret-position-mirror-div");if(el)el.parentNode.removeChild(el)}var div=document.createElement("div");div.id="input-textarea-caret-position-mirror-div";document.body.appendChild(div);var style=div.style;var computed=window.getComputedStyle?window.getComputedStyle(element):element.currentStyle;var isInput=element.nodeName==="INPUT";style.whiteSpace="pre-wrap";if(!isInput)style.wordWrap="break-word";style.position="absolute";if(!debug)style.visibility="hidden";properties.forEach(function(prop){if(isInput&&prop==="lineHeight"){style.lineHeight=computed.height}else{style[prop]=computed[prop]}});if(isFirefox){if(element.scrollHeight>parseInt(computed.height))style.overflowY="scroll"}else{style.overflow="hidden"}div.textContent=element.value.substring(0,position);if(isInput)div.textContent=div.textContent.replace(/\s/g," ");var span=document.createElement("span");span.textContent=element.value.substring(position)||".";div.appendChild(span);var coordinates={top:span.offsetTop+parseInt(computed["borderTopWidth"]),left:span.offsetLeft+parseInt(computed["borderLeftWidth"]),height:parseInt(computed["lineHeight"])};if(debug){span.style.backgroundColor="#aaa"}else{document.body.removeChild(div)}return coordinates}if(typeof module!="undefined"&&typeof module.exports!="undefined"){module.exports=getCaretCoordinates}else if(isBrowser){window.getCaretCoordinates=getCaretCoordinates}})();function quickPost(id,btn,bsn){var iframe=document.getElementById("editor");var iframeDocument=iframe.contentDocument||iframe.contentWindow.document;var code="";if(bahaRte.isPlainText){code=document.getElementById("source").value}else{let iframeDocumentBody=iframeDocument.getElementsByClassName("editstyle");if(iframeDocumentBody.length<=0){Dialogify.alert("請填寫內容");return}code=new Bahacode(iframeDocumentBody["0"]).convert()}jQuery("input[name=rtecontent]").val(code);var frm=document.frm;if(bsn=="60076"&&false==ruleflag){rulechk(()=>chkdataAndSubmit(frm,bsn));return}chkdataAndSubmit(frm,bsn)}function chkdataAndSubmit(frm,bsn){if(!chkdata(frm,bsn)){return}Dialogify.confirm("確定發表?",{ok:function(){ga("send","event",{eventCategory:"互動",eventAction:"哈啦區",eventLabel:"回覆",transport:"beacon"});if(parseInt(bsn,10)==60076){ga("send","event",{eventCategory:"互動",eventAction:"哈啦區",eventLabel:"回覆-場外",transport:"beacon"})}bahaRte.onpost=1;frm.submit()}})}function insertTemplate(ssn){Cookies.set("ckForumLastSnippet",ssn,{expires:365,domain:"gamer.com.tw"});var snippet=snippetList[ssn];if(bahaRte.isPlainText){bahaRte.source.focus();bahaRte.utility.insertTextTag(snippet["content"])}else{bahaRte.win.focus();bahaRte.utility.insertHtml(snippet["content_html"])}jQuery(".add-template_box").toggle();jQuery(".add-template_c").toggleClass("is-active");jQuery(".add-template_c").html('<i class="fa fa-plus"></i>插入範本</button>');jQuery(".add-template_c").attr("title","插入範本")}function checkIsLogin(){if(!Cookies.get("BAHAID")){var loc=window.location;var from="https://"+loc.host+loc.pathname+loc.search+"#quickPostAnchor";Cookies.set("ckFrom",from,{path:"/",domain:".gamer.com.tw"});loc.href="https://user.gamer.com.tw/login.php"}else{return true}}function chkdata(frm,bsn){if(bahaRte.isEmpty()){Dialogify.alert("請填寫內容");return false}if(bahaRte.onpost===1){Dialogify.alert("處理中，請稍候");return false}return true}function delPost(sn,args,code){var content=jQuery("#cf"+sn).html();var pattern=/<img .*?src="https?:\/\/truth\.bahamut\.com\.tw\/s01\/[0-9]{6}\/[a-f0-9]{32}\.(?:jpg|jpeg|gif|png)(?:\?[^\?"]*)?"[^>]*?>/i;var patternA=/<a .*?id="https?:\/\/truth\.bahamut\.com\.tw\/s01\/[0-9]{6}\/[a-f0-9]{32}\.(?:jpg|jpeg|gif|png)(?:\?[^\?"]*)?"[^>]*?>/i;var confirm_txt="確定要刪除嗎？";if(content.match(pattern)||content.match(patternA)){confirm_txt+=`
<br><br>
<div class="check-group">
    <input id="chkDelTruthImage" type="checkbox" value="yes">
    <label for="chkDelTruthImage">
        <div class="label-icon"><i class="fa fa-check"></i></div>
        <h6>若文中有我上傳至巴哈的圖片也一併刪除</h6>
    </label>
</div>`}Dialogify.confirm(confirm_txt,{ok:function(){if(jQuery("#chkDelTruthImage:checked").length){args+="&dt=yes"}setCookie("ckFORUM_pdel",code);location.href="post2.php?"+args}})}