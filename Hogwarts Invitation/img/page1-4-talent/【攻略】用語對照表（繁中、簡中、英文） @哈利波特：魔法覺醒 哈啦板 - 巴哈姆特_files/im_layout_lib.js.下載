(function(window,document,$,undefined){function BAHA_IM_LAYOUT_LIB(im,im_id,layout,layout_id){return this instanceof BAHA_IM_LAYOUT_LIB?this.init(im,im_id,layout,layout_id):new BAHA_IM_LAYOUT_LIB(im,im_id,layout,layout_id)}function check_photo_version(version){if(typeof version!="undefined"){return"&v="+version}else{return""}}BAHA_IM_LAYOUT_LIB.prototype.init=function(im,im_id,layout,layout_id){var self=this;this.im=im;this.layout=layout;this.im_id=im_id;this.layout_id=layout_id;this.tip=null;this.tip2=[]};BAHA_IM_LAYOUT_LIB.prototype.showNoRead=function(data){var num=data.noreadnum;if(data.type==2){if(num>0){return"New"}else{return""}}else{if(num>999){return"999+"}else if(num>0){return num}else{return""}}};BAHA_IM_LAYOUT_LIB.prototype.showFightImg=function(msgid){var self=this;var data=this.im.msgData[msgid];var img=new Image;img.onload=function(){var obj=$("#fightImg_"+msgid);var oldtop=obj.parent().parent().parent().parent().parent().scrollTop();if(img.width>=img.height){obj.attr("width",img.height/.875).attr("height",img.height).css("max-width","100%");ctx=obj.get(0).getContext("2d");ctx.drawImage(img,(img.height/.875-img.width)/2,0)}else{obj.attr("width",img.width).attr("height",img.width*.875).css("max-width","100%");ctx=obj.get(0).getContext("2d");ctx.drawImage(img,0,(img.width*.875-img.height)/2)}if(obj.parent().parent().parent().parent().position().top<0||self.layout.isDown==true){obj.parent().parent().parent().parent().parent().scrollTop(oldtop+obj.height()-150)}var text_data=JSON.parse(data.text_data);text_data.forEach(function(txt){var fontsize=txt.text_size*obj.get(0).height*.99;var x=txt.text_position_x*obj.get(0).width;var y=txt.text_position_y*obj.get(0).height;ctx.setTransform(1,0,0,1,0,0);ctx.textAlign="center";ctx.textBaseline="middle";ctx.font="bold "+fontsize+"px Microsoft JhengHei";var tmp=txt.text.split("");var row=[];var temp="";var fontwidth=0;for(var i=0;i<tmp.length;i++){if(ctx.measureText(temp+tmp[i]).width<=obj.get(0).width&&tmp[i]!="\n"){temp+=tmp[i]}else{if(ctx.measureText(temp).width>fontwidth){fontwidth=ctx.measureText(temp).width}row.push(temp.replace("\n",""));temp=tmp[i]}}row.push(temp.replace("\n",""));if(ctx.measureText(temp).width>fontwidth){fontwidth=ctx.measureText(temp).width}ctx.translate(x+fontwidth/2,y+fontsize*row.length/2);ctx.rotate(Math.PI/180*txt.text_angle);ctx.translate(-fontwidth/2,-fontsize*row.length/2);for(var i=0;i<row.length;i++){var fontwidth=ctx.measureText(row[i]).width;ctx.fillStyle=txt.text_color;ctx.fillText(row[i],fontwidth/2,fontsize/2+fontsize*1.19*i);if(txt.text_has_stroke==true){ctx.strokeStyle=txt.text_stroke_color;ctx.strokeText(row[i],fontwidth/2,fontsize/2+fontsize*1.19*i)}}})};img.src="https://im.bahamut.com.tw/sticker%2F"+data.sticker_group_id+"%2F"+data.sticker_id+".png?alt=media"};BAHA_IM_LAYOUT_LIB.prototype.avatarUrl=function(uid,size){return avatarUrl(uid,size,this)};BAHA_IM_LAYOUT_LIB.prototype.avatarLink=function(uid){return avatarLink(uid)};BAHA_IM_LAYOUT_LIB.prototype.addMember=function(){var roomInfo=this.im.roomInfo[this.im.nowRoom];var header='<h3 class="modal__header--title">邀請成員</h3>';var body="<div class=\"modal-content\">  <ul class=\"tab-nav removeTextNodes\">    <li class=\"tab-item is-active\">      <a href=\"javascript:;\" onclick=\"jQuery('.tab-item.is-active').removeClass('is-active');jQuery(this).parent().addClass('is-active');jQuery('#addMemberSlick').slick('slickGoTo',jQuery(this).parent().parent().find('li').index(jQuery(this).parent()));\">邀請好友</a>    </li>";if(roomInfo.is_public===true){body+="    <li class=\"tab-item\">      <a href=\"javascript:;\" onclick=\"jQuery('.tab-item.is-active').removeClass('is-active');jQuery(this).parent().addClass('is-active');jQuery('#addMemberSlick').slick('slickGoTo',jQuery(this).parent().parent().find('li').index(jQuery(this).parent()));\">行動條碼</a>    </li>    <li class=\"tab-item\">      <a href=\"javascript:;\" onclick=\"jQuery('.tab-item.is-active').removeClass('is-active');jQuery(this).parent().addClass('is-active');jQuery('#addMemberSlick').slick('slickGoTo',jQuery(this).parent().parent().find('li').index(jQuery(this).parent()));\">邀請網址</a>    </li>"}body+='    <li class="tab-item">      <a href="javascript:;" onclick="jQuery(\'.tab-item.is-active\').removeClass(\'is-active\');jQuery(this).parent().addClass(\'is-active\');jQuery(\'#addMemberSlick\').slick(\'slickGoTo\',jQuery(this).parent().parent().find(\'li\').index(jQuery(this).parent()));">搜尋 ID</a>    </li>  </ul>  <div id="addMemberSlick">  <div class="tab-box" id="addMemberTabFriend">    <ul class="message-room-list subtitle">      <li class="message-room-list__item">        <a href="javascript:;" role="button" class="message-room-list-header" onclick="'+this.layout_id+'.listSlide(\'addMember_favorite\',this);">          <div class="message-room-subname">最愛</div>          <i class="material-icons">keyboard_arrow_up</i>        </a>        <ul class="message-room-sub-list" id="addMember_favorite">        </ul>      </li>    </ul>    <ul class="message-room-list subtitle">      <li class="message-room-list__item">        <a href="javascript:;" role="button" class="message-room-list-header" onclick="'+this.layout_id+'.listSlide(\'addMember_normal\',this);">          <div class="message-room-subname">一般</div>          <i class="material-icons">keyboard_arrow_up</i>        </a>        <ul class="message-room-sub-list" id="addMember_normal">        </ul>      </li>    </ul>    <ul class="message-room-list subtitle">      <li class="message-room-list__item">        <a href="javascript:;" role="button" class="message-room-list-header" onclick="'+this.layout_id+'.listSlide(\'addMember_1vs1\',this);">          <div class="message-room-subname">私訊過</div>          <i class="material-icons">keyboard_arrow_up</i>        </a>        <ul class="message-room-sub-list" id="addMember_1vs1">        </ul>      </li>    </ul>  </div>';if(roomInfo.is_public===true){body+='  <div class="tab-box" id="addMemberTabQr">    <div class="invite-box">      <div class="invite__qr-code">      </div>      <script>jQuery(\'.invite__qr-code\').qrcode({width:224,height:224,text:"https://haha.gamer.com.tw/index.php?room='+this.im.rooms[this.im.nowRoom]+'"});<\/script>      <a class="mes-btn mes-btn-default" href="#" download="'+this.im.rooms[this.im.nowRoom]+'.png" onclick="this.href=jQuery(\'.invite__qr-code > canvas\').get(0).toDataURL();">下載</a>    </div>  </div>  <div class="tab-box">    <div class="invite-box">      <div class="invite__link">        <input type="text" class="mes-textbox" value="https://haha.gamer.com.tw/?room='+this.im.rooms[this.im.nowRoom]+"\" id=\"linkurl\"/>      </div>      <button class=\"mes-btn mes-btn-default\" onclick=\"jQuery('#linkurl').select();if(document.execCommand('copy')){jQuery(this).html('已複製到剪貼簿');}else{jQuery(this).html('複製失敗，請手動複製上面網址');};\">>複製網址</button>    </div>  </div>"}body+='  <div class="tab-box">    <div class="modal-search-box">      <input type="text" class="mes-textbox"/>      <button class="mes-btn mes-btn-primary" onclick="'+this.im_id+'.addMemberSearchBahaid(jQuery(this).prev(\'input\').val());">搜尋</button>    </div>    <div class="modal-result-box" style="display:none" id="searchBahaid">      <div class="invite-box">        <div class="invite__author">          <a href="" target="_blank" class="author-avatar" id="searchBahaid_avatar">            <img src="" alt=""/>          </a>          <div class="author-username">            <p class="name" id="searchBahaid_name"></p>            <a class="id" id="searchBahaid_link" href="" target="_blank"></a>          </div>          <button class="mes-btn mes-btn-invese" onclick="'+this.im_id+".addMember(jQuery('#searchBahaid_link').html(),jQuery('#searchBahaid_name').html());jQuery(this).hide();jQuery(this).next('p').show();\">邀請</button>          <p class=\"invite-tip__text\" style=\"display:none\">邀請已傳送！</p>        </div>      </div>    </div>  </div>  </div></div>";var foot='<div class="modal-ctrl rtl">  <a role="button" href="javascript:;" class="mes-btn mes-btn-default" onclick="'+this.layout_id+'.lightbox.close()">取消</a>  <a role="button" href="javascript:;" class="mes-btn mes-btn-primary" onclick="'+this.im_id+".addMembers(jQuery('[name=mes-checkbox]:checked'));\">邀請</a></div>";this.layout.lightbox=jQuery().lightBox({header:header,body:body,footer:foot});this.layout.lightbox.open();jQuery("#addMemberSlick").slick({arrows:false,draggable:false,infinite:false}).on("beforeChange",function(event,slick,now,next){if(next==0){jQuery(".modal__footer").show()}else{jQuery(".modal__footer").hide()}}).find('input[type="text"]').click(function(){var el=$(this);var position="static";el.css({position:"relative"});setTimeout(function(){el.focus();el.css({position:position})},0)});this.addMemberSearchFriend("")};BAHA_IM_LAYOUT_LIB.prototype.addMemberSearchFriend=function(txt){async.series([function(next){this.im.getAllChatList(true,next)}],function(){jQuery("#addMember_favorite").html("");jQuery("#addMember_normal").html("");for(var key in this.im.rooms){var roomData=this.im.roomData[key];if(roomData.type!=3){continue}var userid="";var nick="";for(var key2 in roomData.members){if(key2!=User.Login.getUserid().toLowerCase()){userid=key2;nick=roomData.members[key2].name}}if(txt!=""&&userid.match(txt)==null&&roomData.name.match(txt)==null){continue}if(roomData.is_favorite===true&&roomData.is_friend!==false){var div=jQuery("#addMember_favorite")}else if(roomData.is_friend!==false){var div=jQuery("#addMember_normal")}else if(roomData.is_friend===false&&roomData.has_chat===true){var div=jQuery("#addMember_1vs1")}else{continue}var userinfo='<li class="message-room-list__item">  <div class="user-panel dense data">    <div class="user-ctrl">      <div class="mes-checkbox">        <label class="mes-checkbox__label">          <input type="checkbox" name="mes-checkbox" value="'+userid+'" data-nick="'+nick+'">          <div class="mes-checkbox__button"></div>        </label>      </div>    </div>    <div class="user-avatar">      <div class="user-avatar__img" style="background-image: url('+avatarUrl(userid,"S",this)+');"></div>    </div>    <div class="user-container">      <div class="user-header">        <div class="user-title">          <span class="user-name">'+msgHtmlTagNUrl(this.im.roomData[key].name)+'</span>        </div>      </div>      <div class="user-body">        <div class="message-summary">          <span>'+userid+"</span>        </div>      </div>    </div>  </div></li>";div.append(userinfo)}})};BAHA_IM_LAYOUT_LIB.prototype.groupAdd_header=function(){return'<h3 class="modal__header--title">建立群組</h3>'};BAHA_IM_LAYOUT_LIB.prototype.groupEdit_header=function(){return'<h3 class="modal__header--title">編輯群組</h3>'};BAHA_IM_LAYOUT_LIB.prototype.groupAdd_body=function(){return'<div class="modal-content">  <ul class="fields">    <li class="fidlds__item row">      <div class="fields-label col-2 col-wm-12">群組圖片：</div>      <div class="fields-value col-10 col-wm-12">        <div class="mes-group-img-pre">        <img id="upimg">        </div>        <div class="mes-filebox">          <span>上傳圖片</span>          <input type="file" class="mes-filebox__pre" onchange="jQuery(\'.modal__body\').slick(\'slickGoTo\',1);'+this.im_id+'.readFile(this)"/>        </div>      </div>    </li>    <li class="fidlds__item row">      <div class="fields-label col-2 col-wm-12">群組名稱：</div>      <div class="fields-value col-10 col-wm-12">        <div class="mes-fields">          <input type="text" class="mes-textbox" name="group-name" value="" onkeyup="jQuery(this).next(\'span\').html( jQuery(this).val().length + \'/40\' );" placeholder="群組名稱"/>          <span class="mes-fields__tips">0/40</span>        </div>      </div>    </li>    <li class="fidlds__item row">      <div class="fields-label col-2 col-wm-12">相關作品：</div>      <div class="fields-value col-10 col-wm-12">        <div class="relative-hlp">          <div class="mes-fields-value__text" name="group_relgame_span">尚未設定</div>          <input type="hidden" value="0" name="group-c1" />          <input type="hidden" value="" name="group-relgame" />          <button class="mes-btn mes-btn-default" onclick="jQuery(\'.modal__body\').slick(\'slickGoTo\',2);">設定</button>          <span class="mes-fields__tips"><i class="material-icons">info_outline</i>有關聯作品並公開的聊天室，會在對應的哈啦板曝光</span>        </div>      </div>    </li>    <li class="fidlds__item row">      <div class="fields-label col-2col-wm-12">聊天室設定：</div>      <div class="fields-value col-10 col-wm-12 removeTextNodes">        <div class="mes-radio">          <label class="mes-radio__label">            <input type="radio" name="group-public" value="1" checked>            <div class="mes-radio__button"></div>            公開          </label>        </div>        <div class="mes-radio">          <label class="mes-radio__label">            <input type="radio" name="group-public" value="2">            <div class="mes-radio__button"></div>            私密          </label>        </div>      </div>    </li>    <li class="fidlds__item row">      <div class="fields-label col-2col-wm-12">邀請好友：</div>      <div class="fields-value col-10 col-wm-12 removeTextNodes">        <div class="mes-fields-value__text" id="group_add_inviting_num">已選擇 0 人</div>        <button class="mes-btn mes-btn-default" onclick="jQuery(\'.modal__body\').slick(\'slickGoTo\',3);">選擇好友</button>        <div class="avatar-box inline removeTextNodes" id="group_add_inviting"></div>      </div>    </li>  </ul></div><div class="modal-content">  <div class="modal__sub-header">    <a class="mes-btn mes-btn-link removeTextNodes modal-sub-ctrl-ltr" href="javascript:;" onclick="jQuery(\'.modal__body\').slick(\'slickGoTo\',0);">      <i class="material-icons">keyboard_arrow_left</i>      <span class="mes-btn-txt">返回</span>    </a>    <div class="modal__sub-title">      裁切圖片    </div>      <a class="mes-btn mes-btn-link modal-sub-ctrl-rtl" href="javascript:;" onclick="jQuery(\'.modal__body\').slick(\'slickGoTo\',0);jQuery(\'#upimg\').attr(\'src\',jQuery(\'#dimg\').attr(\'src\'));">完成</a>  </div>  <div class="group-setting-content">    <div id="simg" style="float:left;width:300px"></div>    <img id="dimg" style="float:right;">  </div></div><div class="modal-content">  <div class="modal__sub-header">    <div class="modal__sub-title">      搜尋相關作品    </div>      <a class="mes-btn mes-btn-link modal-sub-ctrl-rtl" href="javascript:;" onclick="jQuery(\'.modal__body\').slick(\'slickGoTo\',0);">完成</a>  </div>  <div class="group-setting-content">    <div class="modal-search-box">      <input type="text" class="mes-textbox" id="group_search_key">      <button class="mes-btn mes-btn-primary" onclick="'+this.im_id+'.searchRelatedC1();">搜尋</button>    </div>    <div class="modal-result-box">      <div class="game-select removeTextNodes">        <div class="game-select__result">          目前選取作品：<span class="has-data" name="group_relgame_span">未選取</span>        </div>        <button class="mes-btn mes-btn-small mes-btn-default" onclick="jQuery(\'[name=group_relgame_span]\').html(\'未選取\');jQuery(\'[name=group-relgame]\').val(\'\');jQuery(\'\').val(0);">清除</button>      </div>      <ul class="game-result" id="group_relgame_search_list">      </ul>    </div>  </div></div><div class="modal-content">  <div class="modal__sub-header">    <a class="mes-btn mes-btn-link removeTextNodes modal-sub-ctrl-ltr" href="javascript:;" onclick="jQuery(\'.modal__body\').slick(\'slickGoTo\',0);">      <span class="mes-btn-txt">取消</span>    </a>    <div class="modal__sub-title">      邀請好友    </div>      <a class="mes-btn mes-btn-link modal-sub-ctrl-rtl" href="javascript:;" onclick="jQuery(\'.modal__body\').slick(\'slickGoTo\',0);'+this.layout_id+'.groupAddSetInviting();">邀請</a>  </div>  <div class="group-setting-content">    <div class="modal-result-box" style="height:500px;overflow:auto">      <ul class="message-room-list subtitle">        <li class="message-room-list__item">          <a href="javascript:;" role="button" class="message-room-list-header" onclick="'+this.layout_id+'.listSlide(\'addMember_favorite\',this);">            <div class="message-room-subname">最愛</div>            <i class="material-icons">keyboard_arrow_up</i>          </a>          <ul class="message-room-sub-list" id="addMember_favorite">          </ul>        </li>      </ul>      <ul class="message-room-list subtitle">        <li class="message-room-list__item">          <a href="javascript:;" role="button" class="message-room-list-header" onclick="'+this.layout_id+'.listSlide(\'addMember_normal\',this);">            <div class="message-room-subname">一般</div>            <i class="material-icons">keyboard_arrow_up</i>          </a>          <ul class="message-room-sub-list" id="addMember_normal">          </ul>        </li>      </ul>      <ul class="message-room-list subtitle">        <li class="message-room-list__item">          <a href="javascript:;" role="button" class="message-room-list-header" onclick="'+this.layout_id+'.listSlide(\'addMember_1vs1\',this);">            <div class="message-room-subname">私訊過</div>            <i class="material-icons">keyboard_arrow_up</i>          </a>          <ul class="message-room-sub-list" id="addMember_1vs1">          </ul>        </li>      </ul>    </div>  </div></div>'};BAHA_IM_LAYOUT_LIB.prototype.groupEdit_body=function(key){var roomInfo=this.im.roomInfo[key];var roomData=this.im.roomData[key];return'<div class="modal-content">  <ul class="fields">    <li class="fidlds__item row">      <div class="fields-label col-2 col-wm-12">群組圖片：</div>      <div class="fields-value col-10 col-wm-12">        <div class="mes-group-img-pre">          <img src="'+roomData.photo+'" alt="" id="upimg"/>        </div>        <div class="mes-filebox">          <span>重新上傳</span>          <input type="file" class="mes-filebox__pre" onchange="jQuery(\'.modal__body\').slick(\'slickGoTo\',1);im.readFile(this)"/>        </div>      </div>    </li>    <li class="fidlds__item row">      <div class="fields-label col-2 col-wm-12">群組名稱：</div>      <div class="fields-value col-10 col-wm-12">        <div class="mes-fields">          <input type="text" class="mes-textbox" name="group-name" value="'+roomInfo.name+'" onkeyup="jQuery(this).next(\'span\').html( jQuery(this).val().length + \'/40\' );" placeholder="群組名稱"/>          <span class="mes-fields__tips">'+roomInfo.name.length+'/40</span>        </div>      </div>    </li>    <li class="fidlds__item row">      <div class="fields-label col-2 col-wm-12">相關作品：</div>      <div class="fields-value col-10 col-wm-12">        <div class="relative-hlp">          <div class="mes-fields-value__text" name="group_relgame_span">'+msgHtmlTagNUrl(roomInfo.related_acg_name)+'</div>          <input type="hidden" value="'+roomInfo.related_c1+'" name="group-c1" />          <input type="hidden" value="'+roomInfo.related_acg_name+'" name="group-relgame" />          <button class="mes-btn mes-btn-default" onclick="jQuery(\'.modal__body\').slick(\'slickGoTo\',2);">設定</button>          <span class="mes-fields__tips"><i class="material-icons">info_outline</i>有關聯作品並公開的聊天室，會在對應的哈啦板曝光</span>        </div>      </div>    </li>    <li class="fidlds__item row">      <div class="fields-label col-2col-wm-12">聊天室設定：</div>      <div class="fields-value col-10 col-wm-12 removeTextNodes">        <div class="mes-radio">          <label class="mes-radio__label">            <input type="radio" name="group-public" value="1" '+(roomInfo.is_public?"checked":"")+'>            <div class="mes-radio__button"></div>            公開          </label>        </div>        <div class="mes-radio">          <label class="mes-radio__label">            <input type="radio" name="group-public" value="2" '+(roomInfo.is_public?"":"checked")+'>            <div class="mes-radio__button"></div>            私密          </label>        </div>      </div>    </li>  </ul></div><div class="modal-content">  <div class="modal__sub-header">    <a class="mes-btn mes-btn-link removeTextNodes modal-sub-ctrl-ltr" href="javascript:;" onclick="jQuery(\'.modal__body\').slick(\'slickGoTo\',0);">      <i class="material-icons">keyboard_arrow_left</i>      <span class="mes-btn-txt">返回</span>    </a>    <div class="modal__sub-title">      裁切圖片    </div>      <a class="mes-btn mes-btn-link modal-sub-ctrl-rtl" href="javascript:;" onclick="jQuery(\'.modal__body\').slick(\'slickGoTo\',0);jQuery(\'#upimg\').attr(\'src\',jQuery(\'#dimg\').attr(\'src\'));">完成</a>  </div>  <div class="group-setting-content">    <div id="simg" style="float:left;width:300px"></div>    <img id="dimg" style="float:right;">  </div></div><div class="modal-content">  <div class="modal__sub-header">    <div class="modal__sub-title">      搜尋相關作品    </div>      <a class="mes-btn mes-btn-link modal-sub-ctrl-rtl" href="javascript:;" onclick="jQuery(\'.modal__body\').slick(\'slickGoTo\',0);">完成</a>  </div>  <div class="group-setting-content">    <div class="modal-search-box">      <input type="text" class="mes-textbox" id="group_search_key">      <button class="mes-btn mes-btn-primary" onclick="im.searchRelatedC1();">搜尋</button>    </div>    <div class="modal-result-box">      <div class="game-select removeTextNodes">        <div class="game-select__result">          目前選取作品：<span class="has-data" name="group_relgame_span">'+msgHtmlTagNUrl(roomInfo.related_acg_name)+"</span>        </div>        <button class=\"mes-btn mes-btn-small mes-btn-default\" onclick=\"jQuery('[name=group_relgame_span]').html('未選取');jQuery('[name=group-relgame]').val('');jQuery('').val(0);\">清除</button>      </div>      <ul class=\"game-result\" id=\"group_relgame_search_list\">      </ul>    </div>  </div></div>"};BAHA_IM_LAYOUT_LIB.prototype.groupAdd_foot=function(){return'<div class="modal-ctrl rtl">  <a role="button" href="javascript:;" class="mes-btn mes-btn-default" onclick="'+this.layout_id+'.lightbox.close();">取消</a>  <a role="button" href="javascript:;" class="mes-btn mes-btn-primary" onclick="'+this.im_id+'.groupAdd()">新增</a></div>'};BAHA_IM_LAYOUT_LIB.prototype.groupEdit_foot=function(){return'<div class="modal-ctrl rtl">  <a role="button" href="javascript:;" class="mes-btn mes-btn-default" onclick="'+this.layout_id+'.lightbox.close();">取消</a>  <a role="button" href="javascript:;" class="mes-btn mes-btn-primary" onclick="'+this.im_id+'.groupEdit()">儲存</a></div>'};BAHA_IM_LAYOUT_LIB.prototype.editSticker=function(){var self=this;var html='<div class="modal-content modal-content--h-limit">  <div class="modal__sub-header">    <div class="modal-sub-ctrl-rtl">      全選<div class="mes-switch padding-both">        <label class="mes-switch__label">          <input type="checkbox" name="mes-switch" onchange="'+this.im_id+'.editSticker(\'all\',this);">          <div class="mes-switch__button"></div>        </label>      </div>    </div>  </div>  <ul class="message-room-list">';var clearClass=" is-disable";var listarr=[];this.im.stickers.forEach(function(sticker,index){if(sticker.sticker_visible==false){listarr.push({key:index,sort:1e5+index/1e5})}else{listarr.push({key:index,sort:sticker.sticker_order+index/1e5})}});listarr.sort(function(a,b){if(a.sort<b.sort){return-1}else{return 1}});for(var index in listarr){var skey=listarr[index].key;var sticker=this.im.stickers[skey];var stickerinfo=this.im.stickerDetail[skey];if(!stickerinfo){continue}if(stickerinfo.deadline<(new Date).getTime()&&stickerinfo.deadline!=0){clearClass=""}html+='<li class="message-room-list__item">  <div class="user-panel dense data">    <div class="user-avatar user-avatar--square">      <div class="user-avatar__img" style="background-image: url(https://im.bahamut.com.tw/sticker%2F'+skey+"%2Fsticker_"+skey+'.png?alt=media);"></div>    </div>    <div class="user-container">      <div class="user-header">        <div class="user-title">          <span class="user-name">'+stickerinfo.sticker_group_name+'</span>        </div>      </div>      <div class="user-body">        <div class="message-summary">          <span>貼圖期限：'+(stickerinfo.deadline==0?"永久":timeConverter(stickerinfo.deadline-1,"sticker_dealine"))+'</span>        </div>      </div>    </div>    <div class="user-ctrl">      <div class="mes-switch">        <label class="mes-switch__label">          <input type="checkbox" name="mes-switch" onchange="'+this.im_id+".editSticker('"+skey+"',this);\" "+(sticker.sticker_visible==false?"":"checked")+'>          <div class="mes-switch__button"></div>        </label>      </div>    </div>  </div></li>'}html+="</ul></div>";if(this.layout.lightbox){this.layout.lightbox.close()}this.layout.lightbox=jQuery().lightBox({header:'<h3 class="modal__header--title">選擇要顯示的貼圖</h3>',body:html,footer:'<a href="javascript:;" class="mes-btn mes-btn-link'+clearClass+'" onclick="'+this.im_id+".clearSticker('all');\">清除所有過期貼圖</a>",footerClass:"modal__footer--general"});setTimeout(function(){self.layout.lightbox.open()},200)};BAHA_IM_LAYOUT_LIB.prototype.updateSticker=function(stickbtn){let self=this;if(this.tip!=null){setTimeout(function(){if(tippy.delegate){self.tip.destroy();self.tip2.forEach(function(tip2){tip2.destroy()})}else{self.tip.destroyAll();self.tip2.forEach(function(tip2){tip2.destroyAll()})}},0)}};BAHA_IM_LAYOUT_LIB.prototype.changeStickerFans=function(key){$("a[data-sticker-group]").hide();$("a[data-sticker-group="+key+"]").each(function(index,obj){$(obj).find("img").attr("src",$(obj).find("img").attr("data-src"))});$("a[data-sticker-group="+key+"]").show()};BAHA_IM_LAYOUT_LIB.prototype.showStickerFans=function(){var self=this;var html="";var stickered=localStorage.hahamut_stickered||"[]";stickered=JSON.parse(stickered);stickered.forEach(function(data){html+='<a data-sticker-group="0" href="javascript:'+self.im_id+".sendSticker('"+data.sticker_group+"','"+data.sticker_img+"');$('.btn-emotion-active').click();\">  <img src=\"https://im.bahamut.com.tw/sticker%2F"+data.sticker_group+"%2F"+data.sticker_img+'.png?alt=media" class="emotion-img"></a>'});var listarr=[];self.im.stickers.forEach(function(sticker,index){if(sticker.sticker_visible==false){return}listarr.push({key:index,sort:sticker.sticker_order+index/1e5})});listarr.sort(function(a,b){if(a.sort<b.sort){return-1}else{return 1}});var indexhtml='<a href="javascript:;" onclick="'+self.layout_id+'.layout_u.changeStickerFans(0)"><i class="emotion-item material-icons" style="font-size:48px">access_time</i></a>';for(var index in listarr){var skey=listarr[index].key;var stickerinfo=self.im.stickerDetail[skey];if(!stickerinfo||stickerinfo.deadline<(new Date).getTime()&&stickerinfo.deadline!=0){continue}indexhtml+='<a href="javascript:;" onclick="'+self.layout_id+".layout_u.changeStickerFans("+skey+')"><img src="https://im.bahamut.com.tw/sticker%2F'+skey+"%2Fsticker_"+skey+'.png?alt=media" alt="img" class="emotion-item"></a>';for(var index2 in stickerinfo.stickers){html+='<a data-sticker-group="'+skey+'" href="javascript:'+self.im_id+".sendSticker('"+skey+"','"+stickerinfo.stickers[index2]+'\');$(\'.btn-emotion-active\').click();" style="display:none">  <img data-src="https://im.bahamut.com.tw/sticker%2F'+skey+"%2F"+stickerinfo.stickers[index2]+'.png?alt=media" class="emotion-img"></a>'}}return'<div class="emotion-area">'+html+'</div><div class="emotion-option">'+indexhtml+"</div>"};BAHA_IM_LAYOUT_LIB.prototype.showSticker=function(stickbtn){var self=this;if($(stickbtn).attr("data-tooltipped")==undefined){var obj=document.createElement("div");obj.innerHTML=stickhtml(self);if(tippy.delegate){self.tip=tippy(stickbtn,{appendTo:document.body,maxWidth:"calc(100%-20px)",theme:"default",allowHTML:true,content:obj,trigger:"click",interactive:true,onShow:function(instance){const $popper=$(instance.popper);$popper.find("[name=stickerContent]").show();$popper.find("[name=stickerContent]").slick({lazyLoad:"ondemand",arrows:false,draggable:false,infinite:false,fade:true});$popper.find("[name=stickerContent]").on("beforeChange",function(event,slick,cSlide,nSlide){$("[name=slickitem]").removeClass("is-active");$("[name=slickitem]:eq("+nSlide+")").addClass("is-active")});$popper.find("[name=stickerContent]").on("lazyLoaded",function(event,slick,image,imageSource){var img=document.createElement("img");img.src=imageSource;img.width=180;self.tip2.push(tippy(image[0],{allowHTML:true,content:img,theme:"light"}))})},onShown:function(instance){const $popper=$(instance.popper);var shows=6;if($popper.find("#sticker_index li").size()<6){shows=$popper.find("#sticker_index li").size()}$popper.find("#sticker_index").slick({infinite:false,slidesToShow:shows,slidesToScroll:shows,asNavFor:"[name=stickerContent]"});$popper.find("[name=stickerContent]").slick("setPosition");$popper.find("#sticker_index").slick("setPosition")},onHide:function(instance){const $popper=$(instance.popper);$popper.find("[name=stickerContent]").hide();$popper.find("[name=stickerContent]").slick("unslick");$popper.find("#sticker_index").slick("unslick")}});self.tip.show()}else{self.tip=tippy(stickbtn,{theme:"default",html:obj,arrow:true,trigger:"click",interactive:true,animation:"fade",onShow:function(){$(this).find("[name=stickerContent]").show();$(this).find("[name=stickerContent]").slick({lazyLoad:"ondemand",arrows:false,draggable:false,infinite:false,fade:true});$(this).find("[name=stickerContent]").on("beforeChange",function(event,slick,cSlide,nSlide){$("[name=slickitem]").removeClass("is-active");$("[name=slickitem]:eq("+nSlide+")").addClass("is-active")});$(this).find("[name=stickerContent]").on("lazyLoaded",function(event,slick,image,imageSource){var img=document.createElement("img");img.src=imageSource;img.width=180;self.tip2.push(tippy(image[0],{html:img,arrow:true,animation:"fade",theme:"light"}))})},onShown:function(){var shows=6;if($(this).find("#sticker_index li").size()<6){shows=$(this).find("#sticker_index li").size()}$(this).find("#sticker_index").slick({infinite:false,slidesToShow:shows,slidesToScroll:shows,asNavFor:"[name=stickerContent]"});$(this).find("[name=stickerContent]").slick("setPosition");$(this).find("#sticker_index").slick("setPosition")},onHide:function(){$(this).find("[name=stickerContent]").hide();$(this).find("[name=stickerContent]").slick("unslick");$(this).find("#sticker_index").slick("unslick")}});var el=$(stickbtn).get(0);var popper=self.tip.getPopperElement(el);self.tip.show(popper)}}};BAHA_IM_LAYOUT_LIB.prototype.createHtml=function(tag,data,innerType,inner){return createHtml(tag,data,innerType,inner)};BAHA_IM_LAYOUT_LIB.prototype.msgContent=function(msgid,data){return msgContent(msgid,data,this)};BAHA_IM_LAYOUT_LIB.prototype.showFightImgEdit=function(skey,snum){var self=this;var html='<div class="stickeredit_image" id="stickerDiv" style="z-index:1">  <img src="https://im.bahamut.com.tw/sticker%2F'+skey+"%2F"+snum+'.png?alt=media"></div><div class="stickeredit_edit" style="z-index:1">  <div class="scroll-hidden text_input">    <textarea id="stickerText" class="stickeredit text_input" placeholder="輸入戰圖文字">早安，認同請分享</textarea>  </div>  <div class="tool-icon">    <button type="bottom" class="add-name" id="addNick">加入暱稱</button>    <div class="icons">      <a id="addText" class="add-text" href="javascript:;" alt="新增文字"></a>      <a id="deleteText" class="delete-text" href="javascript:;" alt="刪除文字"></a>    </div>  </div>  <div class="tabs">    <div class="tab">      <input type="radio" name="tabs" id="tab1" checked="checked">      <label for="tab1">填色</label>      <div class="tickets-tab-content">        <div class="color-ticket">          <div class="coloring">            <div class="color-item">              <span class="white" style="background: #FFFFFF;"></span>              <span style="background: #747D7E"></span>              <span style="background: #000000"></span>            </div>            <div class="color-item">              <span style="background: #F7C3C7"></span>              <span style="background: #E84341"></span>              <span style="background: #8A1712"></span>            </div>            <div class="color-item">              <span style="background: #FFEDC5"></span>              <span style="background: #F3942E"></span>              <span style="background: #8D4A15"></span>            </div>            <div class="color-item">              <span style="background: #FBF7C7"></span>              <span style="background: #F9EB30"></span>              <span style="background: #8D7F1C"></span>            </div>            <div class="color-item">              <span style="background: #D8EAD0"></span>              <span style="background: #7ABC62"></span>              <span style="background: #247B34"></span>            </div>            <div class="color-item">              <span style="background: #C8E6EE"></span>              <span style="background: #4CBFBF"></span>              <span style="background: #019BAD"></span>            </div>            <div class="color-item">              <span style="background: #C6E0F7"></span>              <span style="background: #4A87C6"></span>              <span style="background: #08468F"></span>            </div>            <div class="color-item">              <span style="background: #E1C3DF"></span>              <span style="background: #844A97"></span>              <span style="background: #5A1A6F"></span>            </div>          </div>        </div>      </div>    </div>    <div class="tab">      <input type="radio" name="tabs" id="tab2">      <label for="tab2">外框</label>      <div class="tickets-tab-content">        <div class="color-ticket">          <div class="outer-frame">            <div class="color-item">              <span class="white" style="background: #FFFFFF;"></span>              <span style="background: #747D7E"></span>              <span style="background: #000000"></span>            </div>            <div class="color-item">              <span style="background: #F7C3C7"></span>              <span style="background: #E84341"></span>              <span style="background: #8A1712"></span>            </div>            <div class="color-item">              <span style="background: #FFEDC5"></span>              <span style="background: #F3942E"></span>              <span style="background: #8D4A15"></span>            </div>            <div class="color-item">              <span style="background: #FBF7C7"></span>              <span style="background: #F9EB30"></span>              <span style="background: #8D7F1C"></span>            </div>            <div class="color-item">              <span style="background: #D8EAD0"></span>              <span style="background: #7ABC62"></span>              <span style="background: #247B34"></span>            </div>            <div class="color-item">              <span style="background: #C8E6EE"></span>              <span style="background: #4CBFBF"></span>              <span style="background: #019BAD"></span>            </div>            <div class="color-item">              <span style="background: #C6E0F7"></span>              <span style="background: #4A87C6"></span>              <span style="background: #08468F"></span>            </div>            <div class="color-item">              <span style="background: #E1C3DF"></span>              <span style="background: #844A97"></span>              <span class="non-color" style="background: #B3B3B3"></span>            </div>          </div>        </div>      </div>    </div>  </div></div>';var dialogify=new Dialogify(html,{size:"dialogify__fixedwidth stickeredit",useDialogForm:false,closable:false}).title("編輯戰圖").buttons([{text:"取消",click:function(e){this.close()}},{text:"發送",type:Dialogify.BUTTON_PRIMARY,click:function(e){var textdata=[];$(".stickeredit_image .edit-text").each(function(index,obj){var deg=$(obj).data("deg")||0;var data={text:$(obj).text().trim(),text_size:parseFloat($(obj).css("font-size"))/parseFloat($(".stickeredit_image").height()),text_position_x:(parseFloat($(obj).css("left"))+8)/parseFloat($(".stickeredit_image").width()),text_position_y:(parseFloat($(obj).css("top"))+8)/parseFloat($(".stickeredit_image").height()),text_color:hexcolor($(obj).css("color")),text_angle:parseInt(deg)};if($(obj).css("-webkit-text-stroke-width")!="0px"){data.text_has_stroke=true;data.text_stroke_color=hexcolor($(obj).css("-webkit-text-stroke-color"))}else{data.text_has_stroke=false}textdata.push(data)});self.im.sendFightSticker(skey,snum,textdata);this.close()}}]).showModal();self.layout.updateSticker();return;$("#addNick").click(function(){$("#stickerText").val($("#stickerText").val()+self.im.nick);$(".stickeredit_image .is-active span").text($("#stickerText").val())});$("#addText").click(function(){$(".stickeredit_image .is-active").removeClass("is-active");var div=$("<div>");var span=$("<span>");span.text($("#stickerText").val());div.append(span);div.append('<div class="rotate-point bottom-r"><img src="https://im.bahamut.com.tw/hahamut%2Fim_zoom.svg?alt=media"></div><div class="rotate-point bottom-l"><img src="https://im.bahamut.com.tw/hahamut%2Fim_rotate.svg?alt=media"></div>');div.addClass("edit-text");div.addClass("is-active");div.attr("style","top: 0; left: 0; font-size: 32px;color: #000000; -webkit-text-stroke: 1px #FFFFFF;");div.click(stickerIsActive);$("#stickerDiv").append(div);div.jqDrag().jqResize(".bottom-r").jqRotate(".bottom-l")});$("#addText").click();$("#deleteText").click(function(){$("#stickerText").val("");$("#stickerDiv .is-active").remove()});$("#stickerText").keyup(function(){var $box=$(".stickeredit_image .is-active");$(".stickeredit_image .is-active span").text($("#stickerText").val())});$(".coloring .color-item span").each(function(index,obj){$(obj).click(function(){$(".coloring .color-item span").removeClass("is-active");$(obj).addClass("is-active");changeColor($(obj).css("background-color"))})});$(".outer-frame .color-item span").each(function(index,obj){$(obj).click(function(){$(".outer-frame .color-item span").removeClass("is-active");$(obj).addClass("is-active");if($(obj).hasClass("non-color")){changeFrameColor("")}else{changeFrameColor($(obj).css("background-color"))}})})};function changeColor(color){$(".stickeredit_image .is-active").css("color",color)}function changeFrameColor(color){if(color==""){$(".stickeredit_image .is-active").css("-webkit-text-stroke","")}else{$(".stickeredit_image .is-active").css("-webkit-text-stroke","1px "+color)}}function hexcolor(str){var parts=str.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);delete parts[0];for(var i=1;i<=3;++i){parts[i]=parseInt(parts[i]).toString(16);if(parts[i].length==1)parts[i]="0"+parts[i]}return"#"+parts.join("").toUpperCase()}function stickerIsActive(e,obj){if($(e.target).hasClass("edit-text")){$(".stickeredit_image .is-active").removeClass("is-active");$(e.target).addClass("is-active")}if($(e.target).is("span")){$(".stickeredit_image .is-active").removeClass("is-active");$(e.target).parent().addClass("is-active")}}function stickhtml(self){var indexhtml="";var html="";var stickered=localStorage.hahamut_stickered||"[]";stickered=JSON.parse(stickered);html+='<div class="sticker-content"><ul class="sticker-list row">';stickered.forEach(function(data){var stickerinfo=self.im.stickerDetail[data.sticker_group];var edita="";if(stickerinfo&&(stickerinfo.deadline>=(new Date).getTime()||stickerinfo.deadline==0)){if(stickerinfo["sticker_can_battle"]==true){edita='<a class="sticker-list__edit" href="javascript:;" onclick="'+self.layout_id+".layout_u.showFightImgEdit('"+data.sticker_group+"', '"+data.sticker_img+"');\"></a>"}html+='<li class="sticker-list__item col-3 col-padding">  <a class="sticker-list__link" href="javascript:'+self.im_id+".sendSticker('"+data.sticker_group+"','"+data.sticker_img+'\');">    <img data-lazy="https://im.bahamut.com.tw/sticker%2F'+data.sticker_group+"%2F"+data.sticker_img+'.png?alt=media">  </a>  '+edita+"</li>"}});html+="</ul></div>";var listarr=[];self.im.stickers.forEach(function(sticker,index){if(sticker.sticker_visible==false){return}listarr.push({key:index,sort:sticker.sticker_order+index/1e5})});listarr.sort(function(a,b){if(a.sort<b.sort){return-1}else{return 1}});for(var index in listarr){var skey=listarr[index].key;var stickerinfo=self.im.stickerDetail[skey];if(!stickerinfo){continue}var battle="";var edita="";if(stickerinfo["sticker_can_battle"]==true){battle="<span>戰</span>"}indexhtml+='<li class="tab-item" onclick="jQuery(\'[name=stickerContent]\').slick(\'slickGoTo\',jQuery(this).data(\'slick-index\') || jQuery(this).parents(\'.slick-slide\').data(\'slick-index\'));">  <a name="slickitem" class="sticker-item" href="javascript:;">    <img src="https://im.bahamut.com.tw/sticker%2F'+skey+"%2Fsticker_"+skey+'.png?alt=media">    '+battle+"  </a></li>";if(stickerinfo.deadline>=(new Date).getTime()||stickerinfo.deadline==0){html+='<div class="sticker-content"><ul class="sticker-list row">';stickerinfo.stickers.forEach(function(stickerImg){if(stickerinfo["sticker_can_battle"]==true){edita='<a class="sticker-list__edit" href="javascript:;" onclick="'+self.layout_id+".layout_u.showFightImgEdit('"+skey+"', '"+stickerImg+"');\"></a>"}html+='<li class="sticker-list__item col-3 col-padding">  <a class="sticker-list__link" href="javascript:'+self.im_id+".sendSticker('"+skey+"','"+stickerImg+'\');">    <img data-lazy="https://im.bahamut.com.tw/sticker%2F'+skey+"%2F"+stickerImg+'.png?alt=media">  </a>  '+edita+"</li>"});var otherInfo="";if(stickerinfo.sticker_link){otherInfo='    <div class="sticker-title__inner">相關連結： <a href="'+stickerinfo.sticker_link.url+'" target="_blank">'+stickerinfo.sticker_link.name+"</a></div>"}html+='  </ul>  <div class="sticker-title">    <div class="sticker-title__inner">貼圖名稱： '+stickerinfo.sticker_group_name+'</div>    <div class="sticker-title__inner">貼圖期限： '+(stickerinfo.deadline==0?"永久":timeConverter(stickerinfo.deadline-1,"sticker"))+'</div>    <div class="sticker-title__inner">貼圖作者： '+(stickerinfo.sticker_author=="官方提供"||stickerinfo.sticker_author=="sysop"?"官方提供":'<a href="https://home.gamer.com.tw/'+stickerinfo.sticker_author+'" target="_blank">'+stickerinfo.sticker_author+"</a>")+"</div>    "+otherInfo+"  </div></div>"}else{html+='<div class="sticker-content">  <div class="sticker-status">    <p>貼圖期限於 '+timeConverter(stickerinfo.deadline-1,"sticker_dealine")+' 過期，已無法使用。</p>    <button type="" class="mes-btn mes-btn-primary" onclick="'+self.im_id+".clearSticker('"+skey+"');\">刪除</button>  </div></div>"}}return'<div class="sticker-wrapper">  <div class="sticker-nav group">    <ul class="tab-nav mes-sticker-slide" id="sticker_index">    <li class="tab-item" onclick="jQuery(\'[name=stickerContent]\').slick(\'slickGoTo\',jQuery(this).data(\'slick-index\') || jQuery(this).parents(\'.slick-slide\').data(\'slick-index\'));">      <a name="slickitem" class="sticker-item is-active" href="javascript:;">        <i class="material-icons">access_time</i>      </a>    </li>    '+indexhtml+'    </ul>    \x3c!--button type="" class="btn-icon" onclick="'+self.layout_id+'.editSticker();"><i class="material-icons">settings</i></button--\x3e  </div>  <div name="stickerContent">    '+html+"  </div></div>"}function timeConverter(timestamp,type){if(timestamp==0){return""}var now=new Date;var a=new Date(timestamp);var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var year=a.getFullYear();var now_year=now.getFullYear();var month=a.getMonth()+1;var now_month=now.getMonth()+1;var date=a.getDate();var now_date=now.getDate();var hour=a.getHours();var min=a.getMinutes();var sec=a.getSeconds();if(month<10){month="0"+month}if(date<10){date="0"+date}if(now_month<10){now_month="0"+now_month}if(now_date<10){now_date="0"+now_date}if(hour<10){hour="0"+hour}if(min<10){min="0"+min}if(sec<10){sec="0"+sec}switch(type){case"note":var time=month+"/"+date+" "+hour+":"+min;break;case"sticker":var time=year+"/"+month+"/"+date;break;case"sticker_dealine":var time=year+"年"+month+"月"+date+"日";break;default:if(now_year==year&&now_month==month&&now_date==date){var time=hour+":"+min}else if(now_year==year){var time=month+"/"+date}else{var time=year+"/"+month+"/"+date}break}return time}function msgHtmlTag(msg){if(msg){return msg.replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll("\n","\n<br>").replaceAll(/https?:\/\/[^\s"']+/,function(x){if(/^https:\/\/.+?\.(?:jpe?g|gif|png)(?:\?alt=media|)$/i.test(x)){return createHtml("a",{href:x,target:"_blank"},"img",createHtml("img",{src:x,"data-img":"true","data-height":"0",style:"max-width:100%;max-height:400px"}))}else{return createHtml("a",{href:x,target:"_blank"},"text",x)}})}else{return""}}function msgHtmlTagNUrl(msg){if(msg){return msg.replaceAll("<","&lt;").replaceAll(">","&gt;")}else{return""}}function avatarUrl(uid,size,self){if(uid){var botreg=new RegExp("^bot@");var fansreg=new RegExp("^fans@");if(botreg.test(uid)){if(uid>User.Login.getUserid().toLowerCase()){var roomid=User.Login.getUserid().toLowerCase()+"_"+uid}else{var roomid=uid+"_"+User.Login.getUserid().toLowerCase()}var key=getKey(self.im.rooms,roomid);if(size=="S"){if(key==false){return"https://im.bahamut.com.tw/bot%2F"+uid+"_s.png?alt=media"}else{return"https://im.bahamut.com.tw/bot%2F"+uid+"_s.png?alt=media"+check_photo_version(self.im.roomData[key].photo_version)}}else{if(key==false){return"https://im.bahamut.com.tw/bot%2F"+uid+".png?alt=media"}else{return"https://im.bahamut.com.tw/bot%2F"+uid+".png?alt=media"+check_photo_version(self.im.roomData[key].photo_version)}}}else if(fansreg.test(uid)&&!fansreg.test(User.Login.getUserid().toLowerCase())){if(uid>User.Login.getUserid().toLowerCase()){var roomid=User.Login.getUserid().toLowerCase()+"_"+uid}else{var roomid=uid+"_"+User.Login.getUserid().toLowerCase()}var key=getKey(self.im.rooms,roomid);return self.im.roomData[key].photo}else{uid=uid.toLowerCase();if(size=="S"){return"https://avatar2.bahamut.com.tw/avataruserpic/"+uid.substr(0,1)+"/"+uid.substr(1,1)+"/"+uid+"/"+uid+"_s.png"}else{return"https://avatar2.bahamut.com.tw/avataruserpic/"+uid.substr(0,1)+"/"+uid.substr(1,1)+"/"+uid+"/"+uid+".png"}}}}function avatarLink(uid){if(uid){var bahareg=new RegExp("^[a-zA-Z]{1}[a-zA-Z0-9]{1,11}$");var botreg=new RegExp("^bot@");var fansreg=new RegExp("^fans@");if(bahareg.test(uid)){return"https://home.gamer.com.tw/"+uid}if(botreg.test(uid)){if(uid=="bot@blackdesertm"){return"https://prj.gamer.com.tw/2018/blackdesertm/"}else{return"javascript:;"}}if(fansreg.test(uid)){return"javascript:;"}}else{return"javascript:;"}}function getKey(arr,room){var key=false;arr.some(function(value,index){if(value==room){key=index;return true}else{return false}});return key}function createHtml(tag,data,innerType,inner){var obj=document.createElement(tag);$.each(data,function(index,value){obj.setAttribute(index,value)});if(typeof inner!="undefined"){if(innerType=="text"){$(obj).text(inner)}else{$(obj).html(inner)}}return obj.outerHTML}function msgContent(msgid,data,self){var room=data.roomId;var key=getKey(self.im.rooms,room);if(self.im_id=="im_forum"){var scoller_id="message-scoller_forum";var time_attr_id="data-forum_time"}else{var scoller_id="message-scoller";var time_attr_id="data-time"}var order_time=parseInt(data.timestamp/1e3);if(self.layout_id!="im_forum_layout"){var tip="<a class=mes-tooltip--link href=javascript:; onclick="+self.layout_id+".sendToOther('"+msgid+"');>轉傳</a>"}else{tip=""}if(self.im.roomInfo[key].type==2&&data.sender_id!=User.Login.getUserid().toLowerCase()){tip+="<a class=mes-tooltip--link href=javascript:; onclick="+self.layout_id+".accuse('"+msgid+"');>檢舉</a>"}else if(self.im.roomInfo[key].type!=2&&self.im.roomInfo[key].type!=4&&data.type==0){tip+="<a class=mes-tooltip--link href=javascript:; onclick="+self.layout_id+".noteAdd('"+msgid+"');>儲存到記事本</a>"}var msghtml="";switch(data.type){case 0:msghtml='<div class="message-log__item group">  <div class="msg-log">'+msgHtmlTag(data.message)+'</div>  <div class="msg-toolbar">    <div class="msg-toolbar__item">      <a href="javascript:;" data-hastip="true" class="btn-icon" data-tippy-content="'+tip+'" title="'+tip+'">        <i class="material-icons">more_horiz</i>      </a>    </div>  </div></div>';break;case 1:var imgsrc="";var imgsrc_thumb="";if(data.thumbnail){imgsrc=data.thumbnail;imgsrc_thumb=data.thumbnail}else{var img_ext="jpg";if(data.image_ext){img_ext=data.image_ext}if(data.image_id){imgsrc_thumb="https://im.bahamut.com.tw/chatimg%2F"+data.image_id+"."+img_ext+"?alt=media&w=300&h=300";imgsrc="https://im.bahamut.com.tw/chatimg%2F"+data.image_id+"."+img_ext+"?alt=media"}else{imgsrc_thumb="https://im.bahamut.com.tw/room%2Fchat_image%2F"+room+"%2F"+msgid+"."+img_ext+"?alt=media&w=300&h=300";imgsrc="https://im.bahamut.com.tw/room%2Fchat_image%2F"+room+"%2F"+msgid+"."+img_ext+"?alt=media"}}msghtml='<div class="message-log__item group">  <div class="msg-log msg-log--photo">'+createHtml("a",{href:imgsrc,target:"_blank"},"img",createHtml("img",{src:imgsrc_thumb,onerror:"this.src='"+imgsrc+"';this.onerror=''","data-img":"true","data-height":"0"}))+'  </div>  <div class="msg-toolbar">    <div class="msg-toolbar__item">      <a href="javascript:;" class="btn-icon" data-hastip="true" data-tippy-content="'+tip+'" title="'+tip+'">        <i class="material-icons">more_horiz</i>      </a>    </div>  </div></div>';break;case 2:msghtml='<div class="message-log__item group">  <div class="msg-log msg-log--sticker">'+createHtml("img",{src:"https://im.bahamut.com.tw/sticker%2F"+data.sticker_group_id+"%2F"+data.sticker_id+".png?alt=media","data-img":"true","data-height":"0"})+"  </div></div>";break;case 4:msghtml='<div class="mes-state-tip" '+time_attr_id+'="'+data.timestamp+'" style="order:'+order_time+'">'+createHtml("div",{class:"mes-state-tip__inline"},"text",sysMsg(data))+"</div>";break;case 7:var events=JSON.parse(data.events);var attsvg='<svg class="ic-sword" width="20px" height="20px" viewBox="0 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>ic_sword</title><path d="M3.41152954,0.00422515905 L3.4157547,-3.82804899e-13 L15.1544945,11.7387398 L15.8932343,11 L17.9234238,13.0301895 L16.6066208,14.3469925 L18.635582,16.3759536 L19.009964,16.0015717 L20.0457458,17.0373535 L17.0326996,20.0503998 L15.9969177,19.0146179 L16.3759536,18.635582 L14.3469925,16.6066208 L13.0301895,17.9234238 L11,15.8932343 L11.7387398,15.1544945 L0.00247497486,3.41822967 L0,3.41822967 L0,-8.8817842e-16 L3.41152954,-8.8817842e-16 L3.41152954,0.00422515905 Z" id="ic_sword"></path></svg>';var defsvg='<svg class="ic-shield" width="20px" height="22px" viewBox="3 0 18 22" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>ic_shield</title><path d="M12,1 L3,5 L3,11 C3,16.55 6.84,21.74 12,23 C17.16,21.74 21,16.55 21,11 L21,5 L12,1 Z" id="ic_shield"></path></svg>';var pk_right,pk_right_icon,pk_right_state;var pk_left,pk_left_icon,pk_left_state;if(events[0].effects[User.Login.getUserid().toLowerCase()]!=undefined){pk_right=User.Login.getUserid().toLowerCase()}else{pk_right=events[0].atter}for(var key in events[0].effects){if(key!=pk_right){pk_left=key;if(events[0].effects[key]=="att"){pk_left_icon=attsvg;pk_right_icon=defsvg}else{pk_left_icon=defsvg;pk_right_icon=attsvg}}}for(var key in events){if(events[key].battle_type==2){pk_right_state=events[key].effects[pk_right];pk_left_state=events[key].effects[pk_left]}}msghtml='<div class="mes-pk-poster-box" id="pk_'+msgid+'" '+time_attr_id+'="'+data.timestamp+'" style="order:'+order_time+'">  <div class="mes-pk-poster">    <div class="mes-pk-poster__item author-avatar" '+(pk_left_state=="win"?'data-pkwin="1"':"")+'>      <div class="pk-award">        <img src="https://im.bahamut.com.tw/hahamut%2Fic_award.png?alt=media">      </div>'+createHtml("img",{src:avatarUrl(pk_left,"B",self)})+'      <div class="pk-states pk-states--l">'+pk_left_icon+'</div>    </div>    <div class="mes-pk-poster__item">VS.</div>    <div class="mes-pk-poster__item author-avatar" '+(pk_right_state=="win"?'data-pkwin="1"':"")+'>      <div class="pk-award">        <img src="https://im.bahamut.com.tw/hahamut%2Fic_award.png?alt=media">      </div>'+createHtml("img",{src:avatarUrl(pk_right,"B",self)})+'      <div class="pk-states pk-states--r">'+pk_right_icon+'</div>    </div>  </div>  <div class="mes-pk-poster-tool">    <button type="button" class="mes-btn" onclick="'+self.layout_id+".startPK("+self.im_id+".msgData['"+msgid+'\'],0)">      <i class="material-icons">play_arrow</i>      觀看過程    </button>    <button type="button" class="mes-btn" onclick="jQuery(\'#pk_'+msgid+" [data-pkwin]').addClass('pk-winner')\">      <i class=\"material-icons\">format_list_bulleted</i>      對戰結果    </button>  </div></div>";break;case 8:msghtml='<div class="message-log__item group">  <div class="msg-log msg-log--sticker">    <canvas id="fightImg_'+msgid+'"></canvas>    <script>'+self.layout_id+".showFightImg('"+msgid+"');<\/script>  </div></div>";break;case 9:msghtml='<div class="message-log__item group">  <div class="msg-log">'+msgHtmlTag("想和"+data.sender_name+"進行互動，請至『巴哈姆特 APP』上進行操作!\nhttps://prj.gamer.com.tw/app2u/bahaapp.html")+'</div>  <div class="msg-toolbar">    <div class="msg-toolbar__item">      <a href="javascript:;" data-hastip="true" class="btn-icon" data-tippy-content="'+tip+'" title="'+tip+'">        <i class="material-icons">more_horiz</i>      </a>    </div>  </div></div>';break}if(msghtml==""){return}if(4==data.type||7==data.type){return msghtml}else{var avatar=avatarUrl(data.sender_id,"S",self);if(data.sender_id==User.Login.getUserid().toLowerCase()){var holderclass="message-holder msg-rtl";if(5==data.type){holderclass+=" msg-pk-rtl"}}else{var holderclass="message-holder";if(5==data.type){holderclass+=" msg-pk"}}var holderhtml='<div class="'+holderclass+'" '+time_attr_id+'="'+data.timestamp+'" id="msgDiv_'+msgid+'" style="order:'+order_time+'">  <div class="user-avatar message-icon">'+createHtml("a",{href:avatarLink(data.sender_id),target:"_blank","data-gamercard-userid":data.sender_id,class:"gamercard"},"div",createHtml("div",{class:"user-avatar__img",style:"background-image: url("+avatar+');"'}))+'  </div>  <div class="message-log">    <div class="message-log__header group">      <h4 class="msg-log-title">'+msgHtmlTagNUrl(data.sender_name||data.sender_id)+' -</h4>      <div class="msg-log-time">'+timeConverter(data.timestamp)+"</div>    </div>"+msghtml+"  </div></div>";return holderhtml}}function sysMsg(data){switch(data.system_message_type){case 0:rmsg=data.system_message_actor+" 加入群組";break;case 1:rmsg=data.system_message_actor+" 退出群組";break;case 2:rmsg=data.system_message_actor+" 建立群組";break;case 3:rmsg=data.system_message_actor+" 更新群組圖片";break;case 4:rmsg=data.system_message_actor+" 更新群組名稱";break;case 5:rmsg=data.system_message_actor+" 邀請了 "+data.system_message_receiver;break;case 6:rmsg=data.system_message_actor+" 把 "+data.system_message_receiver+"踢出群組";break;case 7:rmsg=data.system_message_text;break;case 8:rmsg=data.system_message_actor+" 更新群組相關作品";break;defalut:rmsg="未知的系統訊息"}return rmsg}if(typeof exports=="object"){module.exports=BAHA_IM_LAYOUT_LIB}else if(typeof define=="function"&&define.amd){define(function(){return BAHA_IM_LAYOUT_LIB})}else{window.BAHA_IM_LAYOUT_LIB=BAHA_IM_LAYOUT_LIB}})(window,window.document,jQuery);