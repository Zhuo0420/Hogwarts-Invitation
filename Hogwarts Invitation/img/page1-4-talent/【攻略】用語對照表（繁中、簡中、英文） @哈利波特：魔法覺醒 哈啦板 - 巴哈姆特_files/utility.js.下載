bahaRte.utility.cursor="pointer",bahaRte.utility.setOpacity=function(t,e){t.style.opacity=e},bahaRte.utility.getTagStatus=function(t){if(bahaRte.isPlainText)return 0;var e=bahaRte.selection.getRange();if(!e)return 0;var a,i=0,s=bahaRte.constants.tagState,r=e.startContainer,n=[],l=[],o=[],c=[],u=[],h=[],b=bahaRte.utility.createMap(bahaRte.constants.allowFontName),R=bahaRte.utility.createMap(bahaRte.constants.allowFontSize.fontValue),y=bahaRte.utility.createMap(bahaRte.constants.allowFontSize.size),g=bahaRte.utility.createMap(bahaRte.constants.allowFontSize.fontValue,bahaRte.constants.allowFontSize.size),f=bahaRte.utility.createMap(bahaRte.constants.allowFontSize.keyword,bahaRte.constants.allowFontSize.size),p=bahaRte.utility.createMap(bahaRte.constants.allowFontSize.size,bahaRte.constants.allowFontSize.label);if(t||bahaRte.utility.resetTagStatus(),r.tagName){var S=r.childNodes[e.startOffset];if(S)switch(S.nodeName.trim().toLowerCase()){case"hr":i|=s.HORIZONTALRULE,bahaRte.utility.setButtonStyle("inserthorizontalrule");break;case"img":var d=S.getAttribute("src");0===d.trim().toLowerCase().indexOf("images/")&&(d=location.href.substring(0,location.href.lastIndexOf("/")+1)+d);var E=new RegExp(bahaRte.constants.emotionUrl+"([1-9][0-9]?).gif");i|=s.IMAGE,d.match(E)?i|=s.EMOTION:d==bahaRte.constants.movieImgUrl?(i|=s.MOVIE,bahaRte.utility.setButtonStyle("movie")):bahaRte.utility.setButtonStyle("insertimage")}}var m=bahaRte.utility.getAllContainer(r),k=jQuery('[data-id="fe_header"] span');for(var L in m){switch(a=m[L].nodeName.trim().toLowerCase()){case"b":case"big":case"strong":i|=s.BOLD,bahaRte.utility.setButtonStyle("bold");break;case"i":case"em":case"dfn":case"var":case"cite":i|=s.ITALIC,bahaRte.utility.setButtonStyle("italic");break;case"u":case"ins":i|=s.UNDERLINE,bahaRte.utility.setButtonStyle("underline");break;case"s":case"strike":case"del":i|=s.STRIKE,bahaRte.utility.setButtonStyle("strikethrough");break;case"a":var O=m[L].getAttribute("href");null!==O&&(i|=s.LINK,O.match(bahaRte.constants.serviceUrl.wikiUrlPattern)||O.match(bahaRte.constants.serviceUrl.guildWikiUrlPattern)?(bahaRte.utility.setButtonStyle("wiki"),i|=s.WIKI):O.match(bahaRte.constants.serviceUrl.acgPattern)?(bahaRte.utility.setButtonStyle("acg"),i|=s.ACG):bahaRte.utility.setButtonStyle("createlink"));break;case"h2":i|=s.HEADING1,k.text("大標");break;case"h3":i|=s.HEADING2,k.text("中標");break;case"h4":i|=s.HEADING3,k.text("小標");break;case"center":i|=s.CENTER,u.push(a);break;case"table":i|=s.TABLE;break;case"ol":i|=s.ORDEREDLIST,h.push(a);break;case"ul":i|=s.UNORDEREDLIST,h.push(a)}if(m[L].attributes)for(var v=0;v<m[L].attributes.length;v++){var N=m[L].attributes[v].value;switch(m[L].attributes[v].name.trim().toLowerCase()){case"style":for(var w=N.split(";"),A=0;A<w.length;A++)if(""!==w[A].trim()){var I=w[A].split(":"),T=I[0].trim().toLowerCase(),C=I[1].trim(),F=C.split(/\s+/);switch(T){case"text-align":"left"==C?(i|=s.LEFT,u.push(C)):"center"==C?(i|=s.CENTER,u.push(C)):"right"==C&&(i|=s.RIGHT,u.push(C));break;case"font-family":b[C]&&(i|=s.FONTNAME,n.push(C));break;case"font-size":y[C]?(i|=s.FONTSIZE,l.push(C)):f[C]&&(i|=s.FONTSIZE,l.push(f[C]));break;case"font-weight":C.equals("bold")&&(i|=s.BOLD,bahaRte.utility.setButtonStyle("bold"));break;case"font-style":C.trim().toLowerCase().inArray(["italic","oblique"])&&(i|=s.ITALIC,bahaRte.utility.setButtonStyle("italic"));break;case"color":C=bahaRte.utility.switchColor(C),C.match(/^(?:[a-zA-Z]{3,20}|#[0-9A-Fa-f]{6})$/)&&(i|=s.FORECOLOR,o.push(C));break;case"background-color":C=bahaRte.utility.switchColor(C),C.match(/^(?:[a-zA-Z]{3,20}|#[0-9A-Fa-f]{6})$/)&&(i|=s.BACKGROUNDCOLOR,c.push(C));break;case"text-decoration":var z=bahaRte.utility.createMap(F);z["line-through"]&&(i|=s.STRIKE,bahaRte.utility.setButtonStyle("strikethrough")),z.underline&&(i|=s.UNDERLINE,bahaRte.utility.setButtonStyle("underline"))}}break;case"align":"table"==a||("left"==N?(i|=s.LEFT,u.push(N)):"center"==N?(i|=s.CENTER,u.push(N)):"right"==N&&(i|=s.RIGHT,u.push(N)));break;case"face":"font"==a&&b[N]&&(i|=s.FONTNAME,n.push(N));break;case"size":"font"==a&&R[parseInt(N,10)]&&(i|=s.FONTSIZE,l.push(g[N]));break;case"color":"font"==a&&N.match(/^(?:[a-zA-Z]{3,20}|#[0-9A-Fa-f]{6})$/)&&(i|=s.FORECOLOR,o.push(N));break;case"bgcolor":a.inArray(["table","tr","th","td"])&&N.match(/^(?:[a-zA-Z]{3,20}|#[0-9A-Fa-f]{6})$/)&&(i|=s.BACKGROUNDCOLOR,c.push(N))}}}u.length>0&&bahaRte.utility.setButtonStyle("justify"+u[0]),h.length>0&&bahaRte.utility.setButtonStyle("ol"==h[0]?"insertorderedlist":"insertunorderedlist"),n.length>0&&jQuery('[data-id="fe_font"] span').text(n[0]),l.length>0&&jQuery('[data-id="fe_fontsize"] span').text(p[l[0]]),i>0&&m.push(S);var B={state:i,fontList:n,sizeList:l,colorList:o,bgcolorList:c,alignList:u,listList:h};return B},bahaRte.utility.insertHtml=function(t){if($.browser.ie11){var e,a;if(e=bahaRte.win.getSelection(),e&&e.getRangeAt&&e.rangeCount){a=e.getRangeAt(0),a.deleteContents();var i=a.createContextualFragment(t);a.insertNode(i),a.collapse(!1)}}else bahaRte.doc.execCommand("inserthtml",!1,t)},bahaRte.utility.insertTextTag=function(t,e){bahaRte.source.focus();var a=bahaRte.selection.getSelectedText();e&&""===a&&(a="請輸入內容"),t=t.replace(/\{text\}/,a);var i=bahaRte.source.selectionStart,s=bahaRte.source.value.substring(0,i),r=bahaRte.source.value.substring(bahaRte.source.selectionEnd);bahaRte.source.value=s+t+r,bahaRte.source.selectionStart=i,bahaRte.source.selectionEnd=i+t.length},bahaRte.utility.keepSelection=function(t){t.preventDefault()};