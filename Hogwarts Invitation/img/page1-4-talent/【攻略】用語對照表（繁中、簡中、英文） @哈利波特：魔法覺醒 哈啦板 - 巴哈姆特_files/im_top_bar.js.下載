(function(window,document,$,undefined){String.prototype.replaceAll=function(search,replacement){var target=this;return target.replace(new RegExp(search,"g"),replacement)};String.prototype.giveMeColor=function(){const color=["#e57373","#f06292","#ba68c8","#9575cd","#7986cb","#64b5f6","#4fc3f7","#4dd0e1","#4db6ac","#81c784","#aed581","#ff8a65","#d4e157","#ffd54f","#ffb74d","#a1887f","#90a4ae"];var hash=0,i,chr;if(this.length===0)return hash;for(i=0;i<this.length;i++){chr=this.charCodeAt(i);hash=(hash<<5)-hash+chr;hash|=0}return color[Math.abs(hash)%color.length]};function timeConverter(timestamp){if(timestamp==0){return""}var now=new Date;var a=new Date(timestamp);var year=a.getFullYear();var now_year=now.getFullYear();var month=a.getMonth()+1;var now_month=now.getMonth()+1;var date=a.getDate();var now_date=now.getDate();var hour=a.getHours();var min=a.getMinutes();if(month<10){month="0"+month}if(date<10){date="0"+date}if(now_month<10){now_month="0"+now_month}if(now_date<10){now_date="0"+now_date}if(hour<10){hour="0"+hour}if(min<10){min="0"+min}if(now_year==year&&now_month==month&&now_date==date){var time=hour+":"+min}else if(now_year==year){var time=month+"/"+date}else{var time=year+"/"+month+"/"+date}return time}function showNoRead(data){var num=data.noreadnum;if(data.type==2){if(num>0){return"New"}else{return""}}else{if(num>999){return"999+"}else if(num>0){return num}else{return""}}}function showNotify(){if($("#topBarMsg_hahamut").is(":hidden")){let $hahaTopBarATag=$("a#topBar_hahamut");$hahaTopBarATag.html(`<span>N</span><span class="text-tooltip">${$hahaTopBarATag.data("tooltiptext")}</span>`).addClass("topbnow4");$("span#topBar_hahamut").html("N").show()}}function hideNotify(){let $hahaTopBarATag=$("a#topBar_hahamut");$hahaTopBarATag.html(`<span class="text-tooltip">${$hahaTopBarATag.data("tooltiptext")}</span>`).removeClass("topbnow4");$("span#topBar_hahamut").html("").hide()}function avatarUrl(uid,size){var userid=User.Login.getUserid().toLowerCase();if(uid){var botreg=new RegExp("^bot@");var fansreg=new RegExp("^fans@");if(botreg.test(uid)){if(uid>userid){var roomid=userid+"_"+uid}else{var roomid=uid+"_"+userid}if(size=="S"){return"https://im.bahamut.com.tw/bot%2F"+uid+"_s.png?alt=media"+check_photo_version(_chatlist[roomid].photo_version)}else{return"https://im.bahamut.com.tw/bot%2F"+uid+".png?alt=media"+check_photo_version(_chatlist[roomid].photo_version)}}else if(fansreg.test(uid)&&!fansreg.test(userid)){if(uid>userid){var roomid=userid+"_"+uid}else{var roomid=uid+"_"+userid}return _chatlist[roomid].photo}else{uid=uid.toLowerCase();if(size=="S"){return"https://avatar2.bahamut.com.tw/avataruserpic/"+uid.substr(0,1)+"/"+uid.substr(1,1)+"/"+uid+"/"+uid+"_s.png"}else{return"https://avatar2.bahamut.com.tw/avataruserpic/"+uid.substr(0,1)+"/"+uid.substr(1,1)+"/"+uid+"/"+uid+".png"}}}}function check_photo_version(version){if(typeof version!="undefined"){return"&v="+version}else{return""}}function getJwtData(token){var base64Url=token.split(".")[1];var base64=base64Url.replaceAll("-","+").replaceAll("_","/");return JSON.parse(decodeURIComponent(escape(window.atob(base64))))}var _chatlist=null,_showFriendNotify=false,_noimg=[],_listRows=50;var imtop={init:function(){if(!User.Login.isLogin()){return}$("a#topBar_hahamut").show();var channel=new MessageChannel;var workerFrame=document.createElement("iframe");workerFrame.src="https://api.gamer.com.tw/worker/im.html?v=2022111501";workerFrame.onload=function(){this.contentWindow.postMessage({action:"BahamutImInit",userid:Cookies.get("BAHAID")||""},"https://api.gamer.com.tw",[channel.port2])};channel.port1.onmessage=function(e){if(e.data.action==="ping"){let data=e.data.data;data.isActive=!document.hidden;channel.port1.postMessage({action:"pong",data:data})}if(typeof imtop[e.data.action]==="function"){imtop[e.data.action](e.data.data)}};workerFrame.style.display="none";document.body.appendChild(workerFrame);this.workerChannel=channel;document.addEventListener("visibilitychange",function(){channel.port1.postMessage({action:document.hidden||$("a#topBar_hahamut").hasClass("topbnow4")?"sleep":"wake"})})},attached:function(data){if(data.redpoint){console.log("has redpoint, not connect");showNotify()}else{this.delayConnectTimeoutId=setTimeout(this.connect,1e4)}},connect:async function(){if(!User.Login.isLogin()){return}var token=Cookies.get("hahatoken_topbar")||"";if(token){var tokenData=getJwtData(token);if(tokenData.uid!==User.Login.getUserid().toLowerCase()){token=""}}if(token==""){console.log("fetching login token");var data=await $.ajax({url:"https://api.gamer.com.tw/mobile_app/im/v1/login_token.php",xhrFields:{withCredentials:true},dataType:"json"});Cookies.set("hahatoken_topbar",data.token,{expires:1/24,path:"/",domain:".gamer.com.tw"});token=data.token}console.log("asking worker to connect");ImTop.workerChannel.port1.postMessage({action:"connect",data:{token:token,userid:User.Login.getUserid()}});if(this.delayConnectTimeoutId){this.delayConnectTimeoutId=null}},connected:function(data){if(data.redpoint){showNotify()}else{hideNotify()}_showFriendNotify=data.friendNotify;_chatlist=data.chatlist;if(!$("#topBarMsg_hahamut").is(":hidden")){imtop.showlist()}},showlist:function(){var topDiv=$("#topBarHahamut");var oldScrollTop=topDiv.scrollTop();topDiv.html("");var userid=User.Login.getUserid();if(_chatlist==null){if(this.delayConnectTimeoutId){clearTimeout(this.delayConnectTimeoutId)}this.connect();return}if(_showFriendNotify==true){$("#im_friend_apply").addClass("is-notify-fd")}let i=0;Object.keys(_chatlist).sort(function(a,b){let anum=0;let bnum=0;if(typeof _chatlist[a].latest_message!="undefined"){anum=parseInt(_chatlist[a].latest_message.timestamp/1e3)}if(typeof _chatlist[b].latest_message!="undefined"){bnum=parseInt(_chatlist[b].latest_message.timestamp/1e3)}return bnum-anum}).forEach(function(key){if(_listRows==i){console.log(_listRows,i);var html_div=$('<div class="empty-item"><p>看所有聊天室，請開啟完整版。</p></div>');html_div.css("order",2e9);topDiv.append(html_div);i++}if(_listRows!=0&&i>=_listRows){return}var roomData=_chatlist[key];var photo='<div class="im_bhtop-user-avatar"><img class="lazyload" data-src="https://im.bahamut.com.tw/noimg%2Fic_head_160.png?alt=media"></div>';if(roomData.has_chat!=true){return}switch(roomData.type){case 1:if(!_noimg.some(function(src){return src=="https://im.bahamut.com.tw/room%2F"+key+".jpg?alt=media"})){photo='<div class="im_bhtop-user-avatar im_bhtop-group-avatar"><img class="lazyload" data-src="https://im.bahamut.com.tw/room%2F'+key+'.jpg?alt=media" onerror="ImTop.noimg(this);"></div>'}break;case 2:photo='<div class="im_bhtop-user-avatar" style="background-color:'+roomData.name.giveMeColor()+'">'+roomData.name.substring(0,1)+"</div>";break;case 3:case 4:if(!_noimg.some(function(src){return src==avatarUrl(key.replace(userid+"_","").replace("_"+userid,""),"S")})){photo='<div class="im_bhtop-user-avatar"><img class="lazyload" data-src="'+avatarUrl(key.replace(userid+"_","").replace("_"+userid,""),"S")+'" onerror="ImTop.noimg(this);"></div>'}break;case 5:if(!_noimg.some(function(src){return src==roomData.photo})){photo='<div class="im_bhtop-user-avatar im_bhtop-group-avatar"><img class="lazyload" data-src="'+roomData.photo+'" onerror="ImTop.noimg(this);"></div>'}break}var msg="";var time="";var ordertime=2e9;if(typeof roomData.latest_message!="undefined"){msg=roomData.latest_message.show_text;time=timeConverter(roomData.latest_message.timestamp);ordertime=2e9-parseInt(roomData.latest_message.timestamp/1e3);if(time!=""){time+='<i class="fa fa-clock-o"></i>'}}var html_div="";var html_a=$('<a data-gtm-notification="im-'+roomData.type+'" href="javascript:;"></a>');html_a.click(function(){ImTop.open(this,key)});html_a.append(photo);html_div=$('<div class="im_bhtop-msg-item">');html_div.append($('<p class="im_bhtop-user-name"></p>').text(roomData.name));if(typeof roomData.is_mute!="undefined"&&roomData.is_mute==true){html_div.append($('<img class="im-volume-off" src="https://im.bahamut.com.tw/hahamut%2Fvolume_off.svg?alt=media">'))}html_a.append(html_div);html_div=$('<div class="im_bhtop-msg-item">');html_div.append($('<p class="im_bhtop-message-summary"></p>').text(msg));if(typeof roomData.noreadnum!="undefined"&&roomData.noreadnum!=0){html_div.append($('<div class="im_bhtop-message-notice"></div>').text(showNoRead(roomData)))}html_a.append(html_div);html_a.append('<span class="time">'+time+"</span>");var html_div=$("<div></div>");html_div.append(html_a);html_div.css("order",ordertime);topDiv.append(html_div);topDiv.scrollTop(oldScrollTop);i++})},open:function(obj,room){$(obj).find(".im_bhtop-message-notice").remove();window.open("https://haha.gamer.com.tw/index2.php?room="+encodeURIComponent(room),room,"width=420, height=750")},close:function(){ImTop.workerChannel.port1.postMessage({action:"clearRedpoint",data:null})},hasjoin:function(room){if(_chatlist[room]!=null){return true}else{return false}},noimg:function(obj){if(!_noimg.some(function(src){return src==$(obj).attr("src")})){_noimg.push($(obj).attr("src"))}$(obj).attr("src","https://im.bahamut.com.tw/noimg%2Fic_head_160.png?alt=media").parent().removeClass("im_bhtop-group-avatar")},syncChatlist:function(chatlist){console.log("getting chatlist");_chatlist=chatlist;if(!$("#topBarMsg_hahamut").is(":hidden")){imtop.showlist()}},redpoint:function(redpoint){if(redpoint){showNotify()}else{hideNotify()}},setRows:function(rows){_listRows=parseInt(rows)}};window.ImTop=imtop;$(function(){ImTop.init()})})(window,window.document,jQuery);