(function($,window){function ForumSearch(){var searchTerm,bsn;var getUrlParameter=function(name){return decodeURIComponent((new RegExp("[?|&]"+name+"="+"([^&;]+?)(&|#|;|$)").exec(location.search)||[null,""])[1].replace(/\+/g,"%20"))||null};var arrayToString=function(ary){return Object.keys(ary).map(function(x){return ary[x]}).join(" ")};var getSearchTitleUrl=function(bsn,title){return"/search.php?bsn="+bsn+"&q="+encodeURIComponent(title)};const COOKIE_NAME_SEARCH_TYPE="ckFORUM_searchType";this.initializeUI=function(){this.bsn=Number(getUrlParameter("bsn"));this.searchTerm={};this.searchTerm.bsn="more:pagemap:thread-bsn:"+this.bsn;this.searchTerm.filename="more:pagemap:thread-filename:C";this.searchBoxRender();this.resetGoogleStyle();this.saveRecentSearch();this.keywordsRender();google.search.cse.element.getElement("forumSearch").prefillQuery(getUrlParameter("q"));var queryType=getUrlParameter("qt");var queryValue=getUrlParameter("q");if(queryType&&queryValue||useOldSearch||Cookies.get(COOKIE_NAME_SEARCH_TYPE)=="baha"){$("#searchbox").hide();$("#searchbox_mobile").hide();$("#old_search_searchbox").show();$("#old_search_searchbox_mobile").show();var placeholder;if(window.location.pathname=="/Bo.php"){if(queryType==6){placeholder="找作者"}else if(queryType==7){placeholder="找M文"}else{placeholder="找標題"}$("#old_search_input").attr("placeholder","找作者")}else{placeholder="找標題";$("#old_search_input").attr("placeholder","搜尋此哈啦板")}$("#old_search_input_mobile").attr("placeholder",placeholder)}};this.searchBoxRender=function(){var url="https://forum.gamer.com.tw/search.php?bsn="+this.bsn;if(window.location.pathname=="/Bo.php"){url="Bo.php?bsn="+this.bsn+"&qt=6"}google.search.cse.element.render({div:"searchbox",attributes:{autoCompleteMaxCompletions:5,autoCompleteMatchType:"any",resultsUrl:url,queryParameterName:"q",gaCategoryParameter:this.bsn,gaQueryParameter:"q",enableHistory:true},tag:"searchbox-only",gname:"forumSearch"})};this.searchResultsRender=function(enableOrderBy){google.search.cse.element.render({div:"searchresults",attributes:{webSearchQueryAddition:arrayToString(this.searchTerm),linkTarget:"_blank",queryParameterName:"q",gaCategoryParameter:this.bsn,gaQueryParameter:"q",filters:1,enableOrderBy:enableOrderBy},tag:"searchresults-only",gname:"forumSearch"})};this.searchResultsReload=function(enableOrderBy,query){$("#searchresults").empty();this.searchResultsRender(enableOrderBy);if(query){google.search.cse.element.getElement("forumSearch").execute(query)}};this.resetGoogleStyle=function(){var removeCss=$('link[href$="default.css"],link[href$="default+zh_TW.css"]');removeCss.filter('[href*="www.google.com"]').remove();var searchBar=$(".gcse-bar");var searchInput=$("#gsc-i-id1");var searchOptionBtn=$(".gcse-option-control");var searchTab=$(".gcse-tab-child");searchBar.on("mouseenter",function(){$(".gcse-option, .gsc-input-box").addClass("is-hover")}).on("mouseleave",function(){if(!$(".gcse-dropdown").hasClass("is-active")){$(".gcse-option, .gsc-input-box").removeClass("is-hover");searchOptionBtn.removeClass("is-active")}});$("#old_search_input").on("focus",function(){$(".gcse-suggest").addClass("is-active")}).on("blur",function(){if($(".gcse-dropdown:hover").length==0){$(".gcse-dropdown").removeClass("is-active")}$(".gsc-input-box").removeClass("is-focus is-hover")});$("#old_search_input_mobile").on("focus",function(){$(".gcse-suggest").addClass("is-active")}).on("blur",function(){if($(".gcse-dropdown:hover").length==0){$(".gcse-dropdown").removeClass("is-active")}$(".gsc-input-box").removeClass("is-focus is-hover")});searchInput.on("focus",function(){$(".gcse-suggest").addClass("is-active")}).on("blur",function(){if($(".gcse-dropdown:hover").length===0){$(".gcse-dropdown").removeClass("is-active")}$(".gsc-input-box").removeClass("is-focus is-hover")}).on("mouseenter",function(){if($(this).is(":focus")&&!$(".gcse-suggest").hasClass("is-active")){$(".gcse-suggest").addClass("is-active")}}).attr("placeholder","搜尋此哈啦板");$("input.gsc-input").on("focus",function(){$(".gsc-input-box, .gcse-option").addClass("is-focus")}).on("blur",function(){$(".gsc-input-box").removeClass("is-focus")});searchOptionBtn.on("click",function(){if($(this).hasClass("is-active")){$(this).blur()}else{$(".gcse-sort").addClass("is-active");$(this).addClass("is-active").focus();$(".gcse-suggest").removeClass("is-active")}}).on("blur",function(){searchOptionBtn.removeClass("is-active");if($(".gcse-dropdown:hover").length===0){$(".gcse-dropdown").removeClass("is-active")}});$(".gcse-sort > ul > li").on("click",function(){$(".gcse-sort").removeClass("is-active");var sel=$(".gcse-dropdown > ul > li").index($(this));if(sel>4){sel=sel-4}if(sel==3){Cookies.set(COOKIE_NAME_SEARCH_TYPE,"google",{expires:365});$("#old_search_searchbox").hide();$("#old_search_searchbox_mobile").hide();$("#gsc-i-id1").val($("#old_search_input").val());$("#searchbox").show();$("#searchbox_mobile").show();$("#gsc-i-id1").focus()}else{Cookies.set(COOKIE_NAME_SEARCH_TYPE,"baha",{expires:365});$("#searchbox").hide();$("#old_search_input").val($("#gsc-i-id1").val());$("#old_search_searchbox").show();$("#old_search_input").attr("placeholder",$(this).find(".gcse-sort-title").text()).focus();$("#searchbox_mobile").hide();$("#old_search_input_mobile").val($("#gsc-i-id1").val());$("#old_search_searchbox_mobile").show();$("#old_search_input_mobile").attr("placeholder",$(this).find(".gcse-sort-title").text()).focus();switch(sel){case 1:$("#stype").val(2);$("#stype_mobile").val(2);break;case 2:$("#stype").val(4);$("#stype_mobile").val(4);break;default:$("#stype").val(1);$("#stype_mobile").val(1);break}}});var clearButton=$(".gcse-clear");var self=this;clearButton.click(function(){location.href="/B.php?bsn="+self.bsn});if(getUrlParameter("qt")&&getUrlParameter("q")){clearButton.show()}else{clearButton.hide()}$("#gsc-i-id1").keyup(function(e){if($(this).val().length>0){$(".gcse-option-control, .gcse-suggest").removeClass("is-active")}else{$(".gcse-suggest").addClass("is-active")}});$("#old_search_form").submit(function(){if($("#old_search_input").val().length<1){Dialogify.alert("請輸入搜尋內容");return false}if(ga){ga("send",{hitType:"event",eventCategory:"互動",eventAction:"哈啦區",eventLabel:"桌面搜尋",useBeacon:true})}});$("#old_search_form_mobile").submit(function(){if($("#old_search_input_mobile").val().length<1){Dialogify.alert("請輸入搜尋內容");return false}if(ga){ga("send",{hitType:"event",eventCategory:"互動",eventAction:"哈啦區",eventLabel:"桌面搜尋",useBeacon:true})}});var areaFunc=this;searchTab.on("click",function(){searchTab.removeClass("is-active");$(this).addClass("is-active");areaFunc.changeArea($(this).attr("id"))})};this.saveRecentSearch=function(){var q=getUrlParameter("q");if(q&&typeof Storage!=="undefined"){var item=JSON.parse(localStorage.getItem("forumSearch"));item=item?item:{};item[this.bsn]=item[this.bsn]?item[this.bsn]:[];item[this.bsn].unshift(q);item[this.bsn]=item[this.bsn].filter(function(value,pos,self){return self.indexOf(value)==pos});item[this.bsn]=item[this.bsn].slice(0,15);localStorage.setItem("forumSearch",JSON.stringify(item))}};this.keywordsRender=function(){var recentlyKeywords=[];if(typeof Storage!=="undefined"){var item=JSON.parse(localStorage.getItem("forumSearch"));if(item!=null&&item[this.bsn]!=null&&Array.isArray(item[this.bsn])){recentlyKeywords=item[this.bsn].map(function(elem){var replacement={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return elem.replace(/[&<>"']/g,function(match){return replacement[match]})})}}if(!hotKeywords.length&&!recentlyKeywords.length){$(".search-suggest, .gcse-suggest").hide()}else{setKeywordsData("最近搜尋",recentlyKeywords,"search-suggest-tag search-suggest-tag_recent",$(".right-child"),this.bsn,true,'data-gtm-click="點擊最近搜尋" data-gtm-service="forum" data-gtm-page="搜尋結果頁"');setKeywordsData("最近搜尋",recentlyKeywords,"gcse-suggest-tag",$("#gcse-suggest-child-recently_mobile"),this.bsn);setKeywordsData("最近搜尋",recentlyKeywords,"gcse-suggest-tag",$("#gcse-suggest-child-recently"),this.bsn,true);setKeywordsData("熱門搜尋",hotKeywords,"search-suggest-tag",$(".right-child"),this.bsn,false,'data-gtm-click="點擊熱門搜尋" data-gtm-service="forum" data-gtm-page="搜尋結果頁"');setKeywordsData("熱門搜尋",hotKeywords,"gcse-suggest-tag",$("#gcse-suggest-child-hot"),this.bsn);setKeywordsData("熱門搜尋",hotKeywords,"gcse-suggest-tag",$("#gcse-suggest-child-hot_mobile"),this.bsn);$("a[data-search-dynamic]").bind("click",function(){var url;if($(this).parent().hasClass("gcse-suggest-tag")){if($("#searchbox").is(":visible")){url="search.php?bsn="+$(this).data("bsn")+"&q="+$(this).text()}else if($("#stype").val()==2){url="search.php?bsn="+$('input[name="bsn"]').val()+"&author="+$(this).text()}else if($("#stype").val()==4){url="search.php?bsn="+$('input[name="bsn"]').val()+"&type=m&q="+$(this).text()}else{url=getSearchTitleUrl($(this).data("bsn"),$(this).text())}}else{if(window.location.pathname=="/search.php"){url="search.php?bsn="+$(this).data("bsn")+"&q="+$(this).text()}else if($("#stype").val()==2){url="search.php?bsn="+$('input[name="bsn"]').val()+"&author="+$(this).text()}else if($("#stype").val()==4){url="search.php?bsn="+$('input[name="bsn"]').val()+"&type=m&q="+$(this).text()}else{url=getSearchTitleUrl($(this).data("bsn"),$(this).text())}}if(window.location.pathname=="/Bo.php"&&/^[a-zA-Z][a-zA-Z0-9]{1,11}$/.test($(this).text().trim())){url="Bo.php?bsn="+$('input[name="bsn"]').val()+"&qt=6&q="+encodeURIComponent($(this).text().trim())}$(this).attr("href",url)})}function setKeywordsData(title,data,className,parentDiv,bsn,clearBtn=false,gtm=""){if(data.length){var div=$("<div>").addClass(className);for(var key in data){div.append('<a data-bsn="'+bsn+'" '+gtm+" data-search-dynamic>"+data[key]+"</a>")}let titleDiv="<h3>"+title;if(clearBtn){titleDiv+='<a href="javascript:forumSearch.removeKeyword('+bsn+');" class="clean"><i class="fa fa-trash"></i></a>'+"</h3>"}else{titleDiv+="</h3>"}parentDiv.append(titleDiv);parentDiv.append(div)}}};this.removeKeyword=function(bsn){if(typeof Storage!=="undefined"){var item=JSON.parse(localStorage.getItem("forumSearch"));delete item[bsn];localStorage.setItem("forumSearch",JSON.stringify(item));$("#gcse-suggest-child-recently").empty();$(".search-suggest-tag_recent").prev().remove();$(".search-suggest-tag_recent").empty()}};this.changeCondition=function(){this.searchTerm.bsn="more:pagemap:thread-bsn:"+this.bsn;this.searchTerm.filename="more:pagemap:thread-filename:C";this.searchTerm.subbsn=$("#filter-subbsn").val()?"more:pagemap:thread-subbsn:"+$("#filter-subbsn").val():"";this.searchTerm.type="";if($("#filter-article").is(":checked")){this.searchTerm.type="more:pagemap:thread-extract:T"}if($("#filter-author").is(":checked")){this.searchTerm.type="more:pagemap:thread-author:"+$("#gsc-i-id1").val();this.searchTerm.filename="more:pagemap:thread-filename:Co"}this.searchResultsReload(true)};this.changeArea=function(area){var q=getUrlParameter("q");this.searchTerm={};switch(area){case"area_board":$(".gcse-forum").hide();this.searchTerm.filename="more:pagemap:thread-filename:A";if(q){this.searchResultsReload(false,q)}break;case"area_others":$(".gcse-forum").hide();if(q){this.searchResultsReload(false,q+" "+$(".BH-menuE li:nth-child(2)").text()+" -site:forum.gamer.com.tw")}break;case"area_extract":$(".gcse-forum").hide();this.searchTerm.bsn="more:pagemap:thread-bsn:"+this.bsn;this.searchTerm.filename="more:pagemap:thread-filename:G2";if(q){this.searchResultsReload(true,q)}break;default:$(".gcse-forum").show();this.searchTerm.bsn="more:pagemap:thread-bsn:"+this.bsn;this.searchTerm.filename="more:pagemap:thread-filename:C";if(q){this.searchResultsReload(true,q)}break}};this.submit=function(){var q=$("#old_search_input").val();if(jQuery("#old_search_input_mobile").is(":visible")){q=$("#old_search_input_mobile").val()}if(window.location.pathname=="/Bo.php"){window.location.href="Bo.php?bsn="+this.bsn+"&qt=6&q="+encodeURIComponent(q);return false}switch($("#stype").val()){case"2":window.location.href="search.php?bsn="+this.bsn+"&author="+encodeURIComponent(q);break;case"4":window.location.href="search.php?bsn="+this.bsn+"&type=m&q="+encodeURIComponent(q);break;default:window.location.href=getSearchTitleUrl(this.bsn,q)}return false}}window.forumSearch=new ForumSearch})(jQuery,window);window.__gcse={parsetags:"explicit",callback:function(){if(document.readyState=="complete"){forumSearch.initializeUI()}else{google.setOnLoadCallback(function(){forumSearch.initializeUI()},true)}}};