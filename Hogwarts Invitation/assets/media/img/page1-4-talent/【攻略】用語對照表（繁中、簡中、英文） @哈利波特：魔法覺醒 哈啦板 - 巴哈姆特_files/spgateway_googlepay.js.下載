(function($,window){var googlePayClient;var service,servicesn,price="",isReady;const baseRequest={apiVersion:2,apiVersionMinor:0};const allowedCardNetworks=["MASTERCARD","VISA","JCB"];const allowedCardAuthMethods=["PAN_ONLY","CRYPTOGRAM_3DS"];const tokenizationSpecification={type:"PAYMENT_GATEWAY",parameters:{gateway:"stpath",gatewayMerchantId:"MS374463833"}};const baseCardPaymentMethod={type:"CARD",parameters:{allowedAuthMethods:allowedCardAuthMethods,allowedCardNetworks:allowedCardNetworks}};const googlePayBaseConfiguration={apiVersion:2,apiVersionMinor:0,allowedPaymentMethods:[baseCardPaymentMethod]};const cardPaymentMethod=Object.assign({},baseCardPaymentMethod,{tokenizationSpecification:tokenizationSpecification});var googlePay={googlePayInit:function(){googlePayClient=new google.payments.api.PaymentsClient({environment:"PRODUCTION"});googlePay.onGooglePayLoaded()},onGooglePayLoaded:function(){googlePayClient.isReadyToPay(googlePayBaseConfiguration).then(function(response){if(response.result){$(".google-btn").show();$(".google-block").show();$(".google-notice").hide();isReady=1}else{console.log("請確認您的裝置，是否支援Google Pay");$(".google-btn").hide();$(".google-block").hide();$(".google-notice").show();isReady=0}}).catch(function(err){console.log(err)})},switchProcess:function(type,s,service_sn,total_price){if(isReady==undefined){setTimeout(function(){googlePay.switchProcess(type,s,service_sn,total_price)},500)}service=s;servicesn=service_sn;price=total_price;if(type==1){if(isReady==1){googlePay.addGooglePayButton()}}else{googlePay.onGooglePaymentButtonClicked()}},addGooglePayButton:function(){const button=googlePayClient.createButton({onClick:googlePay.onGooglePaymentButtonClicked,buttonType:"buy",buttonSizeMode:"fill"});document.getElementById("payway-btn").appendChild(button)},onGooglePaymentButtonClicked:function(){const paymentDataRequest=googlePay.getGooglePaymentDataRequest();paymentDataRequest.transactionInfo=googlePay.getGoogleTransactionInfo();googlePayClient.loadPaymentData(paymentDataRequest).then(function(paymentData){googlePay.processPayment(paymentData)}).catch(function(err){console.log(err)})},processPayment:function(paymentData){$.ajax({url:"https://user.gamer.com.tw/cash/cash_spgateway_confirm.php",method:"POST",crossDomain:true,xhrFields:{withCredentials:true},data:{sn:servicesn,service:service,payway:"27",token:paymentData.paymentMethodData.tokenizationData.token},dataType:"json",beforeSend:function(){new Dialogify("付款中，請勿重新整理頁面",{closable:false}).title("訊息").showModal()}}).done(function(e){Dialogify.closeAll();if(e.data){location.href="https://buy.gamer.com.tw/checkout_order_done.php?vgshop=1"}else{Dialogify.alert(e.error.message,{close:function(){location.href="https://buy.gamer.com.tw/vHistory.php?filter=1"}})}})},getGooglePaymentDataRequest:function(){const paymentDataRequest=Object.assign({},baseRequest);paymentDataRequest.allowedPaymentMethods=[cardPaymentMethod];paymentDataRequest.transactionInfo=googlePay.getGoogleTransactionInfo();paymentDataRequest.merchantInfo={merchantId:"BCR2DN6T6PQ7ZTI5",merchantName:"巴哈商城"};return paymentDataRequest},getGoogleTransactionInfo:function(){return{currencyCode:"TWD",totalPriceStatus:"FINAL",totalPrice:price.toString()}},prefetchGooglePaymentData:function(){const paymentDataRequest=googlePay.getGooglePaymentDataRequest();paymentDataRequest.transactionInfo={totalPriceStatus:"NOT_CURRENTLY_KNOWN",currencyCode:"TWD"};googlePayClient.prefetchPaymentData(paymentDataRequest)}};window.googlePay=googlePay})(jQuery,window);