(($,window,Dialogify,undefined)=>{"use strict";const TENOR_SEARCH_API="https://tenor.googleapis.com/v2/search";const TENOR_FEATURED_API="https://tenor.googleapis.com/v2/featured";const TENOR_REGISTER_SHARE_API="https://tenor.googleapis.com/v2/registershare";const TENOR_PARAMS=new URLSearchParams;TENOR_PARAMS.append("key","AIzaSyB4GrCsVrw33qnHDqiG8EZaKkKQku7mPas");TENOR_PARAMS.append("locale","zh_TW");TENOR_PARAMS.append("country","TW");TENOR_PARAMS.append("contentfilter","off");TENOR_PARAMS.append("media_filter","tinygif,gif");const GIF_COLUMN_WIDTH=155;const GIF_COLUMN_COUNT=2;const GIF_TINY_WIDTH=220;const GIF_DISPLAY_WIDTH=147;const DEFAULT_LAST_TAB_KEY="STICKER_last_tab";const STICKER_HISTORY_KEY="hahamut_stickered";class Sticker{static INSERT_TYPE_BAHARTE=1;static INSERT_TYPE_HTML=2;static INSERT_TYPE_URL=3;static INSERT_TYPE_CODE=4;#options;#$tippyElement;#editorInfoCallable;#gifSearchRequestAbortController=null;#gifSearchColumnHeights=[];#gifFeaturedColumnHeights=[];#gifSearchTimer=null;#gifLastSearchValue="";constructor(tippyTarget,editorInfoCallable,options){this.#editorInfoCallable=editorInfoCallable;this.#options=options||{};this.#$tippyElement=$(TIPPY_HTML);for(let i=0;i<GIF_COLUMN_COUNT;i++){this.#gifSearchColumnHeights[i]=[i,0];this.#gifFeaturedColumnHeights[i]=[i,0]}this.#detectTheme();this.#bindEvents();this.#createTippy(tippyTarget)}showEmoticonTab($tab){this.#showTab($tab)}async showGifTab($tab){this.#showTab($tab);if($tab.find(".post__gif__item").length==0){try{const json=await this.#fetchTenorFeatured();this.#setFeaturedGifTabContent(json)}catch(reason){Dialogify.alert(reason)}}}async showStickerTab($tab){this.#showTab($tab);if($tab.find(".sticker-list__item").length==0){try{const json=await this.#fetchSticker();this.#setStickerTabContent(json)}catch(reason){Dialogify.alert(reason)}}}#bindEvents(){this.#$tippyElement.find(".tab-menu a").on("click",e=>{let $listItem=$(e.target).parent("li");if($listItem.hasClass("active")){return}let index=$listItem.index();this.#$tippyElement.find(".tab-content").eq(index).triggerHandler("shown")});this.#$tippyElement.find(".tab-content").on("shown",e=>{let $tab=$(e.target);let index=$tab.index();switch(index){case 1:this.showEmoticonTab($tab);break;case 2:this.showGifTab($tab);break;case 3:this.showStickerTab($tab);break;default:}this.#setLastTabIndex(index)});this.#$tippyElement.find(".gif-wall").on("scroll",async e=>{let $gifWall=$(e.target);let $elem=$gifWall.find($gifWall.find(".trending-gif").is(":visible")?".trending-gif":".search-gif");let currentDistance=$elem.height()-250-$gifWall.scrollTop();if(currentDistance<=500){let next=$elem.data("next");if(!$elem.data("loading")){$elem.data("loading","1");if($elem.hasClass("trending-gif")){const json=await this.#fetchTenorFeatured(next);this.#setFeaturedGifTabContent(json,next)}else{let query=$elem.data("query");const json=await this.#searchTenor(query,next);this.#setSearchGifTabContent(json,query,next)}}}else{$elem.removeData("loading")}});this.#$tippyElement.find(".gif-search-input").on("input",e=>{if(this.#gifSearchTimer!==null){clearTimeout(this.#gifSearchTimer)}let $searchInput=$(e.target);let $tab=$searchInput.parents(".tab-content_gif");let searchValue=$searchInput.val().trim();if(!$searchInput.val()){$searchInput.prev(".clearall").removeClass("is-active")}else{$searchInput.prev(".clearall").addClass("is-active");$tab.find(".trending-gif, .search-gif").hide();$tab.find(".searching-gif").show()}if(searchValue.length>=1&&searchValue!==this.#gifLastSearchValue){this.#gifSearchTimer=setTimeout(async()=>{const json=await this.#searchTenor(searchValue);this.#setSearchGifTabContent(json,searchValue);this.#gifLastSearchValue=searchValue},1e3)}else if(searchValue==""){this.#gifLastSearchValue="";$tab.find(".searching-gif, .search-gif").hide();$tab.find(".trending-gif").show()}else{$tab.find(".trending-gif, .searching-gif").hide();$tab.find(".search-gif").show()}});this.#$tippyElement.find(".tab-content_gif .clearall").on("click",function(){$(this).removeClass("is-active").next("input").val("").triggerHandler("input")});this.#$tippyElement.find(".tab-content_sticker").on("click",".sticker-index .tab-item",function(){let $stickerTabItem=$(this);let slickIndex=$stickerTabItem.data("slick-index")||$stickerTabItem.parents(".slick-slide").data("slick-index");$stickerTabItem.parents(".sticker-wrapper").find(".sticker-list-content").slick("slickGoTo",slickIndex)});this.#$tippyElement.find(".emotion-list").on("click","img",e=>{this.#insertEmoticon(e);this.#getTippyInstance().hide()});this.#$tippyElement.find(".gif-wall").on("click","img",e=>{this.#insertGif(e);this.#getTippyInstance().hide()});this.#$tippyElement.find(".tab-content_sticker").on("click",".sticker-list__link img",e=>{this.#insertSticker(e);this.#getTippyInstance().hide()})}#createTippy(tippyTarget){tippy.delegate(this.#options.delegateTargets||window.document.body,{target:tippyTarget,allowHTML:true,content:this.#$tippyElement.get(0),interactive:true,trigger:"click",theme:this.#options.theme,maxWidth:"466px",appendTo:window.document.body,onHidden:instance=>{instance.destroy()},onShow:instance=>{if(window.User&&window.User.Login&&!window.User.Login.requireLoginIframe()){return false}let lastTab;let lastTabIndex=this.#options.showTab||this.#getLastTabIndex();switch(lastTabIndex){case 2:lastTab=".tab-content_gif";break;case 3:lastTab=".tab-content_sticker";break;case 1:default:lastTab=".tab-content_emoji"}const $popper=$(instance.popper);$popper.find(lastTab).triggerHandler("shown")}})}#showTab($tab){$tab.show().siblings(".tab-content").hide();let $tabs=$tab.parent().children(".tab-content");$tab.siblings(".tab-menu").children("li").removeClass("active").eq($tabs.index($tab)).addClass("active")}#insertEmoticon(event){const editorInfo=this.#editorInfoCallable(this.#getTippyInstance().reference);let eid=event.target.dataset.eid;let emoticonUrl=`https://i2.bahamut.com.tw/editor/emotion/${eid}.gif`;switch(editorInfo.insertType){case Sticker.INSERT_TYPE_BAHARTE:$(bahaRte.isPlainText?bahaRte.source:bahaRte.win).focus();bahaRte.toolbar.insertEmotion(event);break;case Sticker.INSERT_TYPE_HTML:let html=`<img src="${emoticonUrl}">`;this.#insertHtml(editorInfo.editor,html);break;case Sticker.INSERT_TYPE_URL:this.#insertText(editorInfo.editor,emoticonUrl);break;case Sticker.INSERT_TYPE_CODE:let code=`[e${eid}]`;this.#insertText(editorInfo.editor,code);break;default:throw new Error("unknown insert type")}}#insertGif(event){const editorInfo=this.#editorInfoCallable(this.#getTippyInstance().reference);let gifId=event.target.dataset.id;let gifUrl=event.target.dataset.url;switch(editorInfo.insertType){case Sticker.INSERT_TYPE_BAHARTE:$(bahaRte.isPlainText?bahaRte.source:bahaRte.win).focus();bahaRte.toolbar.insertImage(event,gifUrl);break;case Sticker.INSERT_TYPE_HTML:let html=`<img src="${gifUrl}">`;this.#insertHtml(editorInfo.editor,html);break;case Sticker.INSERT_TYPE_URL:this.#insertText(editorInfo.editor,gifUrl);break;case Sticker.INSERT_TYPE_CODE:let code=`[img=${gifUrl}]`;this.#insertText(editorInfo.editor,code);break;default:throw new Error("unknown insert type")}if(this.#$tippyElement.find(".search-gif:visible").length){const searchValue=this.#$tippyElement.find(".gif-search-input").val().trim();const params=new URLSearchParams(TENOR_PARAMS);params.delete("contentfilter");params.delete("media_filter");params.append("id",gifId);params.append("q",searchValue);fetch(TENOR_REGISTER_SHARE_API+"?"+params.toString())}}#insertSticker(event){const editorInfo=this.#editorInfoCallable(this.#getTippyInstance().reference);let stickerGroup=event.target.dataset.stickerGroup;let stickerImage=event.target.dataset.stickerImage;let stickerUrl=`https://im.bahamut.com.tw/sticker/${stickerGroup}/${stickerImage}.png`;switch(editorInfo.insertType){case Sticker.INSERT_TYPE_BAHARTE:$(bahaRte.isPlainText?bahaRte.source:bahaRte.win).focus();bahaRte.toolbar.insertImage(event,stickerUrl);break;case Sticker.INSERT_TYPE_HTML:let html=`<img src="${stickerUrl}">`;this.#insertHtml(editorInfo.editor,html);break;case Sticker.INSERT_TYPE_URL:this.#insertText(editorInfo.editor,stickerUrl);break;case Sticker.INSERT_TYPE_CODE:let code=`[s${stickerGroup}_${stickerImage}]`;this.#insertText(editorInfo.editor,code);break;default:throw new Error("unknown insert type")}this.#prependStickerHistory(stickerGroup,stickerImage)}#insertText(editor,text){text+=" ";let startPos=editor.selectionStart;let start=editor.value.substring(0,startPos);let end=editor.value.substring(editor.selectionEnd);editor.value=start+text+end;editor.focus();editor.selectionStart=startPos+text.length;editor.selectionEnd=startPos+text.length}#insertHtml(editor,html){editor.execCommand("inserthtml",false,html)}async#fetchTenorFeatured(pos){if(pos===""){return Promise.reject(new Error)}let params=new URLSearchParams(TENOR_PARAMS);if(pos){params.append("pos",pos)}const resp=await fetch(TENOR_FEATURED_API+"?"+params.toString());return resp.json()}#setFeaturedGifTabContent(json,pos){if(pos==undefined){for(let i=0;i<GIF_COLUMN_COUNT;i++){this.#gifFeaturedColumnHeights[i]=[i,0]}}this.#$tippyElement.find(".trending-gif").data("next",json.next);for(let index=0;index<json.results.length;index++){let element=json.results[index];let height=element.media_formats.tinygif.dims[1]*GIF_DISPLAY_WIDTH/GIF_TINY_WIDTH+8;let left=this.#gifFeaturedColumnHeights[0][0]*GIF_COLUMN_WIDTH;let top=this.#gifFeaturedColumnHeights[0][1];this.#$tippyElement.find(".trending-gif > div").append(`<div class="post__gif__item" style="height: ${height}px; left: ${left}px; top: ${top}px;">
                        <div><img data-url="${element.media_formats.gif.url}" data-id="${element.id}" data-src="${element.media_formats.tinygif.url}" class="lazyload"></div>
                    </div>`);this.#gifFeaturedColumnHeights[0][1]+=this.#$tippyElement.find(".trending-gif > div > .post__gif__item").last().outerHeight(true);this.#gifFeaturedColumnHeights.sort(this.#sortByHeight);this.#$tippyElement.find(".trending-gif > .masonry").height(this.#gifFeaturedColumnHeights[GIF_COLUMN_COUNT-1][1]+"px")}}#setSearchGifTabContent(json,query,pos){if(query!=this.#$tippyElement.find(".search-gif").data("query")||pos==""){this.#$tippyElement.find(".search-gif > .row").empty();this.#gifSearchColumnHeights=[];for(let i=0;i<GIF_COLUMN_COUNT;i++){this.#gifSearchColumnHeights[i]=[i,0]}}this.#$tippyElement.find(".searching-gif").hide();this.#$tippyElement.find(".search-gif").data({query:query,next:json.next}).show();if(json.results.length===0){this.#$tippyElement.find(".search-gif > div").append(`<div class="post__nogif__item">
                        <img src="https://i2.bahamut.com.tw/forum/empty_gif.png">
                    </div>`);this.#$tippyElement.find(".search-gif > .masonry").css("height","initial")}else{for(let index=0;index<json.results.length;index++){let element=json.results[index];let height=element.media_formats.tinygif.dims[1]*GIF_DISPLAY_WIDTH/GIF_TINY_WIDTH+8;let left=this.#gifSearchColumnHeights[0][0]*GIF_COLUMN_WIDTH;let top=this.#gifSearchColumnHeights[0][1];this.#$tippyElement.find(".search-gif > div").append(`<div class="post__gif__item" style="height: ${height}px; left: ${left}px; top: ${top}px;">
                            <div><img data-url="${element.media_formats.gif.url}" data-id="${element.id}" data-src="${element.media_formats.tinygif.url}" class="lazyload"></div>
                        </div>`);this.#gifSearchColumnHeights[0][1]+=this.#$tippyElement.find(".search-gif > div > .post__gif__item").last().outerHeight(true);this.#gifSearchColumnHeights.sort(this.#sortByHeight);this.#$tippyElement.find(".search-gif > .masonry").height(this.#gifSearchColumnHeights[GIF_COLUMN_COUNT-1][1]+"px")}}}#setStickerTabContent(json){let stickerData=[];let stickerDetailData=[];Object.entries(json.data.list).forEach(([key,value])=>{stickerData[key]={sticker_order:value.order,sticker_start_time:value.start_time,sticker_visible:value.visible,ctime:0};stickerDetailData[key]=value.detail;if(value.detail.sticker_period==0){stickerDetailData[key].deadline=0}else{stickerDetailData[key].deadline=value.detail.sticker_period+value.start_time}});this.#$tippyElement.find(".tab-content_sticker").html(this.#stickerHtml(stickerData,stickerDetailData));this.#$tippyElement.find(".sticker-list-content").slick({lazyLoad:"ondemand",arrows:false,draggable:false,infinite:false,fade:true}).on("beforeChange",(event,slick,currentSlide,nextSlide)=>{this.#$tippyElement.find(".sticker-item").removeClass("is-active").eq(nextSlide).addClass("is-active")}).on("lazyLoaded",(event,slick,image,imageSource)=>{tippy(image[0],{allowHTML:true,content:`<img src="${imageSource}" width="180">`,theme:this.#options.theme})});let shows=6;if(this.#$tippyElement.find(".sticker-index li").length<6){shows=this.#$tippyElement.find(".sticker-index li").length}this.#$tippyElement.find(".sticker-index").slick({infinite:false,slidesToShow:shows,slidesToScroll:shows,asNavFor:".sticker-list-content"});this.#getTippyInstance().popperInstance.update()}async#searchTenor(query,pos){if(this.#gifSearchRequestAbortController!==null){this.#gifSearchRequestAbortController.abort()}if(pos===""){return Promise.reject(new Error)}let params=new URLSearchParams(TENOR_PARAMS);params.append("q",query);if(pos!==undefined){params.append("pos",pos)}this.#gifSearchRequestAbortController=new AbortController;const resp=await fetch(TENOR_SEARCH_API+"?"+params.toString(),{signal:this.#gifSearchRequestAbortController.signal});return resp.json()}#getTippyInstance(){return this.#$tippyElement.parents("[data-tippy-root]").get(0)._tippy}#getLastTabIndex(){let lastTabKey=this.#options.lastTabLocalStorageKey||DEFAULT_LAST_TAB_KEY;return+window.localStorage.getItem(lastTabKey)}#setLastTabIndex(index){let lastTabKey=this.#options.lastTabLocalStorageKey||DEFAULT_LAST_TAB_KEY;window.localStorage.setItem(lastTabKey,String(index))}#sortByHeight(a,b){return a[1]-b[1]||a[0]-b[0]}async#fetchSticker(){const resp=await fetch("https://api.gamer.com.tw/mobile_app/im/v1/my_sticker.php",{credentials:"include"});const json=await resp.json();if(json.error){return Promise.reject(new Error(json.error.message))}return Promise.resolve(json)}#prependStickerHistory(stickerGroup,stickerImage){let stickerHistory=JSON.parse(window.localStorage.getItem(STICKER_HISTORY_KEY)||"[]");stickerHistory.forEach(function(data,index){if(data.sticker_group==stickerGroup&&data.sticker_img==stickerImage){stickerHistory.splice(index,1)}});if(stickerHistory.length>=16){stickerHistory.pop()}stickerHistory.unshift({sticker_group:stickerGroup,sticker_img:stickerImage});let historyHtml="";stickerHistory.forEach(data=>{historyHtml+=this.#stickerListItemHtml(data.sticker_group,data.sticker_img)});this.#$tippyElement.find('.slick-slide[data-slick-index="0"] .sticker-list.row').html(historyHtml);this.#$tippyElement.find(".sticker-list-content").slick("refresh");window.localStorage.setItem(STICKER_HISTORY_KEY,JSON.stringify(stickerHistory))}#detectTheme(){switch(this.#options.theme){case"light":case"dark":break;default:if($('html[data-theme="dark"]').length){this.#options.theme="dark"}else{this.#options.theme="light"}}}#stickerHtml(stickerData,stickerDetailData){let indexhtml="";let html="";let stickerHistory=JSON.parse(window.localStorage.getItem(STICKER_HISTORY_KEY)||"[]");html+='<div class="sticker-content"><ul class="sticker-list row">';stickerHistory.forEach(data=>{let stickerinfo=stickerDetailData[data.sticker_group];if(stickerinfo&&(stickerinfo.deadline>=(new Date).getTime()||stickerinfo.deadline==0)){html+=this.#stickerListItemHtml(data.sticker_group,data.sticker_img)}});html+="</ul></div>";let stickerList=[];stickerData.forEach(function(sticker,index){if(sticker.sticker_visible==false){return}stickerList.push({key:index,sort:sticker.sticker_order+index/1e5})});stickerList.sort(function(a,b){if(a.sort<b.sort){return-1}else{return 1}});for(let index in stickerList){let skey=stickerList[index].key;let stickerinfo=stickerDetailData[skey];if(!stickerinfo){continue}let deadlineDate=new Date(stickerinfo.deadline-1);deadlineDate=`${deadlineDate.getFullYear()}/${deadlineDate.getMonth()+1}/${deadlineDate.getDate()}`;indexhtml+=`
<li class="tab-item">
    <a class="sticker-item" href="javascript:;">
        <img src="https://im.bahamut.com.tw/sticker/${skey}/sticker_${skey}.png">
    </a>
</li>`;if(stickerinfo.deadline>=(new Date).getTime()||stickerinfo.deadline==0){html+='<div class="sticker-content"><ul class="sticker-list row">';stickerinfo.stickers.forEach(stickerImage=>{html+=this.#stickerListItemHtml(skey,stickerImage)});let otherInfo="";if(stickerinfo.sticker_link){otherInfo=`<div class="sticker-title__inner">相關連結： <a href="${stickerinfo.sticker_link.url}" target="_blank">${stickerinfo.sticker_link.name}</a></div>`}let stickerDeadline=stickerinfo.deadline==0?"永久":deadlineDate;let stickerAuthor=stickerinfo.sticker_author=="官方提供"||stickerinfo.sticker_author=="sysop"?"官方提供":`<a href="https://home.gamer.com.tw/${stickerinfo.sticker_author}" target="_blank">${stickerinfo.sticker_author}</a>`;html+=`
    </ul>
    <div class="sticker-title">
        <div class="sticker-title__inner">貼圖名稱： ${stickerinfo.sticker_group_name}</div>
        <div class="sticker-title__inner">貼圖期限： ${stickerDeadline}</div>
        <div class="sticker-title__inner">貼圖作者： ${stickerAuthor}</div>
        ${otherInfo}
    </div>
</div>`}else{html+=`
<div class="sticker-content">
    <div class="sticker-status">
        <p>貼圖期限於 ${deadlineDate} 過期，已無法使用。</p>
    </div>
</div>`}}return`
<div class="sticker-wrapper">
    <div class="sticker-nav group">
        <ul class="tab-nav mes-sticker-slide sticker-index">
            <li class="tab-item">
                <a class="sticker-item is-active" href="javascript:;">
                    <i class="material-icons">access_time</i>
                </a>
            </li>
            ${indexhtml}
        </ul>
    </div>
    <div class="sticker-list-content">
        ${html}
    </div>
</div>`}#stickerListItemHtml(stickerGroup,stickerImage){return`
<li class="sticker-list__item col-3 col-padding">
    <a class="sticker-list__link" href="javascript:;">
        <img data-sticker-group="${stickerGroup}" data-sticker-image="${stickerImage}" data-lazy="https://im.bahamut.com.tw/sticker/${stickerGroup}/${stickerImage}.png">
    </a>
</li>`}}let TIPPY_HTML=`
<div class="baha_gif tab-wrapper">
    <ul class="tab-menu tab-menu__3 text-center">
        <li class="tab-menu__item1"><a href="javascript:;">表情符號</a></li>
        <li class="tab-menu__item2"><a href="javascript:;">GIF</a></li>
        <li class="tab-menu__item3"><a href="javascript:;">貼圖</a></li>
        <hr>
    </ul>
    <div class="tab-content tab-content_emoji" style="display:none;">
        <div class="emotion-list">`;for(let i=1;i<=43;i++){TIPPY_HTML+=`<img data-src="https://i2.bahamut.com.tw/editor/emotion/${i}.gif" class="lazyload" data-eid="${i}">`;if(i==11||i==23||i==33){TIPPY_HTML+=`<br>`}}TIPPY_HTML+=`
        </div>
    </div>
    <div class="tab-content tab-content_gif" style="display:none;">
        <label class="gif-search-box">
            <form class="gif-frm">
                <a href="javascript:;" class="gif-search-icon"><i class="fa fa-search"></i></a>
                <a href="javascript:;" class="clearall"><i class="fa fa-times-circle"></i></a>
                <input type="text" class="gif-search-input" name="q" placeholder="搜尋網路上的 GIF..." autocomplete="off">
            </form>
        </label>
        <div class="gif-wall">
            <div class="trending-gif">
                <h5>🔥熱門動圖</h5>
                <div class="row masonry js-controlled"></div>
            </div>
            <div class="search-gif" style="display:none;">
                <div class="row masonry js-controlled"></div>
            </div>
            <div class="searching-gif" style="display:none;">
                <div class="row">
                    <img class="lazyload" data-src="https://i2.bahamut.com.tw/addgif_pic.png">
                </div>
            </div>
        </div>
        <div class="add-gif_footer text-center">Powered By Tenor</div>
    </div>
    <div class="tab-content tab-content_sticker" style="display:none;">
    </div>
</div>`;window.Bahamut=window.Bahamut||{};window.Bahamut.Sticker=Sticker})(jQuery,window,Dialogify);